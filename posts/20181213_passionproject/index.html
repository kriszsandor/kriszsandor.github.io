<!DOCTYPE html> 
<html lang="">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Dynamic cell-capacity allocation for telecoms &middot;  Krisztian Sandor&#39;s data science blog" />
  
  <meta property="og:site_name" content="Krisztian Sandor&#39;s data science blog" />
  <meta property="og:url" content="https://kriszsandor.github.io/posts/20181213_passionproject/" />
  
  
    <meta property="og:type" content="article" />
    
    <meta property="og:article:published_time" content="2018-12-07T11:49:26-05:00" />
    
      <meta property="og:article:tag" content="telecom" />
    
      <meta property="og:article:tag" content="cnn" />
    
      <meta property="og:article:tag" content="keras" />
    
      <meta property="og:article:tag" content="wavenet" />
    
      <meta property="og:article:tag" content="time series" />
    
      <meta property="og:article:tag" content="cell" />
    
      <meta property="og:article:tag" content="tableau" />
    
  

  <title>
     Dynamic cell-capacity allocation for telecoms &middot;  Krisztian Sandor&#39;s data science blog
  </title>

  <link rel="alternative stylesheet" href="https://kriszsandor.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/main.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/github.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/color-theme.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="https://kriszsandor.github.io/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://kriszsandor.github.io/images/apple-touch-icon.png" />

  <link rel="stylesheet" href="https://kriszsandor.github.io/css/custom.css" />

  

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-130640046-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-130640046-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  <script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script>

  
</head>
<body>
  <script>
    addBackToTop({
    backgroundColor: '#fff',
    innerHTML: 'Back to Top',
    textColor: '#333'
    })
  </script>
  
  <header class="global-header"  style="background-image:url(https://kriszsandor.github.io/images/background.png)">
  
    <section class="header-text">
      <h1><a href="https://kriszsandor.github.io/">Krisztian Sandor&#39;s data science blog</a></h1>
      
        <h3 class="tag-line">
          Using data science to solve business problems
        </h3>
      
      
        <a class="btn btn-default btn-home" href="https://kriszsandor.github.io/">
          <i class="fa fa-angle-left" aria-hidden="true"></i>
          &nbsp;Home
        </a>
      
      
      <div class="navbar-container">
        
          <a class="btn btn-default navbar-item" href="https://kriszsandor.github.io/pages/about">
            About
          </a>
        
      </div>
      
      
      
      
      
      
      
      
      
      
      
    </section>
  </header>
  <main class="container">



<article>
  <header class="article-title">
    <h1 class="text-primary">Dynamic cell-capacity allocation for telecoms</h1>
  </header>
  <div class="delimiter"></div>
  <section>
    

<p>This project has served as my &lsquo;passion-project&rsquo; in Metis Data Science Bootcamp in December, 2018 in New York.</p>

<p><img src="/Post_images/20181213_PassionProject/Slide_images/Slide02.jpeg" alt="jpeg" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Plotting libraries</span>
<span style="color:#00f">import</span> <span style="color:#000">geojson</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.colors</span> <span style="color:#00f">as</span> <span style="color:#000">colors</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.cm</span> <span style="color:#00f">as</span> <span style="color:#000">cmx</span>
<span style="color:#00f">import</span> <span style="color:#000">seaborn</span> <span style="color:#00f">as</span> <span style="color:#000">sns</span>
%<span style="color:#000">matplotlib</span> <span style="color:#000">inline</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.pyplot</span> <span style="color:#00f">as</span> <span style="color:#000">plt</span>
<span style="color:#00f">from</span> <span style="color:#000">descartes</span> <span style="color:#00f">import</span> <span style="color:#000">PolygonPatch</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.animation</span> <span style="color:#00f">as</span> <span style="color:#000">animation</span>

<span style="color:#888;font-style:italic"># Standard libraries</span>
<span style="color:#00f">import</span> <span style="color:#000">pandas</span> <span style="color:#00f">as</span> <span style="color:#000">pd</span>
<span style="color:#00f">import</span> <span style="color:#000">numpy</span> <span style="color:#00f">as</span> <span style="color:#000">np</span>

<span style="color:#888;font-style:italic"># Misc libraries</span>
<span style="color:#00f">import</span> <span style="color:#000">json</span>
<span style="color:#00f">import</span> <span style="color:#000">io</span>
<span style="color:#00f">import</span> <span style="color:#000">requests</span>

%<span style="color:#000">matplotlib</span> <span style="color:#000">inline</span></code></pre></div>
<h3 id="1-loading-and-previewing-the-data">1. Loading and Previewing the Data</h3>

<p>Importing daily data from the Milando grid traffic, and aggregating into a single dataframe</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">import</span> <span style="color:#000">glob</span>
<span style="color:#00f">import</span> <span style="color:#000">datetime</span>
<span style="color:#000">convert</span> = <span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">datetime</span>.<span style="color:#000">datetime</span>.<span style="color:#000">fromtimestamp</span>(<span style="color:#000">float</span>(<span style="color:#000">x</span>) / <span style="color:#3af">1e3</span>)

<span style="color:#000">df_cdrs</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>({})
<span style="color:#000">colnames</span> = [<span style="color:#5a2">&#39;CellID&#39;</span>, <span style="color:#5a2">&#39;datetime&#39;</span>, <span style="color:#5a2">&#39;countrycode&#39;</span>,<span style="color:#5a2">&#39;smsin&#39;</span>,<span style="color:#5a2">&#39;smsout&#39;</span>, <span style="color:#5a2">&#39;callin&#39;</span>,<span style="color:#5a2">&#39;callout&#39;</span>, <span style="color:#5a2">&#39;internet&#39;</span>]
<span style="color:#00f">for</span> <span style="color:#000">filepath</span> <span style="color:#00f">in</span> <span style="color:#000">glob</span>.<span style="color:#000">iglob</span>(<span style="color:#5a2">&#39;../01_Data/*.txt&#39;</span>):
    <span style="color:#000">df</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_csv</span>(<span style="color:#000">filepath</span>, <span style="color:#000">sep</span>=<span style="color:#5a2">&#39;</span><span style="color:#5a2">\t</span><span style="color:#5a2">&#39;</span>, <span style="color:#000">names</span>=<span style="color:#000">colnames</span>,<span style="color:#000">parse_dates</span>=[<span style="color:#5a2">&#39;datetime&#39;</span>], <span style="color:#000">date_parser</span>=<span style="color:#000">convert</span>)
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">append</span>(<span style="color:#000">df</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Finished {filepath}&#39;</span>)
<span style="color:#888;font-style:italic">#df_cdrs.to_pickle(&#39;raw_merged.pkl&#39;)</span></code></pre></div>
<pre><code>Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-25.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-19.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-18.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-30.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-24.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-26.txt
Finished ../01_Data/01_November_Data/sms-call-internet-mi-2013-11-27.txt
</code></pre>

<p>Aggregating milano grid traffic to a max of (sum of hourly) traffic for each day. Assuming that a single call/internet connection can last on avarage for a max of hour - and the cell tower has to be able to serve the highest traffic of the highest hour</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span>=<span style="color:#000">df_cdrs</span>.<span style="color:#000">fillna</span>(<span style="color:#3af">0</span>)
<span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;sms&#39;</span>] = <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;smsin&#39;</span>] + <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;smsout&#39;</span>]
<span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;calls&#39;</span>] = <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;callin&#39;</span>] + <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;callout&#39;</span>]
<span style="color:#000">df_cdrs</span> = (<span style="color:#000">df_cdrs</span>[[<span style="color:#5a2">&#39;datetime&#39;</span>, <span style="color:#5a2">&#39;CellID&#39;</span>, <span style="color:#5a2">&#39;internet&#39;</span>, <span style="color:#5a2">&#39;calls&#39;</span>, <span style="color:#5a2">&#39;sms&#39;</span>]].<span style="color:#000">set_index</span>(<span style="color:#5a2">&#39;datetime&#39;</span>)
             .<span style="color:#000">groupby</span>([<span style="color:#000">pd</span>.<span style="color:#000">Grouper</span>(<span style="color:#000">freq</span>=<span style="color:#5a2">&#39;H&#39;</span>),<span style="color:#5a2">&#39;CellID&#39;</span>]).<span style="color:#000">sum</span>().<span style="color:#000">reset_index</span>().<span style="color:#000">set_index</span>(<span style="color:#5a2">&#39;datetime&#39;</span>)
             .<span style="color:#000">groupby</span>([<span style="color:#000">pd</span>.<span style="color:#000">Grouper</span>(<span style="color:#000">freq</span>=<span style="color:#5a2">&#39;D&#39;</span>),<span style="color:#5a2">&#39;CellID&#39;</span>]).<span style="color:#000">max</span>()
            )
<span style="color:#000">df_cdrs</span>.<span style="color:#000">index</span>.<span style="color:#000">names</span> = [<span style="color:#5a2">&#39;day&#39;</span>, <span style="color:#5a2">&#39;CellID&#39;</span>]
<span style="color:#000">df_cdrs</span>.<span style="color:#000">reset_index</span>(<span style="color:#000">inplace</span>=<span style="color:#000">True</span>)
<span style="color:#888;font-style:italic">#df_cdrs.to_pickle(&#39;group_merged.pkl&#39;)</span>
<span style="color:#888;font-style:italic">#for day_df in df_cdrs.groupby([&#39;day&#39;]):</span>
    <span style="color:#888;font-style:italic">#break</span></code></pre></div>
<p>Running the above on AWS, importing locally and cleaning</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">import_source_data</span>(<span style="color:#000">filepath</span>):
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_csv</span>(<span style="color:#000">filepath</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;Unnamed: 0&#39;</span>]
    
    <span style="color:#00f">return</span> <span style="color:#000">df_cdrs</span></code></pre></div>
<p><img src="/Post_images/20181213_PassionProject/Slide_images/Slide03.jpeg" alt="jpeg" /></p>

<p>For a detailed visual representation of the data, visit: <a href="https://public.tableau.com/profile/krisztian.sandor#!/vizhome/Kojak_v1_1/Dashboard1">https://public.tableau.com/profile/krisztian.sandor#!/vizhome/Kojak_v1_1/Dashboard1</a></p>

<h3 id="2-train-and-validation-series-partioning">2. Train and Validation Series Partioning</h3>

<p>We&rsquo;ll use a style of walk-forward validation, where our validation set spans the same time-range as our training set, but shifted forward in time (in this case by 14 days). This way, we simulate how our model will perform on unseen data that comes in the future.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)

<span style="color:#00f">from</span> <span style="color:#000">datetime</span> <span style="color:#00f">import</span> <span style="color:#000">timedelta</span>

<span style="color:#000">pred_steps</span> = <span style="color:#3af">7</span> <span style="color:#888;font-style:italic"># Predicting the max of next 7 days</span>
<span style="color:#000">pred_length</span>=<span style="color:#000">timedelta</span>(<span style="color:#000">pred_steps</span>)

<span style="color:#000">data_start_date</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">min</span>()
<span style="color:#000">data_end_date</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">max</span>()
<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Data ranges from </span><span style="color:#5a2">%s</span><span style="color:#5a2"> to </span><span style="color:#5a2">%s</span><span style="color:#5a2">&#39;</span> % (<span style="color:#000">data_start_date</span>, <span style="color:#000">data_end_date</span>))

<span style="color:#000">first_day</span> = <span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">data_start_date</span>) 
<span style="color:#000">last_day</span> = <span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">data_end_date</span>)

<span style="color:#000">val_pred_start</span> = <span style="color:#000">last_day</span> - <span style="color:#000">pred_length</span> + <span style="color:#000">timedelta</span>(<span style="color:#3af">1</span>)
<span style="color:#000">val_pred_end</span> = <span style="color:#000">last_day</span>

<span style="color:#000">train_pred_start</span> = <span style="color:#000">val_pred_start</span> - <span style="color:#000">pred_length</span>
<span style="color:#000">train_pred_end</span> = <span style="color:#000">val_pred_start</span> - <span style="color:#000">timedelta</span>(<span style="color:#000">days</span>=<span style="color:#3af">1</span>)

<span style="color:#000">enc_length</span> = <span style="color:#000">train_pred_start</span> - <span style="color:#000">first_day</span>

<span style="color:#000">train_enc_start</span> = <span style="color:#000">first_day</span>
<span style="color:#000">train_enc_end</span> = <span style="color:#000">train_enc_start</span> + <span style="color:#000">enc_length</span> - <span style="color:#000">timedelta</span>(<span style="color:#3af">1</span>)

<span style="color:#000">val_enc_start</span> = <span style="color:#000">train_enc_start</span> + <span style="color:#000">pred_length</span>
<span style="color:#000">val_enc_end</span> = <span style="color:#000">val_enc_start</span> + <span style="color:#000">enc_length</span> - <span style="color:#000">timedelta</span>(<span style="color:#3af">1</span>)

<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Train encoding:&#39;</span>, <span style="color:#000">train_enc_start</span>, <span style="color:#5a2">&#39;-&#39;</span>, <span style="color:#000">train_enc_end</span>)
<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Train prediction:&#39;</span>, <span style="color:#000">train_pred_start</span>, <span style="color:#5a2">&#39;-&#39;</span>, <span style="color:#000">train_pred_end</span>, <span style="color:#5a2">&#39;</span><span style="color:#5a2">\n</span><span style="color:#5a2">&#39;</span>)
<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Val encoding:&#39;</span>, <span style="color:#000">val_enc_start</span>, <span style="color:#5a2">&#39;-&#39;</span>, <span style="color:#000">val_enc_end</span>)
<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Val prediction:&#39;</span>, <span style="color:#000">val_pred_start</span>, <span style="color:#5a2">&#39;-&#39;</span>, <span style="color:#000">val_pred_end</span>)

<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;</span><span style="color:#5a2">\n</span><span style="color:#5a2">Encoding interval:&#39;</span>, <span style="color:#000">enc_length</span>.<span style="color:#000">days</span>)
<span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Prediction interval:&#39;</span>, <span style="color:#000">pred_length</span>.<span style="color:#000">days</span>)</code></pre></div>
<pre><code>Data ranges from 2013-10-31 to 2014-01-01
Train encoding: 2013-10-31 00:00:00 - 2013-12-18 00:00:00
Train prediction: 2013-12-19 00:00:00 - 2013-12-25 00:00:00 

Val encoding: 2013-11-07 00:00:00 - 2013-12-25 00:00:00
Val prediction: 2013-12-26 00:00:00 - 2014-01-01 00:00:00

Encoding interval: 49
Prediction interval: 7
</code></pre>

<h3 id="3-keras-data-formatting">3. Keras Data Formatting</h3>

<p>Now that we have the time segment dates, we&rsquo;ll define the functions we need to extract the data in keras friendly format. Here are the steps:
- Pull the time series into an array, save a date_to_index mapping as a utility for referencing into the array
- Create function to extract specified time interval from all the series
- Create functions to transform all the series.
    - Here we smooth out the scale by taking log1p and de-meaning each series using the encoder series mean, then reshape to the (n_series, n_timesteps, n_features) tensor format that keras will expect.
    - Note that if we want to generate true predictions instead of log scale ones, we can easily apply a reverse transformation at prediction time.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_pivoted</span> = <span style="color:#000">pd</span>.<span style="color:#000">pivot_table</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">values</span>=<span style="color:#5a2">&#39;internet&#39;</span>, <span style="color:#000">index</span>=<span style="color:#5a2">&#39;CellID&#39;</span>, <span style="color:#000">columns</span>=<span style="color:#5a2">&#39;day&#39;</span>, <span style="color:#000">aggfunc</span>=<span style="color:#000">np</span>.<span style="color:#000">sum</span>)
<span style="color:#000">date_to_index</span> = <span style="color:#000">pd</span>.<span style="color:#000">Series</span>(<span style="color:#000">index</span>=<span style="color:#000">pd</span>.<span style="color:#000">Index</span>([<span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">c</span>) <span style="color:#00f">for</span> <span style="color:#000">c</span> <span style="color:#00f">in</span> <span style="color:#000">df_pivoted</span>.<span style="color:#000">columns</span>]),
                          <span style="color:#000">data</span>=[<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">len</span>(<span style="color:#000">df_pivoted</span>.<span style="color:#000">columns</span>))])

<span style="color:#000">series_array</span> = <span style="color:#000">df_pivoted</span>.<span style="color:#000">values</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, <span style="color:#000">start_date</span>, <span style="color:#000">end_date</span>):
    
    <span style="color:#000">inds</span> = <span style="color:#000">date_to_index</span>[<span style="color:#000">start_date</span>:<span style="color:#000">end_date</span>]
    <span style="color:#00f">return</span> <span style="color:#000">series_array</span>[:,<span style="color:#000">inds</span>]

<span style="color:#00f">def</span> <span style="color:#000">transform_series_encode</span>(<span style="color:#000">series_array</span>):
    
    <span style="color:#000">series_array</span> = <span style="color:#000">np</span>.<span style="color:#000">log1p</span>(<span style="color:#000">np</span>.<span style="color:#000">nan_to_num</span>(<span style="color:#000">series_array</span>)) <span style="color:#888;font-style:italic"># filling NaN with 0</span>
    <span style="color:#000">series_mean</span> = <span style="color:#000">series_array</span>.<span style="color:#000">mean</span>(<span style="color:#000">axis</span>=<span style="color:#3af">1</span>).<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>) 
    <span style="color:#000">series_array</span> = <span style="color:#000">series_array</span> - <span style="color:#000">series_mean</span>
    <span style="color:#000">series_array</span> = <span style="color:#000">series_array</span>.<span style="color:#000">reshape</span>((<span style="color:#000">series_array</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>],<span style="color:#000">series_array</span>.<span style="color:#000">shape</span>[<span style="color:#3af">1</span>], <span style="color:#3af">1</span>))
    
    <span style="color:#00f">return</span> <span style="color:#000">series_array</span>, <span style="color:#000">series_mean</span>

<span style="color:#00f">def</span> <span style="color:#000">transform_series_decode</span>(<span style="color:#000">series_array</span>, <span style="color:#000">encode_series_mean</span>):
    
    <span style="color:#000">series_array</span> = <span style="color:#000">np</span>.<span style="color:#000">log1p</span>(<span style="color:#000">np</span>.<span style="color:#000">nan_to_num</span>(<span style="color:#000">series_array</span>)) <span style="color:#888;font-style:italic"># filling NaN with 0</span>
    <span style="color:#000">series_array</span> = <span style="color:#000">series_array</span> - <span style="color:#000">encode_series_mean</span>
    <span style="color:#000">series_array</span> = <span style="color:#000">series_array</span>.<span style="color:#000">reshape</span>((<span style="color:#000">series_array</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>],<span style="color:#000">series_array</span>.<span style="color:#000">shape</span>[<span style="color:#3af">1</span>], <span style="color:#3af">1</span>))
    
    <span style="color:#00f">return</span> <span style="color:#000">series_array</span></code></pre></div>
<h3 id="4-cnn-architecture">4. CNN Architecture</h3>

<ul>
<li>8 dilated causal convolutional layers</li>
<li>32 filters of width 2 per layer

<ul>
<li>Exponentially increasing dilation rate (1, 2, 4, 8, &hellip;, 128)</li>
</ul></li>
<li>2 (time distributed) fully connected layers to map to final output</li>
</ul>

<p>We&rsquo;ll extract the last 7 steps from the output sequence as our predicted output for training. We&rsquo;ll use teacher forcing again during training. We&rsquo;ll have a separate function that runs an inference loop to generate predictions on unseen data, iteratively filling previous predictions into the history sequence.</p>

<p>This convolutional architecture is a simplified version of the WaveNet model, designed as a generative model for audio (in particular, for text-to-speech applications). The wavenet model can be abstracted beyond audio to apply to any time series forecasting problem, providing a nice structure for capturing long-term dependencies without an excessive number of learned weights.
The core building block of the wavenet model is the dilated causal convolution layer. It utilizes some other key techniques like gated activations and skip connections, but for now we&rsquo;ll focus on the central idea of the architecture to keep things simple (check out the next notebook in the series for these). I&rsquo;ll explain this style of convolution (causal and dilated), then show how to implement our simplified WaveNet architecture in keras.</p>

<p><img src="/Post_images/20181213_PassionProject/Slide_images/Slide04.jpeg" alt="jpeg" /></p>

<p>Causal Convolutions<br />
In a traditional 1-dimensional convolution layer, as in the image below taken from Chris Olah&rsquo;s excellent blog, we slide a filter of weights across an input series, sequentially applying it to (usually overlapping) regions of the series. The output shape will depend on the sequence padding used, and is closely related to the connection structure between inputs and outputs. In this example, a filter of width 2, stride of 1, and no padding means that the output sequence will have one fewer entry than the input.
1dconv
In the image, imagine that $y_0,&hellip;, y_7$ are each prediction outputs for the time steps that follow the series values $x_0,&hellip;,x_7$. There is a clear problem - since $x_1$ influences the output $y_0$, we would be using the future to predict the past, which is cheating! Letting the future of a sequence influence our interpretation of its past makes sense in a context like text classification where we use a known sequence to predict an outcome, but not in our time series context where we must generate future values in a sequence.
To solve this problem, we adjust our convolution design to explicitly prohibit the future from influencing the past. In other words, we only allow inputs to connect to future time step outputs in a causal structure, as pictured below in a visualization from the WaveNet paper. In practice, this causal 1D structure is easy to implement by shifting traditional convolutional outputs by a number of timesteps. Keras handles it via setting padding = &lsquo;causal&rsquo;.
causalconv</p>

<p>Dilated (Causal) Convolutions<br />
With causal convolutions we have the proper tool for handling temporal flow, but we need an additional modification to properly handle long-term dependencies. In the simple causal convolution figure above, you can see that only the 5 most recent timesteps can influence the highlighted output. In fact, we would require one additional layer per timestep to reach farther back in the series (to use proper terminology, to increase the output&rsquo;s receptive field). With a time series that extends for over a year, using simple causal convolutions to learn from the entire history would quickly make our model way too computationally and statistically complex.
Instead of making that mistake, WaveNet uses dilated convolutions, which allow the receptive field to increase exponentially as a function of the number of convolutional layers. In a dilated convolution layer, filters are not applied to inputs in a simple sequential manner, but instead skip a constant dilation rate inputs in between each of the inputs they process, as in the WaveNet diagram below. By increasing the dilation rate multiplicatively at each layer (e.g. 1, 2, 4, 8, &hellip;), we can achieve the exponential relationship between layer count and receptive field size that we desire. In the diagram, you can see how we now only need 4 layers to connect all of the 16 input series values to the highlighted output (say the 17th time step value).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">keras.models</span> <span style="color:#00f">import</span> <span style="color:#000">Model</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.layers</span> <span style="color:#00f">import</span> <span style="color:#000">Input</span>, <span style="color:#000">Conv1D</span>, <span style="color:#000">Dense</span>, <span style="color:#000">Dropout</span>, <span style="color:#000">Lambda</span>, <span style="color:#000">concatenate</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.optimizers</span> <span style="color:#00f">import</span> <span style="color:#000">Adam</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.callbacks</span> <span style="color:#00f">import</span> <span style="color:#000">EarlyStopping</span>

<span style="color:#888;font-style:italic"># convolutional layer parameters</span>
<span style="color:#000">n_filters</span> = <span style="color:#3af">32</span> 
<span style="color:#000">filter_width</span> = <span style="color:#3af">2</span>
<span style="color:#000">dilation_rates</span> = [<span style="color:#3af">2</span>**<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">8</span>)] 

<span style="color:#888;font-style:italic"># define an input history series and pass it through a stack of dilated causal convolutions. </span>
<span style="color:#000">history_seq</span> = <span style="color:#000">Input</span>(<span style="color:#000">shape</span>=(<span style="color:#000">None</span>, <span style="color:#3af">1</span>))
<span style="color:#000">x</span> = <span style="color:#000">history_seq</span>

<span style="color:#00f">for</span> <span style="color:#000">dilation_rate</span> <span style="color:#00f">in</span> <span style="color:#000">dilation_rates</span>:
    <span style="color:#000">x</span> = <span style="color:#000">Conv1D</span>(<span style="color:#000">filters</span>=<span style="color:#000">n_filters</span>,
               <span style="color:#000">kernel_size</span>=<span style="color:#000">filter_width</span>, 
               <span style="color:#000">padding</span>=<span style="color:#5a2">&#39;causal&#39;</span>,
               <span style="color:#000">dilation_rate</span>=<span style="color:#000">dilation_rate</span>)(<span style="color:#000">x</span>)

<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">128</span>, <span style="color:#000">activation</span>=<span style="color:#5a2">&#39;relu&#39;</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dropout</span>(.<span style="color:#3af">2</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">1</span>)(<span style="color:#000">x</span>)

<span style="color:#888;font-style:italic"># extract the last 7 time steps as the training target</span>
<span style="color:#00f">def</span> <span style="color:#000">slice</span>(<span style="color:#000">x</span>, <span style="color:#000">seq_length</span>):
    <span style="color:#00f">return</span> <span style="color:#000">x</span>[:,-<span style="color:#000">seq_length</span>:,:]

<span style="color:#000">pred_seq_train</span> = <span style="color:#000">Lambda</span>(<span style="color:#000">slice</span>, <span style="color:#000">arguments</span>={<span style="color:#5a2">&#39;seq_length&#39;</span>:<span style="color:#000">pred_steps</span>})(<span style="color:#000">x</span>)

<span style="color:#000">model</span> = <span style="color:#000">Model</span>(<span style="color:#000">history_seq</span>, <span style="color:#000">pred_seq_train</span>)</code></pre></div>
<pre><code>Using TensorFlow backend.
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">model</span>.<span style="color:#000">summary</span>()</code></pre></div>
<pre><code>_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, None, 1)           0         
_________________________________________________________________
conv1d_1 (Conv1D)            (None, None, 32)          96        
_________________________________________________________________
conv1d_2 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_3 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_4 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_5 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_6 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_7 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
conv1d_8 (Conv1D)            (None, None, 32)          2080      
_________________________________________________________________
dense_1 (Dense)              (None, None, 128)         4224      
_________________________________________________________________
dropout_1 (Dropout)          (None, None, 128)         0         
_________________________________________________________________
dense_2 (Dense)              (None, None, 1)           129       
_________________________________________________________________
lambda_1 (Lambda)            (None, None, 1)           0         
=================================================================
Total params: 19,009
Trainable params: 19,009
Non-trainable params: 0
_________________________________________________________________
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">first_n_samples</span> = <span style="color:#3af">40000</span> <span style="color:#888;font-style:italic"># no effect</span>
<span style="color:#000">batch_size</span> = <span style="color:#3af">2</span>**<span style="color:#3af">11</span>
<span style="color:#000">epochs</span> = <span style="color:#3af">1000</span>

<span style="color:#888;font-style:italic"># sample of series from train_enc_start to train_enc_end  </span>
<span style="color:#000">encoder_input_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, 
                                           <span style="color:#000">train_enc_start</span>, <span style="color:#000">train_enc_end</span>)[:<span style="color:#000">first_n_samples</span>]
<span style="color:#000">encoder_input_data</span>, <span style="color:#000">encode_series_mean</span> = <span style="color:#000">transform_series_encode</span>(<span style="color:#000">encoder_input_data</span>)

<span style="color:#888;font-style:italic"># sample of series from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, 
                                            <span style="color:#000">train_pred_start</span>, <span style="color:#000">train_pred_end</span>)[:<span style="color:#000">first_n_samples</span>]
<span style="color:#000">decoder_target_data</span> = <span style="color:#000">transform_series_decode</span>(<span style="color:#000">decoder_target_data</span>, <span style="color:#000">encode_series_mean</span>)

<span style="color:#888;font-style:italic"># we append a lagged history of the target series to the input data, </span>
<span style="color:#888;font-style:italic"># so that we can train with teacher forcing</span>
<span style="color:#000">lagged_target_history</span> = <span style="color:#000">decoder_target_data</span>[:,:-<span style="color:#3af">1</span>,:<span style="color:#3af">1</span>]
<span style="color:#000">encoder_input_data</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encoder_input_data</span>, <span style="color:#000">lagged_target_history</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">model</span>.<span style="color:#000">compile</span>(<span style="color:#000">Adam</span>(), <span style="color:#000">loss</span>=<span style="color:#5a2">&#39;mean_absolute_error&#39;</span>)
<span style="color:#000">monitor</span> = <span style="color:#000">EarlyStopping</span>(<span style="color:#000">monitor</span>=<span style="color:#5a2">&#39;val_loss&#39;</span>, <span style="color:#000">min_delta</span>=<span style="color:#3af">1e-3</span>, <span style="color:#000">patience</span>=<span style="color:#3af">5</span>, <span style="color:#000">verbose</span>=<span style="color:#3af">1</span>, <span style="color:#000">mode</span>=<span style="color:#5a2">&#39;auto&#39;</span>)
<span style="color:#000">history</span> = <span style="color:#000">model</span>.<span style="color:#000">fit</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>,
                    <span style="color:#000">batch_size</span>=<span style="color:#000">batch_size</span>,
                    <span style="color:#000">callbacks</span>=[<span style="color:#000">monitor</span>],
                    <span style="color:#000">epochs</span>=<span style="color:#000">epochs</span>,
                    <span style="color:#000">validation_split</span>=<span style="color:#3af">0.2</span>)</code></pre></div>
<pre><code>Train on 8000 samples, validate on 2000 samples
Epoch 1/1000
8000/8000 [==============================] - 7s 892us/step - loss: 0.2658 - val_loss: 0.1406
Epoch 2/1000
8000/8000 [==============================] - 6s 750us/step - loss: 0.2148 - val_loss: 0.1575
Epoch 3/1000
8000/8000 [==============================] - 6s 747us/step - loss: 0.1953 - val_loss: 0.1216
Epoch 4/1000
8000/8000 [==============================] - 6s 755us/step - loss: 0.1824 - val_loss: 0.1180
Epoch 5/1000
8000/8000 [==============================] - 6s 752us/step - loss: 0.1693 - val_loss: 0.1225
Epoch 6/1000
8000/8000 [==============================] - 6s 756us/step - loss: 0.1584 - val_loss: 0.1071
Epoch 7/1000
8000/8000 [==============================] - 6s 754us/step - loss: 0.1493 - val_loss: 0.1136
Epoch 8/1000
8000/8000 [==============================] - 6s 752us/step - loss: 0.1446 - val_loss: 0.1077
Epoch 9/1000
8000/8000 [==============================] - 6s 748us/step - loss: 0.1411 - val_loss: 0.1071
Epoch 10/1000
8000/8000 [==============================] - 6s 754us/step - loss: 0.1383 - val_loss: 0.1056
Epoch 11/1000
8000/8000 [==============================] - 6s 753us/step - loss: 0.1360 - val_loss: 0.1047
Epoch 12/1000
8000/8000 [==============================] - 6s 754us/step - loss: 0.1346 - val_loss: 0.1037
Epoch 13/1000
8000/8000 [==============================] - 6s 752us/step - loss: 0.1329 - val_loss: 0.1045
Epoch 14/1000
8000/8000 [==============================] - 6s 752us/step - loss: 0.1319 - val_loss: 0.1022
Epoch 15/1000
8000/8000 [==============================] - 6s 750us/step - loss: 0.1307 - val_loss: 0.1039
Epoch 16/1000
8000/8000 [==============================] - 6s 749us/step - loss: 0.1302 - val_loss: 0.1018
Epoch 17/1000
8000/8000 [==============================] - 6s 753us/step - loss: 0.1294 - val_loss: 0.1017
Epoch 18/1000
8000/8000 [==============================] - 6s 751us/step - loss: 0.1288 - val_loss: 0.1026
Epoch 19/1000
8000/8000 [==============================] - 6s 750us/step - loss: 0.1284 - val_loss: 0.1010
Epoch 20/1000
8000/8000 [==============================] - 6s 754us/step - loss: 0.1275 - val_loss: 0.1017
Epoch 21/1000
8000/8000 [==============================] - 6s 752us/step - loss: 0.1269 - val_loss: 0.1015
Epoch 22/1000
8000/8000 [==============================] - 6s 755us/step - loss: 0.1269 - val_loss: 0.1008
Epoch 23/1000
8000/8000 [==============================] - 6s 749us/step - loss: 0.1263 - val_loss: 0.1007
Epoch 24/1000
8000/8000 [==============================] - 6s 751us/step - loss: 0.1259 - val_loss: 0.1002
Epoch 00024: early stopping
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">history</span>.<span style="color:#000">history</span>[<span style="color:#5a2">&#39;loss&#39;</span>])
<span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">history</span>.<span style="color:#000">history</span>[<span style="color:#5a2">&#39;val_loss&#39;</span>])

<span style="color:#000">plt</span>.<span style="color:#000">xlabel</span>(<span style="color:#5a2">&#39;Epoch&#39;</span>)
<span style="color:#000">plt</span>.<span style="color:#000">ylabel</span>(<span style="color:#5a2">&#39;Mean Absolute Error Loss&#39;</span>)
<span style="color:#000">plt</span>.<span style="color:#000">title</span>(<span style="color:#5a2">&#39;Loss Over Time&#39;</span>)
<span style="color:#000">plt</span>.<span style="color:#000">legend</span>([<span style="color:#5a2">&#39;Train&#39;</span>,<span style="color:#5a2">&#39;Valid&#39;</span>])</code></pre></div>
<pre><code>&lt;matplotlib.legend.Legend at 0x7f8dc9d3b320&gt;
</code></pre>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_20_1.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Save model to disk</span>
<span style="color:#000">model_name</span>=<span style="color:#5a2">&#39;model_1f&#39;</span>

<span style="color:#888;font-style:italic"># serialize model to JSON</span>
<span style="color:#000">model_json</span> = <span style="color:#000">model</span>.<span style="color:#000">to_json</span>()
<span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.json&#34;</span>, <span style="color:#5a2">&#34;w&#34;</span>) <span style="color:#00f">as</span> <span style="color:#000">json_file</span>:
    <span style="color:#000">json_file</span>.<span style="color:#000">write</span>(<span style="color:#000">model_json</span>)
<span style="color:#888;font-style:italic"># serialize weights to HDF5</span>
<span style="color:#000">model</span>.<span style="color:#000">save_weights</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.h5&#34;</span>)
<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Saved {model_name} to disk&#34;</span>)</code></pre></div>
<pre><code>Saved model_1f to disk
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Load model from disk if already saved</span>

<span style="color:#00f">def</span> <span style="color:#000">import_model</span>(<span style="color:#000">model_name</span>):
    
    <span style="color:#00f">from</span> <span style="color:#000">keras.models</span> <span style="color:#00f">import</span> <span style="color:#000">model_from_json</span>

    <span style="color:#888;font-style:italic"># load json and create model</span>
    <span style="color:#000">json_file</span> = <span style="color:#000">open</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#39;.json&#39;</span>, <span style="color:#5a2">&#39;r&#39;</span>)
    <span style="color:#000">loaded_model_json</span> = <span style="color:#000">json_file</span>.<span style="color:#000">read</span>()
    <span style="color:#000">json_file</span>.<span style="color:#000">close</span>()
    <span style="color:#000">loaded_model</span> = <span style="color:#000">model_from_json</span>(<span style="color:#000">loaded_model_json</span>)
    <span style="color:#888;font-style:italic"># load weights into new model</span>
    <span style="color:#000">loaded_model</span>.<span style="color:#000">load_weights</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.h5&#34;</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Loaded {model_name} from disk&#34;</span>)
    <span style="color:#00f">return</span> <span style="color:#000">loaded_model</span></code></pre></div>
<h3 id="5-building-the-model-inference-loop">5. Building the Model - Inference Loop</h3>

<p>The model outputs the next 7 time predictions. We are only using the first prediction each time, the rest is used for teacher forcing. Teacher forcing is a methodology to use most recent predictions of the model for predicting the next period, i.e. learn from its mistakes.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">predict_sequence_1f</span>(<span style="color:#000">input_sequence</span>, <span style="color:#000">model</span>):

    <span style="color:#000">history_sequence</span> = <span style="color:#000">input_sequence</span>.<span style="color:#000">copy</span>()
    <span style="color:#000">pred_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">zeros</span>((<span style="color:#3af">1</span>,<span style="color:#000">pred_steps</span>,<span style="color:#3af">1</span>)) <span style="color:#888;font-style:italic"># initialize output (pred_steps time steps)  </span>
    
    <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">pred_steps</span>):
        
        <span style="color:#888;font-style:italic"># record next time step prediction (last time step of model output) </span>
        <span style="color:#000">last_step_pred</span> = <span style="color:#000">model</span>.<span style="color:#000">predict</span>(<span style="color:#000">history_sequence</span>)[<span style="color:#3af">0</span>,-<span style="color:#3af">1</span>,<span style="color:#3af">0</span>]
        <span style="color:#000">pred_sequence</span>[<span style="color:#3af">0</span>,<span style="color:#000">i</span>,<span style="color:#3af">0</span>] = <span style="color:#000">last_step_pred</span>
        
        <span style="color:#888;font-style:italic"># add the next time step prediction to the history sequence</span>
        <span style="color:#000">history_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">history_sequence</span>, 
                                           <span style="color:#000">last_step_pred</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>,<span style="color:#3af">1</span>)], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

    <span style="color:#00f">return</span> <span style="color:#000">pred_sequence</span></code></pre></div>
<h3 id="6-generating-and-plotting-predictions">6. Generating and Plotting Predictions</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">encoder_input_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, <span style="color:#000">val_enc_start</span>, <span style="color:#000">val_enc_end</span>)
<span style="color:#000">encoder_input_data</span>, <span style="color:#000">encode_series_mean</span> = <span style="color:#000">transform_series_encode</span>(<span style="color:#000">encoder_input_data</span>)

<span style="color:#000">decoder_target_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, <span style="color:#000">val_pred_start</span>, <span style="color:#000">val_pred_end</span>)
<span style="color:#000">decoder_target_data</span> = <span style="color:#000">transform_series_decode</span>(<span style="color:#000">decoder_target_data</span>, <span style="color:#000">encode_series_mean</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">predict_and_plot</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">sample_ind</span>, <span style="color:#000">encode_series_mean</span>, <span style="color:#000">model</span>, <span style="color:#000">enc_tail_len</span>=<span style="color:#3af">50</span>):

    <span style="color:#000">sample_ind</span> -= <span style="color:#3af">1</span>
    
    <span style="color:#000">encode_series</span> = <span style="color:#000">encoder_input_data</span>[<span style="color:#000">sample_ind</span>:<span style="color:#000">sample_ind</span>+<span style="color:#3af">1</span>,:,:] 
    <span style="color:#000">pred_series</span> = <span style="color:#000">predict_sequence_1f</span>(<span style="color:#000">encode_series</span>,<span style="color:#000">model</span>)
    
    <span style="color:#000">encode_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">encode_series</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>) + <span style="color:#000">encode_series_mean</span>[<span style="color:#000">sample_ind</span>])
    <span style="color:#000">pred_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">pred_series</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>) + <span style="color:#000">encode_series_mean</span>[<span style="color:#000">sample_ind</span>])
    <span style="color:#000">target_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">decoder_target_data</span>[<span style="color:#000">sample_ind</span>,:,:<span style="color:#3af">1</span>].<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>) + <span style="color:#000">encode_series_mean</span>[<span style="color:#000">sample_ind</span>])
    
    <span style="color:#000">encode_series_tail</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encode_series</span>[-<span style="color:#000">enc_tail_len</span>:],<span style="color:#000">target_series</span>[:<span style="color:#3af">1</span>]])
    <span style="color:#000">x_encode</span> = <span style="color:#000">encode_series_tail</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]
    
    <span style="color:#000">plt</span>.<span style="color:#000">figure</span>(<span style="color:#000">figsize</span>=(<span style="color:#3af">10</span>,<span style="color:#3af">6</span>))   
    
    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#000">x_encode</span>+<span style="color:#3af">1</span>),<span style="color:#000">encode_series_tail</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#000">x_encode</span>,<span style="color:#000">x_encode</span>+<span style="color:#000">pred_steps</span>),<span style="color:#000">target_series</span>,<span style="color:#000">color</span>=<span style="color:#5a2">&#39;orange&#39;</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#000">x_encode</span>,<span style="color:#000">x_encode</span>+<span style="color:#000">pred_steps</span>),<span style="color:#000">pred_series</span>,<span style="color:#000">color</span>=<span style="color:#5a2">&#39;teal&#39;</span>,<span style="color:#000">linestyle</span>=<span style="color:#5a2">&#39;--&#39;</span>)
    
    <span style="color:#000">plt</span>.<span style="color:#000">title</span>(<span style="color:#5a2">&#39;1 feature - Encoder Series Tail of Length </span><span style="color:#5a2">%d</span><span style="color:#5a2">, Target Series, and Predictions&#39;</span> % <span style="color:#000">enc_tail_len</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">legend</span>([<span style="color:#5a2">&#39;Encoding Series&#39;</span>,<span style="color:#5a2">&#39;Target Series&#39;</span>,<span style="color:#5a2">&#39;Predictions&#39;</span>])</code></pre></div>
<h3 id="6-main-function-1-feature">6. Main function (1 feature)</h3>

<p>This function uses only internet traffic as input variable to predict future internet traffic</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">main_1</span>(<span style="color:#000">cell_id</span>):
    
    <span style="color:#888;font-style:italic"># Main 1 feature model</span>
    <span style="color:#000">model_to_use</span> = <span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_1f&#39;</span>

    <span style="color:#888;font-style:italic"># Import model</span>
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
    <span style="color:#000">model</span> = <span style="color:#000">import_model</span>(<span style="color:#000">model_to_use</span>)
    
    <span style="color:#888;font-style:italic"># Format data</span>
    <span style="color:#000">df_pivoted</span> = <span style="color:#000">pd</span>.<span style="color:#000">pivot_table</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">values</span>=<span style="color:#5a2">&#39;internet&#39;</span>, <span style="color:#000">index</span>=<span style="color:#5a2">&#39;CellID&#39;</span>, <span style="color:#000">columns</span>=<span style="color:#5a2">&#39;day&#39;</span>, <span style="color:#000">aggfunc</span>=<span style="color:#000">np</span>.<span style="color:#000">sum</span>)
    <span style="color:#000">date_to_index</span> = <span style="color:#000">pd</span>.<span style="color:#000">Series</span>(<span style="color:#000">index</span>=<span style="color:#000">pd</span>.<span style="color:#000">Index</span>([<span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">c</span>) <span style="color:#00f">for</span> <span style="color:#000">c</span> <span style="color:#00f">in</span> <span style="color:#000">df_pivoted</span>.<span style="color:#000">columns</span>]),
                              <span style="color:#000">data</span>=[<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">len</span>(<span style="color:#000">df_pivoted</span>.<span style="color:#000">columns</span>))])
    <span style="color:#000">series_array</span> = <span style="color:#000">df_pivoted</span>.<span style="color:#000">values</span>

    <span style="color:#888;font-style:italic"># Generate encoder and decoder dataset</span>
    <span style="color:#000">encoder_input_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, <span style="color:#000">val_enc_start</span>, <span style="color:#000">val_enc_end</span>)
    <span style="color:#000">encoder_input_data</span>, <span style="color:#000">encode_series_mean</span> = <span style="color:#000">transform_series_encode</span>(<span style="color:#000">encoder_input_data</span>)

    <span style="color:#000">decoder_target_data</span> = <span style="color:#000">get_time_block_series</span>(<span style="color:#000">series_array</span>, <span style="color:#000">date_to_index</span>, <span style="color:#000">val_pred_start</span>, <span style="color:#000">val_pred_end</span>)
    <span style="color:#000">decoder_target_data</span> = <span style="color:#000">transform_series_decode</span>(<span style="color:#000">decoder_target_data</span>, <span style="color:#000">encode_series_mean</span>)

    <span style="color:#888;font-style:italic"># Predict and plot</span>
    <span style="color:#000">predict_and_plot</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">cell_id</span>, <span style="color:#000">encode_series_mean</span>, <span style="color:#000">model</span>=<span style="color:#000">model</span>)</code></pre></div>
<hr />

<h3 id="7-integrating-calls-and-sms-features">7. Integrating calls and sms features</h3>

<p>The previous model only used the historical internet traffic to predict the future internet traffic. Here we are extending the model to take the historical calls and sms traffic besides the internet traffic to generate predictions</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>calls</th>
      <th>sms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>1.021221</td>
      <td>3.189034</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>1.040205</td>
      <td>3.179480</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>1.060412</td>
      <td>3.169311</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>0.966233</td>
      <td>3.216705</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>0.884973</td>
      <td>2.914617</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)</code></pre></div>
<h3 id="8-re-scale-each-feature-separatly">8. Re-scale each feature separatly</h3>

<p>Re-scaling each feature (internet, calls, sms) separately for each cell separately captures the various patterns in the series</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">agg_func</span>(<span style="color:#000">col</span>):
    <span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    <span style="color:#000">log_c</span>=<span style="color:#000">np</span>.<span style="color:#000">log1p</span>(<span style="color:#000">col</span>)
    <span style="color:#000">mean_log_c</span>=<span style="color:#000">np</span>.<span style="color:#000">mean</span>(<span style="color:#000">np</span>.<span style="color:#000">log1p</span>(<span style="color:#000">col</span>))
    <span style="color:#000">mean_list</span>.<span style="color:#000">append</span>(<span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">mean_log_c</span>))
    <span style="color:#00f">return</span> <span style="color:#000">log_c</span>-<span style="color:#000">mean_log_c</span>

<span style="color:#00f">def</span> <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">dim</span>):
    <span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    <span style="color:#00f">for</span> <span style="color:#000">col_name</span> <span style="color:#00f">in</span> <span style="color:#000">df_cdrs</span>.<span style="color:#000">columns</span>[<span style="color:#3af">2</span>:<span style="color:#3af">2</span>+<span style="color:#000">dim</span>]:
        <span style="color:#888;font-style:italic">#print(col_name)</span>
        <span style="color:#000">df_cdrs</span>[<span style="color:#000">col_name</span>+<span style="color:#5a2">&#39;_scaled&#39;</span>] = <span style="color:#000">df_cdrs</span>.<span style="color:#000">groupby</span>([<span style="color:#5a2">&#39;CellID&#39;</span>])[<span style="color:#000">col_name</span>].<span style="color:#000">apply</span>(<span style="color:#000">agg_func</span>)
    
    <span style="color:#000">cells</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">CellID</span>.<span style="color:#000">nunique</span>()
    <span style="color:#000">means</span>=<span style="color:#000">np</span>.<span style="color:#000">zeros</span>((<span style="color:#3af">10000</span>,<span style="color:#000">dim</span>))
    <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">dim</span>):
        <span style="color:#000">means</span>[:,<span style="color:#000">i</span>] = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">mean_list</span>[<span style="color:#000">i</span>*<span style="color:#000">cells</span>:(<span style="color:#000">i</span>+<span style="color:#3af">1</span>)*<span style="color:#000">cells</span>])
    <span style="color:#000">mean_list</span> = <span style="color:#000">means</span>
    
    <span style="color:#00f">return</span> <span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>calls</th>
      <th>sms</th>
      <th>internet_scaled</th>
      <th>calls_scaled</th>
      <th>sms_scaled</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>1.021221</td>
      <td>3.189034</td>
      <td>-0.477102</td>
      <td>-1.855503</td>
      <td>-1.144778</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>1.040205</td>
      <td>3.179480</td>
      <td>-0.479278</td>
      <td>-1.860002</td>
      <td>-1.160078</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>1.060412</td>
      <td>3.169311</td>
      <td>-0.481585</td>
      <td>-1.864703</td>
      <td>-1.176392</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>0.966233</td>
      <td>3.216705</td>
      <td>-0.470914</td>
      <td>-1.841838</td>
      <td>-1.099484</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>0.884973</td>
      <td>2.914617</td>
      <td>-0.468362</td>
      <td>-1.819482</td>
      <td>-1.106134</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="9-reformat-data-for-keras">9. Reformat data for KERAS</h3>

<p>Keras Conv1D requires 3 dimensional input data (samples=cell-towers, dates, features)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># VERY INEFFICIENT way to create keras friendly data format</span>


<span style="color:#00f">from</span> <span style="color:#000">IPython.display</span> <span style="color:#00f">import</span> <span style="color:#000">clear_output</span>

<span style="color:#888;font-style:italic"># Building KERAS friendly data in the dimensions (n_celltowers, dates, features):(10000,63,3)</span>

<span style="color:#000">x</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">CellID</span>.<span style="color:#000">nunique</span>()
<span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
<span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))
<span style="color:#000">z</span> = <span style="color:#000">dim</span>   

<span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">zeros</span>((<span style="color:#000">x</span>,<span style="color:#000">y</span>,<span style="color:#000">z</span>))

<span style="color:#00f">for</span> <span style="color:#000">name</span>,<span style="color:#000">group</span> <span style="color:#00f">in</span> <span style="color:#000">df_cdrs</span>.<span style="color:#000">groupby</span>([<span style="color:#5a2">&#39;CellID&#39;</span>])[<span style="color:#5a2">&#39;internet_scaled&#39;</span>,<span style="color:#5a2">&#39;calls_scaled&#39;</span>,<span style="color:#5a2">&#39;sms_scaled&#39;</span>]: 
    <span style="color:#000">status</span> = <span style="color:#000">round</span>(<span style="color:#000">name</span>/<span style="color:#000">x</span>*<span style="color:#3af">100</span>)
    <span style="color:#000">clear_output</span>()
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Progress: {status}%&#39;</span>)
    <span style="color:#000">group</span>[<span style="color:#000">name</span>] = <span style="color:#000">group</span>[<span style="color:#000">group</span>.<span style="color:#000">columns</span>[<span style="color:#3af">2</span>:<span style="color:#3af">2</span>+<span style="color:#000">dim</span>]].<span style="color:#000">values</span>.<span style="color:#000">tolist</span>()
    <span style="color:#000">group</span> = <span style="color:#000">group</span>[[<span style="color:#5a2">&#39;day&#39;</span>,<span style="color:#000">name</span>]]
    <span style="color:#000">group</span>.<span style="color:#000">set_index</span>([<span style="color:#5a2">&#39;day&#39;</span>],<span style="color:#000">inplace</span>=<span style="color:#000">True</span>)
    
    <span style="color:#00f">for</span> <span style="color:#000">date</span> <span style="color:#00f">in</span> <span style="color:#000">y_list</span>:
        <span style="color:#00f">if</span> <span style="color:#000">date</span> <span style="color:#00f">in</span> <span style="color:#000">group</span>.<span style="color:#000">index</span>:
            <span style="color:#00f">for</span> <span style="color:#000">f</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">z</span>):
                <span style="color:#000">keras_matrix</span>[<span style="color:#000">name</span>-<span style="color:#3af">1</span>][<span style="color:#000">d_dates_index</span>[<span style="color:#000">date</span>]][<span style="color:#000">f</span>]=<span style="color:#000">group</span>.<span style="color:#000">loc</span>[<span style="color:#000">date</span>].<span style="color:#000">values</span>[<span style="color:#3af">0</span>][<span style="color:#000">f</span>]
<span style="color:#000">keras_matrix</span>.<span style="color:#000">dump</span>(<span style="color:#5a2">&#34;keras_matrix_newscaling.dat&#34;</span>)</code></pre></div>
<pre><code>Progress: 100%
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># This is a MUCH faster reformatting algorithm for KERAS inputs</span>

<span style="color:#00f">def</span> <span style="color:#000">create_keras_matrix</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">dim</span>):
    <span style="color:#000">l</span>=[]
    <span style="color:#00f">for</span> <span style="color:#000">n</span>,<span style="color:#000">v</span> <span style="color:#00f">in</span> <span style="color:#000">df_cdrs</span>.<span style="color:#000">groupby</span>([<span style="color:#5a2">&#39;CellID&#39;</span>]):
        <span style="color:#888;font-style:italic">#print(n)</span>
        <span style="color:#000">cell_data</span> = <span style="color:#000">v</span>[<span style="color:#000">v</span>.<span style="color:#000">columns</span>[<span style="color:#3af">2</span>+<span style="color:#000">dim</span>:]].<span style="color:#000">values</span>
        <span style="color:#00f">if</span> <span style="color:#000">cell_data</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>] != <span style="color:#3af">63</span>:
            <span style="color:#888;font-style:italic"># for missing dates use mean of rest</span>
            <span style="color:#000">sub</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>([<span style="color:#000">cell_data</span>[:,<span style="color:#000">i</span>].<span style="color:#000">mean</span>() <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">dim</span>)]).<span style="color:#000">reshape</span>(<span style="color:#3af">1</span>,<span style="color:#000">dim</span>)
            <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">0</span>,<span style="color:#3af">63</span>-<span style="color:#000">cell_data</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]):
                <span style="color:#000">cell_data</span> = <span style="color:#000">np</span>.<span style="color:#000">append</span>(<span style="color:#000">cell_data</span>,<span style="color:#000">sub</span>)
            <span style="color:#000">cell_data</span> = <span style="color:#000">cell_data</span>.<span style="color:#000">reshape</span>(<span style="color:#3af">63</span>,<span style="color:#000">dim</span>)
        <span style="color:#000">l</span>.<span style="color:#000">append</span>(<span style="color:#000">cell_data</span>)

    <span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">l</span>)
    <span style="color:#000">keras_matrix</span>.<span style="color:#000">dump</span>(<span style="color:#5a2">&#34;keras_matrix_internet+zones_featurenr_&#34;</span>+<span style="color:#000">str</span>(<span style="color:#000">dim</span>)+<span style="color:#5a2">&#34;.dat&#34;</span>)
    <span style="color:#00f">return</span> <span style="color:#000">keras_matrix</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">create_keras_matrix</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">dim</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;../01_Data/03_AWS outputs/keras_matrix_newscaling.dat&#34;</span>)
<span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
<span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># data from train_enc_start to train_enc_end  </span>
<span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )
<span style="color:#888;font-style:italic"># we append a lagged history of the target series to the input data, </span>
<span style="color:#888;font-style:italic"># so that we can train with teacher forcing</span>
<span style="color:#000">lagged_target_history</span> = <span style="color:#000">decoder_target_data</span>[:,:-<span style="color:#3af">1</span>,:]
<span style="color:#000">encoder_input_data</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encoder_input_data</span>, <span style="color:#000">lagged_target_history</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">keras.models</span> <span style="color:#00f">import</span> <span style="color:#000">Model</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.layers</span> <span style="color:#00f">import</span> <span style="color:#000">Input</span>, <span style="color:#000">Conv1D</span>, <span style="color:#000">Dense</span>, <span style="color:#000">Dropout</span>, <span style="color:#000">Lambda</span>, <span style="color:#000">concatenate</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.optimizers</span> <span style="color:#00f">import</span> <span style="color:#000">Adam</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.callbacks</span> <span style="color:#00f">import</span> <span style="color:#000">EarlyStopping</span>

<span style="color:#888;font-style:italic"># convolutional layer parameters</span>
<span style="color:#000">n_filters</span> = <span style="color:#3af">32</span> 
<span style="color:#000">filter_width</span> = <span style="color:#3af">2</span>
<span style="color:#000">dilation_rates</span> = [<span style="color:#3af">2</span>**<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">8</span>)] 

<span style="color:#888;font-style:italic"># define an input history series and pass it through a stack of dilated causal convolutions. </span>
<span style="color:#000">history_seq</span> = <span style="color:#000">Input</span>(<span style="color:#000">shape</span>=(<span style="color:#000">None</span>, <span style="color:#3af">3</span>))
<span style="color:#000">x</span> = <span style="color:#000">history_seq</span>

<span style="color:#00f">for</span> <span style="color:#000">dilation_rate</span> <span style="color:#00f">in</span> <span style="color:#000">dilation_rates</span>:
    <span style="color:#000">x</span> = <span style="color:#000">Conv1D</span>(<span style="color:#000">filters</span>=<span style="color:#000">n_filters</span>,
               <span style="color:#000">kernel_size</span>=<span style="color:#000">filter_width</span>, 
               <span style="color:#000">padding</span>=<span style="color:#5a2">&#39;causal&#39;</span>,
               <span style="color:#000">dilation_rate</span>=<span style="color:#000">dilation_rate</span>)(<span style="color:#000">x</span>)

<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">128</span>, <span style="color:#000">activation</span>=<span style="color:#5a2">&#39;relu&#39;</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dropout</span>(.<span style="color:#3af">2</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">3</span>)(<span style="color:#000">x</span>)

<span style="color:#888;font-style:italic"># extract the last 7 time steps as the training target</span>
<span style="color:#00f">def</span> <span style="color:#000">slice</span>(<span style="color:#000">x</span>, <span style="color:#000">seq_length</span>):
    <span style="color:#00f">return</span> <span style="color:#000">x</span>[:,-<span style="color:#000">seq_length</span>:,:]

<span style="color:#000">pred_seq_train</span> = <span style="color:#000">Lambda</span>(<span style="color:#000">slice</span>, <span style="color:#000">arguments</span>={<span style="color:#5a2">&#39;seq_length&#39;</span>:<span style="color:#000">pred_steps</span>})(<span style="color:#000">x</span>)

<span style="color:#000">model</span> = <span style="color:#000">Model</span>(<span style="color:#000">history_seq</span>, <span style="color:#000">pred_seq_train</span>)
<span style="color:#000">model</span>.<span style="color:#000">summary</span>()</code></pre></div>
<pre><code>_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         (None, None, 3)           0         
_________________________________________________________________
conv1d_9 (Conv1D)            (None, None, 32)          224       
_________________________________________________________________
conv1d_10 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_11 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_12 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_13 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_14 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_15 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_16 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
dense_3 (Dense)              (None, None, 128)         4224      
_________________________________________________________________
dropout_2 (Dropout)          (None, None, 128)         0         
_________________________________________________________________
dense_4 (Dense)              (None, None, 3)           387       
_________________________________________________________________
lambda_2 (Lambda)            (None, None, 3)           0         
=================================================================
Total params: 19,395
Trainable params: 19,395
Non-trainable params: 0
_________________________________________________________________
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">batch_size</span> = <span style="color:#3af">2</span>**<span style="color:#3af">11</span>
<span style="color:#000">epochs</span> = <span style="color:#3af">100</span>

<span style="color:#000">model</span>.<span style="color:#000">compile</span>(<span style="color:#000">Adam</span>(), <span style="color:#000">loss</span>=<span style="color:#5a2">&#39;mean_absolute_error&#39;</span>)
<span style="color:#000">monitor</span> = <span style="color:#000">EarlyStopping</span>(<span style="color:#000">monitor</span>=<span style="color:#5a2">&#39;val_loss&#39;</span>, <span style="color:#000">min_delta</span>=<span style="color:#3af">1e-3</span>, <span style="color:#000">patience</span>=<span style="color:#3af">5</span>, <span style="color:#000">verbose</span>=<span style="color:#3af">1</span>, <span style="color:#000">mode</span>=<span style="color:#5a2">&#39;auto&#39;</span>)
<span style="color:#000">history</span> = <span style="color:#000">model</span>.<span style="color:#000">fit</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>,
                    <span style="color:#000">batch_size</span>=<span style="color:#000">batch_size</span>,
                    <span style="color:#000">callbacks</span>=[<span style="color:#000">monitor</span>],
                    <span style="color:#000">epochs</span>=<span style="color:#000">epochs</span>,
                    <span style="color:#000">validation_split</span>=<span style="color:#3af">0.2</span>)</code></pre></div>
<pre><code>Train on 8000 samples, validate on 2000 samples
Epoch 1/100
8000/8000 [==============================] - 7s 892us/step - loss: 0.2787 - val_loss: 0.2107
Epoch 2/100
8000/8000 [==============================] - 6s 766us/step - loss: 0.2331 - val_loss: 0.1863
Epoch 3/100
8000/8000 [==============================] - 6s 768us/step - loss: 0.2049 - val_loss: 0.1714
Epoch 4/100
8000/8000 [==============================] - 6s 769us/step - loss: 0.1878 - val_loss: 0.1557
Epoch 5/100
8000/8000 [==============================] - 6s 766us/step - loss: 0.1779 - val_loss: 0.1418
Epoch 6/100
8000/8000 [==============================] - 6s 768us/step - loss: 0.1678 - val_loss: 0.1366
Epoch 7/100
8000/8000 [==============================] - 6s 782us/step - loss: 0.1615 - val_loss: 0.1307
Epoch 8/100
8000/8000 [==============================] - 6s 781us/step - loss: 0.1564 - val_loss: 0.1286
Epoch 9/100
8000/8000 [==============================] - 6s 775us/step - loss: 0.1526 - val_loss: 0.1242
Epoch 10/100
8000/8000 [==============================] - 6s 776us/step - loss: 0.1494 - val_loss: 0.1239
Epoch 11/100
8000/8000 [==============================] - 6s 773us/step - loss: 0.1466 - val_loss: 0.1220
Epoch 12/100
8000/8000 [==============================] - 6s 773us/step - loss: 0.1439 - val_loss: 0.1209
Epoch 13/100
8000/8000 [==============================] - 6s 770us/step - loss: 0.1418 - val_loss: 0.1201
Epoch 14/100
8000/8000 [==============================] - 6s 775us/step - loss: 0.1401 - val_loss: 0.1184
Epoch 15/100
8000/8000 [==============================] - 6s 780us/step - loss: 0.1382 - val_loss: 0.1171
Epoch 16/100
8000/8000 [==============================] - 6s 783us/step - loss: 0.1367 - val_loss: 0.1162
Epoch 17/100
8000/8000 [==============================] - 6s 789us/step - loss: 0.1353 - val_loss: 0.1164
Epoch 18/100
8000/8000 [==============================] - 6s 782us/step - loss: 0.1339 - val_loss: 0.1166
Epoch 19/100
8000/8000 [==============================] - 6s 777us/step - loss: 0.1328 - val_loss: 0.1151
Epoch 20/100
8000/8000 [==============================] - 6s 785us/step - loss: 0.1316 - val_loss: 0.1138
Epoch 21/100
8000/8000 [==============================] - 6s 780us/step - loss: 0.1306 - val_loss: 0.1136
Epoch 22/100
8000/8000 [==============================] - 6s 776us/step - loss: 0.1300 - val_loss: 0.1130
Epoch 23/100
8000/8000 [==============================] - 6s 772us/step - loss: 0.1290 - val_loss: 0.1129
Epoch 24/100
8000/8000 [==============================] - 6s 772us/step - loss: 0.1281 - val_loss: 0.1123
Epoch 25/100
8000/8000 [==============================] - 6s 771us/step - loss: 0.1272 - val_loss: 0.1121
Epoch 26/100
8000/8000 [==============================] - 6s 778us/step - loss: 0.1267 - val_loss: 0.1116
Epoch 27/100
8000/8000 [==============================] - 6s 791us/step - loss: 0.1261 - val_loss: 0.1104
Epoch 28/100
8000/8000 [==============================] - 6s 790us/step - loss: 0.1254 - val_loss: 0.1100
Epoch 29/100
8000/8000 [==============================] - 6s 786us/step - loss: 0.1251 - val_loss: 0.1094
Epoch 30/100
8000/8000 [==============================] - 6s 779us/step - loss: 0.1244 - val_loss: 0.1098
Epoch 31/100
8000/8000 [==============================] - 6s 780us/step - loss: 0.1237 - val_loss: 0.1090
Epoch 32/100
8000/8000 [==============================] - 6s 779us/step - loss: 0.1230 - val_loss: 0.1087
Epoch 33/100
8000/8000 [==============================] - 6s 779us/step - loss: 0.1226 - val_loss: 0.1085
Epoch 34/100
8000/8000 [==============================] - 6s 771us/step - loss: 0.1221 - val_loss: 0.1080
Epoch 35/100
8000/8000 [==============================] - 6s 774us/step - loss: 0.1217 - val_loss: 0.1082
Epoch 36/100
8000/8000 [==============================] - 6s 776us/step - loss: 0.1212 - val_loss: 0.1076
Epoch 37/100
8000/8000 [==============================] - 6s 779us/step - loss: 0.1209 - val_loss: 0.1076
Epoch 38/100
8000/8000 [==============================] - 6s 773us/step - loss: 0.1203 - val_loss: 0.1076
Epoch 39/100
8000/8000 [==============================] - 6s 784us/step - loss: 0.1198 - val_loss: 0.1078
Epoch 00039: early stopping
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">model_name</span>=<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_3f_20181203_1651&#39;</span>

<span style="color:#888;font-style:italic"># serialize model to JSON</span>
<span style="color:#000">model_json</span> = <span style="color:#000">model</span>.<span style="color:#000">to_json</span>()
<span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.json&#34;</span>, <span style="color:#5a2">&#34;w&#34;</span>) <span style="color:#00f">as</span> <span style="color:#000">json_file</span>:
    <span style="color:#000">json_file</span>.<span style="color:#000">write</span>(<span style="color:#000">model_json</span>)
<span style="color:#888;font-style:italic"># serialize weights to HDF5</span>
<span style="color:#000">model</span>.<span style="color:#000">save_weights</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.h5&#34;</span>)
<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Saved {model_name} to disk&#34;</span>)</code></pre></div>
<pre><code>Saved model_3f_20181203_1651 to disk
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Bulding predictions from n feature model</span>

<span style="color:#00f">def</span> <span style="color:#000">predict_sequence_multi_f</span>(<span style="color:#000">input_sequence</span>, <span style="color:#000">model</span>, <span style="color:#000">dim</span>):

    <span style="color:#000">history_sequence</span> = <span style="color:#000">input_sequence</span>.<span style="color:#000">copy</span>()
    <span style="color:#000">pred_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">zeros</span>((<span style="color:#3af">1</span>,<span style="color:#000">pred_steps</span>,<span style="color:#000">dim</span>)) <span style="color:#888;font-style:italic"># initialize output (pred_steps time steps)  </span>

    <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">pred_steps</span>): <span style="color:#888;font-style:italic">#pred_steps=7 at beginning of code</span>
    
        <span style="color:#888;font-style:italic"># record next time step prediction (last time step of model output) </span>
        <span style="color:#000">last_step_pred</span> = <span style="color:#000">model</span>.<span style="color:#000">predict</span>(<span style="color:#000">history_sequence</span>)[<span style="color:#3af">0</span>,-<span style="color:#3af">1</span>,:]
        <span style="color:#000">pred_sequence</span>[<span style="color:#3af">0</span>,<span style="color:#000">i</span>,:] = <span style="color:#000">last_step_pred</span>

        <span style="color:#888;font-style:italic"># add the next time step prediction to the history sequence</span>
        <span style="color:#000">history_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">history_sequence</span>, 
                                           <span style="color:#000">last_step_pred</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>,<span style="color:#000">dim</span>)], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

    <span style="color:#00f">return</span> <span style="color:#000">pred_sequence</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">predict_and_plot_multi_f</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">sample_ind</span>, <span style="color:#000">mean_list</span>, <span style="color:#000">model</span>, <span style="color:#000">dim</span>, <span style="color:#000">enc_tail_len</span>=<span style="color:#3af">50</span>):
    
    <span style="color:#888;font-style:italic"># e.g. Cell ID 1 is 0 in df</span>
    <span style="color:#000">sample_ind</span> -= <span style="color:#3af">1</span>
    
    <span style="color:#000">encode_series</span> = <span style="color:#000">encoder_input_data</span>[<span style="color:#000">sample_ind</span>:<span style="color:#000">sample_ind</span>+<span style="color:#3af">1</span>,:,:] 
    <span style="color:#000">pred_series</span> = <span style="color:#000">predict_sequence_multi_f</span>(<span style="color:#000">encode_series</span>, <span style="color:#000">model</span>, <span style="color:#000">dim</span>)
    
    <span style="color:#888;font-style:italic"># Only use internet predictions for viz (col 0 --&gt; :1)</span>
    <span style="color:#000">encode_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">encode_series</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#000">dim</span>) + <span style="color:#000">mean_list</span>[<span style="color:#000">sample_ind</span>])[:,:<span style="color:#3af">1</span>]
    <span style="color:#000">pred_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">pred_series</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#000">dim</span>) + <span style="color:#000">mean_list</span>[<span style="color:#000">sample_ind</span>])[:,:<span style="color:#3af">1</span>]
    <span style="color:#000">target_series</span> = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">decoder_target_data</span>[<span style="color:#000">sample_ind</span>,:,:<span style="color:#000">dim</span>].<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#000">dim</span>) + <span style="color:#000">mean_list</span>[<span style="color:#000">sample_ind</span>])[:,:<span style="color:#3af">1</span>]

    <span style="color:#000">encode_series_tail</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encode_series</span>[-<span style="color:#000">enc_tail_len</span>:],<span style="color:#000">target_series</span>[:<span style="color:#3af">1</span>]])
    <span style="color:#000">x_encode</span> = <span style="color:#000">encode_series_tail</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]

    <span style="color:#000">plt</span>.<span style="color:#000">figure</span>(<span style="color:#000">figsize</span>=(<span style="color:#3af">10</span>,<span style="color:#3af">6</span>))   

    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#000">x_encode</span>+<span style="color:#3af">1</span>),<span style="color:#000">encode_series_tail</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#000">x_encode</span>,<span style="color:#000">x_encode</span>+<span style="color:#000">pred_steps</span>),<span style="color:#000">target_series</span>,<span style="color:#000">color</span>=<span style="color:#5a2">&#39;orange&#39;</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">plot</span>(<span style="color:#000">range</span>(<span style="color:#000">x_encode</span>,<span style="color:#000">x_encode</span>+<span style="color:#000">pred_steps</span>),<span style="color:#000">pred_series</span>,<span style="color:#000">color</span>=<span style="color:#5a2">&#39;teal&#39;</span>,<span style="color:#000">linestyle</span>=<span style="color:#5a2">&#39;--&#39;</span>)

    <span style="color:#000">plt</span>.<span style="color:#000">title</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;{dim} feature - Encoder Series Tail of Length {enc_tail_len}, Target Series, and Predictions&#39;</span>)
    <span style="color:#000">plt</span>.<span style="color:#000">legend</span>([<span style="color:#5a2">&#39;Encoding Series&#39;</span>,<span style="color:#5a2">&#39;Target Series&#39;</span>,<span style="color:#5a2">&#39;Predictions&#39;</span>])</code></pre></div>
<h4 id="main-function-3-features">Main function - 3 features</h4>

<p>This function uses internet, calls and sms traffic to predict future internet traffic</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">main_3</span>(<span style="color:#000">cell_id</span>):
    <span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    
    <span style="color:#888;font-style:italic">#import time</span>
    <span style="color:#888;font-style:italic">#timestr = time.strftime(&#34;%Y%m%d-%H%M%S&#34;)</span>
    
    <span style="color:#000">dim</span> = <span style="color:#3af">3</span> <span style="color:#888;font-style:italic"># nr. of features to use in the dataframe</span>
    
    
    <span style="color:#888;font-style:italic"># Main 3 feature model</span>
    <span style="color:#000">model_to_use</span> = <span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_3f_20181203_1651&#39;</span> <span style="color:#888;font-style:italic"># + timestr</span>
    
    <span style="color:#888;font-style:italic"># Import model</span>
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
    <span style="color:#000">model</span> = <span style="color:#000">import_model</span>(<span style="color:#000">model_to_use</span>)
    
    <span style="color:#888;font-style:italic"># Format and import data</span>
    <span style="color:#000">mean_list</span>=[]
    <span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">dim</span>)
    <span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;../01_Data/03_AWS outputs/keras_matrix_newscaling.dat&#34;</span>)
    <span style="color:#888;font-style:italic">#keras_matrix = create_keras_matrix(df_cdrs,dim)</span>
    
    <span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
    <span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

    <span style="color:#888;font-style:italic"># Generate encoder and decoder dataset</span>
    <span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                          :] <span style="color:#888;font-style:italic"># all features</span>
                         )

    <span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
    <span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                          :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                         )

    <span style="color:#888;font-style:italic"># Predict and plot</span>
    <span style="color:#000">predict_and_plot_multi_f</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">cell_id</span>, <span style="color:#000">mean_list</span>=<span style="color:#000">mean_list</span>, <span style="color:#000">model</span>=<span style="color:#000">model</span>, <span style="color:#000">dim</span>=<span style="color:#000">dim</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Duomo: 5060</span>
<span style="color:#888;font-style:italic"># Bocconi: 4259</span>
<span style="color:#888;font-style:italic"># Stadium: 5738</span>
<span style="color:#888;font-style:italic"># Train station: 6064</span>

<span style="color:#000">cell_id</span> = <span style="color:#3af">5060</span>

<span style="color:#000">main_1</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_3</span>(<span style="color:#000">cell_id</span>)</code></pre></div>
<pre><code>Loaded ../01_Data/03_AWS outputs/model_1f from disk
Loaded ../01_Data/03_AWS outputs/model_3f_20181203_1651 from disk
</code></pre>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_50_1.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_50_2.png" alt="png" /></p>

<hr />

<h3 id="10-adding-spatial-dimension-to-the-model">10. Adding spatial dimension to the model</h3>

<p>Adding spatial information by using the polar coordinate representation of the cell tower data.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">add_spatial</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">polar</span>=<span style="color:#000">True</span>):
    <span style="color:#00f">import</span> <span style="color:#000">geojson</span>
    <span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#5a2">&#39;../01_Data/milano-grid.geojson&#39;</span>) <span style="color:#00f">as</span> <span style="color:#000">json_file</span>:
        <span style="color:#000">json_data</span> = <span style="color:#000">geojson</span>.<span style="color:#000">load</span>(<span style="color:#000">json_file</span>)

    <span style="color:#000">lon</span>=[<span style="color:#000">json_data</span>.<span style="color:#000">features</span>[<span style="color:#000">i</span>][<span style="color:#5a2">&#39;geometry&#39;</span>][<span style="color:#5a2">&#39;coordinates&#39;</span>][<span style="color:#3af">0</span>][<span style="color:#3af">0</span>][<span style="color:#3af">0</span>] <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">0</span>,<span style="color:#3af">10000</span>)]
    <span style="color:#000">lat</span>=[<span style="color:#000">json_data</span>.<span style="color:#000">features</span>[<span style="color:#000">i</span>][<span style="color:#5a2">&#39;geometry&#39;</span>][<span style="color:#5a2">&#39;coordinates&#39;</span>][<span style="color:#3af">0</span>][<span style="color:#3af">0</span>][<span style="color:#3af">1</span>] <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">0</span>,<span style="color:#3af">10000</span>)]
    
    <span style="color:#00f">if</span> <span style="color:#000">polar</span>:
        <span style="color:#00f">import</span> <span style="color:#000">cmath</span>
        <span style="color:#000">polar_c</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>([<span style="color:#000">cmath</span>.<span style="color:#000">polar</span>(<span style="color:#000">complex</span>(<span style="color:#000">lon</span>[<span style="color:#000">i</span>],<span style="color:#000">lat</span>[<span style="color:#000">i</span>])) <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">len</span>(<span style="color:#000">lon</span>))],<span style="color:#000">columns</span>=[<span style="color:#5a2">&#39;Dist&#39;</span>,<span style="color:#5a2">&#39;Angle&#39;</span>])
        <span style="color:#000">polar_c</span>.<span style="color:#000">index</span> = <span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#000">len</span>(<span style="color:#000">lon</span>)+<span style="color:#3af">1</span>)

        <span style="color:#000">df_spatial</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">merge</span>(<span style="color:#000">polar_c</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>,<span style="color:#000">left_on</span>=<span style="color:#5a2">&#39;CellID&#39;</span>,<span style="color:#000">right_index</span>=<span style="color:#000">True</span>)
        <span style="color:#00f">return</span> <span style="color:#000">df_spatial</span>
    
    <span style="color:#00f">else</span>:
        <span style="color:#000">cartesian_c</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">list</span>(<span style="color:#000">zip</span>(<span style="color:#000">lon</span>,<span style="color:#000">lat</span>)),<span style="color:#000">columns</span>=[<span style="color:#5a2">&#39;Lon&#39;</span>,<span style="color:#5a2">&#39;Lat&#39;</span>])
        <span style="color:#000">cartesian_c</span>.<span style="color:#000">index</span> = <span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#000">len</span>(<span style="color:#000">lon</span>)+<span style="color:#3af">1</span>)
        <span style="color:#000">df_spatial</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">merge</span>(<span style="color:#000">cartesian_c</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>,<span style="color:#000">left_on</span>=<span style="color:#5a2">&#39;CellID&#39;</span>,<span style="color:#000">right_index</span>=<span style="color:#000">True</span>)
        <span style="color:#00f">return</span> <span style="color:#000">df_spatial</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_spatial</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>calls</th>
      <th>sms</th>
      <th>Dist</th>
      <th>Angle</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>1.021221</td>
      <td>3.189034</td>
      <td>46.245301</td>
      <td>1.374679</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>1.040205</td>
      <td>3.179480</td>
      <td>46.245885</td>
      <td>1.374615</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>1.060412</td>
      <td>3.169311</td>
      <td>46.246470</td>
      <td>1.374551</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>0.966233</td>
      <td>3.216705</td>
      <td>46.247054</td>
      <td>1.374488</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>0.884973</td>
      <td>2.914617</td>
      <td>46.247639</td>
      <td>1.374424</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Re-scaling the data</span>

<span style="color:#000">dim</span> = <span style="color:#3af">5</span>
<span style="color:#000">mean_list</span>=[]
<span style="color:#000">df_spatial</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_spatial</span>, <span style="color:#000">dim</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_spatial</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>calls</th>
      <th>sms</th>
      <th>Dist</th>
      <th>Angle</th>
      <th>internet_scaled</th>
      <th>calls_scaled</th>
      <th>sms_scaled</th>
      <th>Dist_scaled</th>
      <th>Angle_scaled</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>1.021221</td>
      <td>3.189034</td>
      <td>46.245301</td>
      <td>1.374679</td>
      <td>-0.477102</td>
      <td>-1.855503</td>
      <td>-1.144778</td>
      <td>-3.552714e-15</td>
      <td>-2.220446e-16</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>1.040205</td>
      <td>3.179480</td>
      <td>46.245885</td>
      <td>1.374615</td>
      <td>-0.479278</td>
      <td>-1.860002</td>
      <td>-1.160078</td>
      <td>-1.776357e-15</td>
      <td>2.220446e-16</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>1.060412</td>
      <td>3.169311</td>
      <td>46.246470</td>
      <td>1.374551</td>
      <td>-0.481585</td>
      <td>-1.864703</td>
      <td>-1.176392</td>
      <td>3.552714e-15</td>
      <td>6.661338e-16</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>0.966233</td>
      <td>3.216705</td>
      <td>46.247054</td>
      <td>1.374488</td>
      <td>-0.470914</td>
      <td>-1.841838</td>
      <td>-1.099484</td>
      <td>1.776357e-15</td>
      <td>7.771561e-16</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>0.884973</td>
      <td>2.914617</td>
      <td>46.247639</td>
      <td>1.374424</td>
      <td>-0.468362</td>
      <td>-1.819482</td>
      <td>-1.106134</td>
      <td>3.108624e-15</td>
      <td>4.440892e-16</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Re-formatting for KERAS friendly shape</span>

<span style="color:#000">keras_matrix</span> = <span style="color:#000">create_keras_matrix</span>(<span style="color:#000">df_spatial</span>,<span style="color:#000">dim</span>)
<span style="color:#000">keras_matrix</span>.<span style="color:#000">shape</span></code></pre></div>
<pre><code>(10000, 63, 5)
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Extracting training data</span>

<span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
<span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

<span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )
<span style="color:#888;font-style:italic"># we append a lagged history of the target series to the input data, </span>
<span style="color:#888;font-style:italic"># so that we can train with teacher forcing</span>
<span style="color:#000">lagged_target_history</span> = <span style="color:#000">decoder_target_data</span>[:,:-<span style="color:#3af">1</span>,:]
<span style="color:#000">encoder_input_data</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encoder_input_data</span>, <span style="color:#000">lagged_target_history</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Building wavenet model for 5 feature prediction</span>

<span style="color:#00f">from</span> <span style="color:#000">keras.models</span> <span style="color:#00f">import</span> <span style="color:#000">Model</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.layers</span> <span style="color:#00f">import</span> <span style="color:#000">Input</span>, <span style="color:#000">Conv1D</span>, <span style="color:#000">Dense</span>, <span style="color:#000">Dropout</span>, <span style="color:#000">Lambda</span>, <span style="color:#000">concatenate</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.optimizers</span> <span style="color:#00f">import</span> <span style="color:#000">Adam</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.callbacks</span> <span style="color:#00f">import</span> <span style="color:#000">EarlyStopping</span>

<span style="color:#888;font-style:italic"># convolutional layer parameters</span>
<span style="color:#000">n_filters</span> = <span style="color:#3af">32</span> 
<span style="color:#000">filter_width</span> = <span style="color:#3af">2</span>
<span style="color:#000">dilation_rates</span> = [<span style="color:#3af">2</span>**<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">8</span>)] 

<span style="color:#888;font-style:italic"># define an input history series and pass it through a stack of dilated causal convolutions. </span>
<span style="color:#000">history_seq</span> = <span style="color:#000">Input</span>(<span style="color:#000">shape</span>=(<span style="color:#000">None</span>, <span style="color:#000">dim</span>))
<span style="color:#000">x</span> = <span style="color:#000">history_seq</span>

<span style="color:#00f">for</span> <span style="color:#000">dilation_rate</span> <span style="color:#00f">in</span> <span style="color:#000">dilation_rates</span>:
    <span style="color:#000">x</span> = <span style="color:#000">Conv1D</span>(<span style="color:#000">filters</span>=<span style="color:#000">n_filters</span>,
               <span style="color:#000">kernel_size</span>=<span style="color:#000">filter_width</span>, 
               <span style="color:#000">padding</span>=<span style="color:#5a2">&#39;causal&#39;</span>,
               <span style="color:#000">dilation_rate</span>=<span style="color:#000">dilation_rate</span>)(<span style="color:#000">x</span>)

<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">128</span>, <span style="color:#000">activation</span>=<span style="color:#5a2">&#39;relu&#39;</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dropout</span>(.<span style="color:#3af">2</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#000">dim</span>)(<span style="color:#000">x</span>)

<span style="color:#888;font-style:italic"># extract the last 7 time steps as the training target</span>
<span style="color:#00f">def</span> <span style="color:#000">slice</span>(<span style="color:#000">x</span>, <span style="color:#000">seq_length</span>):
    <span style="color:#00f">return</span> <span style="color:#000">x</span>[:,-<span style="color:#000">seq_length</span>:,:]

<span style="color:#000">pred_seq_train</span> = <span style="color:#000">Lambda</span>(<span style="color:#000">slice</span>, <span style="color:#000">arguments</span>={<span style="color:#5a2">&#39;seq_length&#39;</span>:<span style="color:#000">pred_steps</span>})(<span style="color:#000">x</span>)

<span style="color:#000">model</span> = <span style="color:#000">Model</span>(<span style="color:#000">history_seq</span>, <span style="color:#000">pred_seq_train</span>)
<span style="color:#000">model</span>.<span style="color:#000">summary</span>()

<span style="color:#888;font-style:italic"># Fit the model on the training data</span>

<span style="color:#000">batch_size</span> = <span style="color:#3af">2</span>**<span style="color:#3af">11</span>
<span style="color:#000">epochs</span> = <span style="color:#3af">100</span>

<span style="color:#000">model</span>.<span style="color:#000">compile</span>(<span style="color:#000">Adam</span>(), <span style="color:#000">loss</span>=<span style="color:#5a2">&#39;mean_absolute_error&#39;</span>)
<span style="color:#000">monitor</span> = <span style="color:#000">EarlyStopping</span>(<span style="color:#000">monitor</span>=<span style="color:#5a2">&#39;val_loss&#39;</span>, <span style="color:#000">min_delta</span>=<span style="color:#3af">1e-3</span>, <span style="color:#000">patience</span>=<span style="color:#3af">5</span>, <span style="color:#000">verbose</span>=<span style="color:#3af">1</span>, <span style="color:#000">mode</span>=<span style="color:#5a2">&#39;auto&#39;</span>)
<span style="color:#000">history</span> = <span style="color:#000">model</span>.<span style="color:#000">fit</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>,
                    <span style="color:#000">batch_size</span>=<span style="color:#000">batch_size</span>,
                    <span style="color:#000">callbacks</span>=[<span style="color:#000">monitor</span>],
                    <span style="color:#000">epochs</span>=<span style="color:#000">epochs</span>,
                    <span style="color:#000">validation_split</span>=<span style="color:#3af">0.2</span>)</code></pre></div>
<pre><code>Train on 8000 samples, validate on 2000 samples
Epoch 1/100
8000/8000 [==============================] - 16s 2ms/step - loss: 0.1785 - val_loss: 0.1411
Epoch 2/100
8000/8000 [==============================] - 15s 2ms/step - loss: 0.1610 - val_loss: 0.1305
Epoch 3/100
8000/8000 [==============================] - 14s 2ms/step - loss: 0.1467 - val_loss: 0.1187
Epoch 4/100
8000/8000 [==============================] - 12s 2ms/step - loss: 0.1329 - val_loss: 0.1070
Epoch 5/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.1242 - val_loss: 0.1012
Epoch 6/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.1180 - val_loss: 0.0973
Epoch 7/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.1126 - val_loss: 0.0921
Epoch 8/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.1072 - val_loss: 0.0854
Epoch 9/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.1027 - val_loss: 0.0808
Epoch 10/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0993 - val_loss: 0.0776
Epoch 11/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0972 - val_loss: 0.0773
Epoch 12/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0949 - val_loss: 0.0763
Epoch 13/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0934 - val_loss: 0.0751
Epoch 14/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0921 - val_loss: 0.0743
Epoch 15/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0907 - val_loss: 0.0731
Epoch 16/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0897 - val_loss: 0.0728
Epoch 17/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0886 - val_loss: 0.0723
Epoch 18/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0876 - val_loss: 0.0718
Epoch 19/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0867 - val_loss: 0.0710
Epoch 20/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0858 - val_loss: 0.0707
Epoch 21/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0853 - val_loss: 0.0703
Epoch 22/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0847 - val_loss: 0.0701
Epoch 23/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0840 - val_loss: 0.0696
Epoch 24/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0833 - val_loss: 0.0699
Epoch 25/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0827 - val_loss: 0.0698
Epoch 26/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0822 - val_loss: 0.0701
Epoch 27/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0817 - val_loss: 0.0697
Epoch 28/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0812 - val_loss: 0.0695
Epoch 00028: early stopping
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">model_name</span>=<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_5f_20181204_1142&#39;</span>

<span style="color:#888;font-style:italic"># serialize model to JSON</span>
<span style="color:#000">model_json</span> = <span style="color:#000">model</span>.<span style="color:#000">to_json</span>()
<span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.json&#34;</span>, <span style="color:#5a2">&#34;w&#34;</span>) <span style="color:#00f">as</span> <span style="color:#000">json_file</span>:
    <span style="color:#000">json_file</span>.<span style="color:#000">write</span>(<span style="color:#000">model_json</span>)
<span style="color:#888;font-style:italic"># serialize weights to HDF5</span>
<span style="color:#000">model</span>.<span style="color:#000">save_weights</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.h5&#34;</span>)
<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Saved {model_name} to disk&#34;</span>)</code></pre></div>
<pre><code>Saved ../01_Data/03_AWS outputs/model_5f_20181204_1142 to disk
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Generate encoder and decoder dataset for the validation data</span>

<span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )

<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Generated inputs for {val_enc_start.strftime(&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;)} - {val_enc_end.strftime(&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;)} for predictions&#34;</span>)</code></pre></div>
<pre><code>Generated inputs for 2013-11-07 - 2013-12-25 for predictions
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Predict and plot</span>

<span style="color:#000">predict_and_plot_multi_f</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#3af">5060</span>, <span style="color:#000">mean_list</span>=<span style="color:#000">mean_list</span>, <span style="color:#000">model</span>=<span style="color:#000">model</span>, <span style="color:#000">dim</span>=<span style="color:#000">dim</span>)</code></pre></div>
<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_61_0.png" alt="png" /></p>

<h4 id="main-function-5-features">Main function - 5 features</h4>

<p>This function uses internet, calls and sms traffic, as well as spatial (polar) coordinates to predict future internet traffic</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">main_5</span>(<span style="color:#000">cell_id</span>):
    <span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    
    <span style="color:#000">dim</span> = <span style="color:#3af">5</span> <span style="color:#888;font-style:italic"># nr. of features to use in the dataframe</span>
    
    
    <span style="color:#888;font-style:italic"># Main 3 feature model</span>
    <span style="color:#000">model_to_use</span> = <span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_5f_20181204_1142&#39;</span> <span style="color:#888;font-style:italic"># + timestr</span>
    <span style="color:#000">model</span> = <span style="color:#000">import_model</span>(<span style="color:#000">model_to_use</span>)
    
    <span style="color:#888;font-style:italic"># Import model</span>
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">add_spatial</span>(<span style="color:#000">df_cdrs</span>)
    
    <span style="color:#888;font-style:italic"># Format and import data</span>
    <span style="color:#000">mean_list</span>=[]
    <span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">dim</span>)
    <span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;../02_Notebooks/keras_matrix_featurenr_5.dat&#34;</span>)
    <span style="color:#888;font-style:italic">#keras_matrix = create_keras_matrix(df_cdrs,dim)</span>
    
    <span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
    <span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

    <span style="color:#888;font-style:italic"># Generate encoder and decoder dataset</span>
    <span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                          :] <span style="color:#888;font-style:italic"># all features</span>
                         )

    <span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
    <span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                          :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                         )

    <span style="color:#888;font-style:italic"># Predict and plot</span>
    <span style="color:#000">predict_and_plot_multi_f</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">cell_id</span>, <span style="color:#000">mean_list</span>=<span style="color:#000">mean_list</span>, <span style="color:#000">model</span>=<span style="color:#000">model</span>, <span style="color:#000">dim</span>=<span style="color:#000">dim</span>)</code></pre></div>
<h4 id="11-reformatted-spatial-model">11. Reformatted spatial model</h4>

<p>Using internet as the only non-spatial feature and using K-Means clustering to extract more consize spatial information from the coordinates</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
<span style="color:#000">df_cdrs</span> = <span style="color:#000">add_spatial</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">polar</span>=<span style="color:#000">False</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">del</span> <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;calls&#39;</span>]
<span style="color:#00f">del</span> <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;sms&#39;</span>]
<span style="color:#000">df_cdrs</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>Lon</th>
      <th>Lat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>9.011491</td>
      <td>45.358801</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>9.014491</td>
      <td>45.358801</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>9.017492</td>
      <td>45.358801</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>9.020492</td>
      <td>45.358800</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>9.023493</td>
      <td>45.358799</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">scipy.cluster.vq</span> <span style="color:#00f">import</span> <span style="color:#000">kmeans</span>,<span style="color:#000">vq</span>
<span style="color:#00f">from</span> <span style="color:#000">scipy.spatial.distance</span> <span style="color:#00f">import</span> <span style="color:#000">cdist</span>

<span style="color:#888;font-style:italic">##### cluster data into K=1..10 clusters #####</span>
<span style="color:#888;font-style:italic">#K, KM, centroids,D_k,cIdx,dist,avgWithinSS = kmeans.run_kmeans(X,10)</span>

<span style="color:#000">K</span> = <span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#3af">10</span>)
<span style="color:#000">X</span> = <span style="color:#000">df_cdrs</span>[[<span style="color:#5a2">&#39;Lon&#39;</span>,<span style="color:#5a2">&#39;Lat&#39;</span>]].<span style="color:#000">values</span>

  <span style="color:#888;font-style:italic"># scipy.cluster.vq.kmeans</span>
<span style="color:#000">KM</span> = [<span style="color:#000">kmeans</span>(<span style="color:#000">X</span>,<span style="color:#000">k</span>) <span style="color:#00f">for</span> <span style="color:#000">k</span> <span style="color:#00f">in</span> <span style="color:#000">K</span>] <span style="color:#888;font-style:italic"># apply kmeans 1 to 10</span>
<span style="color:#000">centroids</span> = [<span style="color:#000">cent</span> <span style="color:#00f">for</span> (<span style="color:#000">cent</span>,<span style="color:#000">var</span>) <span style="color:#00f">in</span> <span style="color:#000">KM</span>]   <span style="color:#888;font-style:italic"># cluster centroids</span>

<span style="color:#000">D_k</span> = [<span style="color:#000">cdist</span>(<span style="color:#000">X</span>, <span style="color:#000">cent</span>, <span style="color:#5a2">&#39;euclidean&#39;</span>) <span style="color:#00f">for</span> <span style="color:#000">cent</span> <span style="color:#00f">in</span> <span style="color:#000">centroids</span>]

<span style="color:#000">cIdx</span> = [<span style="color:#000">np</span>.<span style="color:#000">argmin</span>(<span style="color:#000">D</span>,<span style="color:#000">axis</span>=<span style="color:#3af">1</span>) <span style="color:#00f">for</span> <span style="color:#000">D</span> <span style="color:#00f">in</span> <span style="color:#000">D_k</span>]
<span style="color:#000">dist</span> = [<span style="color:#000">np</span>.<span style="color:#000">min</span>(<span style="color:#000">D</span>,<span style="color:#000">axis</span>=<span style="color:#3af">1</span>) <span style="color:#00f">for</span> <span style="color:#000">D</span> <span style="color:#00f">in</span> <span style="color:#000">D_k</span>]
<span style="color:#000">avgWithinSS</span> = [<span style="color:#000">sum</span>(<span style="color:#000">d</span>)/<span style="color:#000">X</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>] <span style="color:#00f">for</span> <span style="color:#000">d</span> <span style="color:#00f">in</span> <span style="color:#000">dist</span>] </code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">kIdx</span> = <span style="color:#3af">6</span>
<span style="color:#888;font-style:italic"># plot elbow curve</span>
<span style="color:#000">fig</span> = <span style="color:#000">plt</span>.<span style="color:#000">figure</span>()
<span style="color:#000">ax</span> = <span style="color:#000">fig</span>.<span style="color:#000">add_subplot</span>(<span style="color:#3af">111</span>)
<span style="color:#000">ax</span>.<span style="color:#000">plot</span>(<span style="color:#000">K</span>, <span style="color:#000">avgWithinSS</span>, <span style="color:#5a2">&#39;b*-&#39;</span>)
<span style="color:#000">ax</span>.<span style="color:#000">plot</span>(<span style="color:#000">K</span>[<span style="color:#000">kIdx</span>], <span style="color:#000">avgWithinSS</span>[<span style="color:#000">kIdx</span>], <span style="color:#000">marker</span>=<span style="color:#5a2">&#39;o&#39;</span>, <span style="color:#000">markersize</span>=<span style="color:#3af">12</span>, 
      <span style="color:#000">markeredgewidth</span>=<span style="color:#3af">2</span>, <span style="color:#000">markeredgecolor</span>=<span style="color:#5a2">&#39;r&#39;</span>, <span style="color:#000">markerfacecolor</span>=<span style="color:#5a2">&#39;None&#39;</span>)
<span style="color:#000">plt</span>.<span style="color:#000">grid</span>(<span style="color:#000">True</span>)
<span style="color:#000">plt</span>.<span style="color:#000">xlabel</span>(<span style="color:#5a2">&#39;Number of clusters&#39;</span>)
<span style="color:#000">plt</span>.<span style="color:#000">ylabel</span>(<span style="color:#5a2">&#39;Average within-cluster sum of squares&#39;</span>)
<span style="color:#000">tt</span> = <span style="color:#000">plt</span>.<span style="color:#000">title</span>(<span style="color:#5a2">&#39;Elbow for K-Means clustering&#39;</span>)  </code></pre></div>
<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_68_0.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">sklearn.cluster</span> <span style="color:#00f">import</span> <span style="color:#000">KMeans</span>
<span style="color:#000">km</span> = <span style="color:#000">KMeans</span>(<span style="color:#000">kIdx</span>, <span style="color:#000">init</span>=<span style="color:#5a2">&#39;k-means++&#39;</span>) <span style="color:#888;font-style:italic"># initialize</span>
<span style="color:#000">km</span>.<span style="color:#000">fit</span>(<span style="color:#000">X</span>)
<span style="color:#000">c</span> = <span style="color:#000">km</span>.<span style="color:#000">predict</span>(<span style="color:#000">X</span>) <span style="color:#888;font-style:italic"># classify into three clusters</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">c</span></code></pre></div>
<pre><code>array([2, 2, 2, ..., 1, 1, 1], dtype=int32)
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">km</span>.<span style="color:#000">cluster_centers_</span></code></pre></div>
<pre><code>array([[ 9.15837568, 45.41039273],
       [ 9.26125249, 45.51608858],
       [ 9.05955248, 45.4106078 ],
       [ 9.06116834, 45.51637073],
       [ 9.16225903, 45.51616683],
       [ 9.25926288, 45.41032886]])
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;Zone&#39;</span>] = <span style="color:#000">c</span>
<span style="color:#00f">del</span> <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;Lon&#39;</span>]
<span style="color:#00f">del</span> <span style="color:#000">df_cdrs</span>[<span style="color:#5a2">&#39;Lat&#39;</span>]
<span style="color:#000">df_cdrs</span>.<span style="color:#000">head</span>()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>CellID</th>
      <th>internet</th>
      <th>internet_scaled</th>
      <th>Zone</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2013-10-31</td>
      <td>1</td>
      <td>57.799009</td>
      <td>-0.477102</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013-10-31</td>
      <td>2</td>
      <td>57.914858</td>
      <td>-0.479278</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2013-10-31</td>
      <td>3</td>
      <td>58.038173</td>
      <td>-0.481585</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2013-10-31</td>
      <td>4</td>
      <td>57.463453</td>
      <td>-0.470914</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2013-10-31</td>
      <td>5</td>
      <td>52.171423</td>
      <td>-0.468362</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">dim</span> = <span style="color:#3af">2</span>
<span style="color:#000">mean_list</span>=[]
<span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">dim</span>)
<span style="color:#000">keras_matrix</span> = <span style="color:#000">create_keras_matrix</span>(<span style="color:#000">df_cdrs</span>,<span style="color:#000">dim</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Extracting training data</span>

<span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
<span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

<span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">train_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )
<span style="color:#888;font-style:italic"># we append a lagged history of the target series to the input data, </span>
<span style="color:#888;font-style:italic"># so that we can train with teacher forcing</span>
<span style="color:#000">lagged_target_history</span> = <span style="color:#000">decoder_target_data</span>[:,:-<span style="color:#3af">1</span>,:]
<span style="color:#000">encoder_input_data</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">encoder_input_data</span>, <span style="color:#000">lagged_target_history</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Building wavenet model for 5 feature prediction</span>

<span style="color:#00f">from</span> <span style="color:#000">keras.models</span> <span style="color:#00f">import</span> <span style="color:#000">Model</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.layers</span> <span style="color:#00f">import</span> <span style="color:#000">Input</span>, <span style="color:#000">Conv1D</span>, <span style="color:#000">Dense</span>, <span style="color:#000">Dropout</span>, <span style="color:#000">Lambda</span>, <span style="color:#000">concatenate</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.optimizers</span> <span style="color:#00f">import</span> <span style="color:#000">Adam</span>
<span style="color:#00f">from</span> <span style="color:#000">keras.callbacks</span> <span style="color:#00f">import</span> <span style="color:#000">EarlyStopping</span>

<span style="color:#888;font-style:italic"># convolutional layer parameters</span>
<span style="color:#000">n_filters</span> = <span style="color:#3af">32</span> 
<span style="color:#000">filter_width</span> = <span style="color:#3af">2</span>
<span style="color:#000">dilation_rates</span> = [<span style="color:#3af">2</span>**<span style="color:#000">i</span> <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">8</span>)] 

<span style="color:#888;font-style:italic"># define an input history series and pass it through a stack of dilated causal convolutions. </span>
<span style="color:#000">history_seq</span> = <span style="color:#000">Input</span>(<span style="color:#000">shape</span>=(<span style="color:#000">None</span>, <span style="color:#000">dim</span>))
<span style="color:#000">x</span> = <span style="color:#000">history_seq</span>

<span style="color:#00f">for</span> <span style="color:#000">dilation_rate</span> <span style="color:#00f">in</span> <span style="color:#000">dilation_rates</span>:
    <span style="color:#000">x</span> = <span style="color:#000">Conv1D</span>(<span style="color:#000">filters</span>=<span style="color:#000">n_filters</span>,
               <span style="color:#000">kernel_size</span>=<span style="color:#000">filter_width</span>, 
               <span style="color:#000">padding</span>=<span style="color:#5a2">&#39;causal&#39;</span>,
               <span style="color:#000">dilation_rate</span>=<span style="color:#000">dilation_rate</span>)(<span style="color:#000">x</span>)

<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#3af">128</span>, <span style="color:#000">activation</span>=<span style="color:#5a2">&#39;relu&#39;</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dropout</span>(.<span style="color:#3af">2</span>)(<span style="color:#000">x</span>)
<span style="color:#000">x</span> = <span style="color:#000">Dense</span>(<span style="color:#000">dim</span>)(<span style="color:#000">x</span>)

<span style="color:#888;font-style:italic"># extract the last 7 time steps as the training target</span>
<span style="color:#00f">def</span> <span style="color:#000">slice</span>(<span style="color:#000">x</span>, <span style="color:#000">seq_length</span>):
    <span style="color:#00f">return</span> <span style="color:#000">x</span>[:,-<span style="color:#000">seq_length</span>:,:]

<span style="color:#000">pred_seq_train</span> = <span style="color:#000">Lambda</span>(<span style="color:#000">slice</span>, <span style="color:#000">arguments</span>={<span style="color:#5a2">&#39;seq_length&#39;</span>:<span style="color:#000">pred_steps</span>})(<span style="color:#000">x</span>)

<span style="color:#000">model</span> = <span style="color:#000">Model</span>(<span style="color:#000">history_seq</span>, <span style="color:#000">pred_seq_train</span>)
<span style="color:#000">model</span>.<span style="color:#000">summary</span>()

<span style="color:#888;font-style:italic"># Fit the model on the training data</span>

<span style="color:#000">batch_size</span> = <span style="color:#3af">2</span>**<span style="color:#3af">11</span>
<span style="color:#000">epochs</span> = <span style="color:#3af">100</span>

<span style="color:#000">model</span>.<span style="color:#000">compile</span>(<span style="color:#000">Adam</span>(), <span style="color:#000">loss</span>=<span style="color:#5a2">&#39;mean_absolute_error&#39;</span>)
<span style="color:#000">monitor</span> = <span style="color:#000">EarlyStopping</span>(<span style="color:#000">monitor</span>=<span style="color:#5a2">&#39;val_loss&#39;</span>, <span style="color:#000">min_delta</span>=<span style="color:#3af">1e-3</span>, <span style="color:#000">patience</span>=<span style="color:#3af">5</span>, <span style="color:#000">verbose</span>=<span style="color:#3af">1</span>, <span style="color:#000">mode</span>=<span style="color:#5a2">&#39;auto&#39;</span>)
<span style="color:#000">history</span> = <span style="color:#000">model</span>.<span style="color:#000">fit</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>,
                    <span style="color:#000">batch_size</span>=<span style="color:#000">batch_size</span>,
                    <span style="color:#000">callbacks</span>=[<span style="color:#000">monitor</span>],
                    <span style="color:#000">epochs</span>=<span style="color:#000">epochs</span>,
                    <span style="color:#000">validation_split</span>=<span style="color:#3af">0.2</span>)</code></pre></div>
<pre><code>_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         (None, None, 2)           0         
_________________________________________________________________
conv1d_9 (Conv1D)            (None, None, 32)          160       
_________________________________________________________________
conv1d_10 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_11 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_12 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_13 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_14 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_15 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
conv1d_16 (Conv1D)           (None, None, 32)          2080      
_________________________________________________________________
dense_3 (Dense)              (None, None, 128)         4224      
_________________________________________________________________
dropout_2 (Dropout)          (None, None, 128)         0         
_________________________________________________________________
dense_4 (Dense)              (None, None, 2)           258       
_________________________________________________________________
lambda_2 (Lambda)            (None, None, 2)           0         
=================================================================
Total params: 19,202
Trainable params: 19,202
Non-trainable params: 0
_________________________________________________________________
Train on 8000 samples, validate on 2000 samples
Epoch 1/100
8000/8000 [==============================] - 16s 2ms/step - loss: 0.1256 - val_loss: 0.0687
Epoch 2/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.1076 - val_loss: 0.0709
Epoch 3/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0965 - val_loss: 0.0577
Epoch 4/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0854 - val_loss: 0.0524
Epoch 5/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0787 - val_loss: 0.0560
Epoch 6/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0755 - val_loss: 0.0517
Epoch 7/100
8000/8000 [==============================] - 11s 1ms/step - loss: 0.0725 - val_loss: 0.0511
Epoch 8/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0707 - val_loss: 0.0498
Epoch 9/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0686 - val_loss: 0.0499
Epoch 10/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0674 - val_loss: 0.0486
Epoch 11/100
8000/8000 [==============================] - 10s 1ms/step - loss: 0.0665 - val_loss: 0.0485
Epoch 12/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0658 - val_loss: 0.0491
Epoch 13/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0650 - val_loss: 0.0485
Epoch 14/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0646 - val_loss: 0.0480
Epoch 15/100
8000/8000 [==============================] - 9s 1ms/step - loss: 0.0642 - val_loss: 0.0482
Epoch 00015: early stopping
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">model_name</span>=<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135&#39;</span>

<span style="color:#888;font-style:italic"># serialize model to JSON</span>
<span style="color:#000">model_json</span> = <span style="color:#000">model</span>.<span style="color:#000">to_json</span>()
<span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.json&#34;</span>, <span style="color:#5a2">&#34;w&#34;</span>) <span style="color:#00f">as</span> <span style="color:#000">json_file</span>:
    <span style="color:#000">json_file</span>.<span style="color:#000">write</span>(<span style="color:#000">model_json</span>)
<span style="color:#888;font-style:italic"># serialize weights to HDF5</span>
<span style="color:#000">model</span>.<span style="color:#000">save_weights</span>(<span style="color:#000">model_name</span>+<span style="color:#5a2">&#34;.h5&#34;</span>)
<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#34;Saved {model_name} to disk&#34;</span>)</code></pre></div>
<pre><code>Saved ../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135 to disk
</code></pre>

<h4 id="main-function-2-feature-internet-location-cluster">Main function - 2 feature (internet &amp; location cluster)</h4>

<p>This function uses internet traffic and cell location information (as 7 clusters) to predict future internet traffic</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">main_2_internet_zoned</span>(<span style="color:#000">cell_id</span>):
    <span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    
    <span style="color:#000">dim</span> = <span style="color:#3af">2</span> <span style="color:#888;font-style:italic"># nr. of features to use in the dataframe</span>
    
    
    <span style="color:#888;font-style:italic"># Main 3 feature model</span>
    <span style="color:#000">model_to_use</span> = <span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135&#39;</span>
    <span style="color:#000">model</span> = <span style="color:#000">import_model</span>(<span style="color:#000">model_to_use</span>)
    
    <span style="color:#888;font-style:italic"># Import model</span>
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
    <span style="color:#000">df_cdrs</span> = <span style="color:#000">add_spatial</span>(<span style="color:#000">df_cdrs</span>)
    
    <span style="color:#888;font-style:italic"># Format and import data</span>
    <span style="color:#000">mean_list</span>=[]
    <span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">dim</span>)
    <span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;../02_Notebooks/keras_matrix_internet+zones_featurenr_2.dat&#34;</span>)
    <span style="color:#888;font-style:italic">#keras_matrix = create_keras_matrix(df_cdrs,dim)</span>
    
    <span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
    <span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

    <span style="color:#888;font-style:italic"># Generate encoder and decoder dataset</span>
    <span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                          :] <span style="color:#888;font-style:italic"># all features</span>
                         )

    <span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
    <span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                          [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                          <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                           <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                          :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                         )

    <span style="color:#888;font-style:italic"># Predict and plot</span>
    <span style="color:#000">predict_and_plot_multi_f</span>(<span style="color:#000">encoder_input_data</span>, <span style="color:#000">decoder_target_data</span>, <span style="color:#000">cell_id</span>, <span style="color:#000">mean_list</span>=<span style="color:#000">mean_list</span>, <span style="color:#000">model</span>=<span style="color:#000">model</span>, <span style="color:#000">dim</span>=<span style="color:#000">dim</span>)</code></pre></div>
<hr />

<h3 id="12-results-for-selected-regions">12. Results for selected regions</h3>

<p>Below some results are to be found from key areas in Milan, showing the performance of the various models</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Main square: 6169</span>

<span style="color:#000">cell_id</span> = <span style="color:#3af">6169</span>

<span style="color:#000">main_1</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_3</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_5</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_2_internet_zoned</span>(<span style="color:#000">cell_id</span>)</code></pre></div>
<pre><code>Loaded ../01_Data/03_AWS outputs/model_1f from disk
Loaded ../01_Data/03_AWS outputs/model_3f_20181203_1651 from disk
Loaded ../01_Data/03_AWS outputs/model_5f_20181204_1142 from disk
Loaded ../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135 from disk
</code></pre>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_80_1.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_80_2.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_80_3.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_80_4.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Train station: 6064</span>

<span style="color:#000">cell_id</span> = <span style="color:#3af">6064</span>

<span style="color:#000">main_1</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_3</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_5</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_2_internet_zoned</span>(<span style="color:#000">cell_id</span>)</code></pre></div>
<pre><code>Loaded ../01_Data/03_AWS outputs/model_1f from disk
Loaded ../01_Data/03_AWS outputs/model_3f_20181203_1651 from disk
Loaded ../01_Data/03_AWS outputs/model_5f_20181204_1142 from disk
Loaded ../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135 from disk
</code></pre>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_81_1.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_81_2.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_81_3.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_81_4.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Duomo: 5060</span>

<span style="color:#000">cell_id</span> = <span style="color:#3af">5060</span>

<span style="color:#000">main_1</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_3</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_5</span>(<span style="color:#000">cell_id</span>)
<span style="color:#000">main_2_internet_zoned</span>(<span style="color:#000">cell_id</span>)</code></pre></div>
<pre><code>Loaded ../01_Data/03_AWS outputs/model_1f from disk
Loaded ../01_Data/03_AWS outputs/model_3f_20181203_1651 from disk
Loaded ../01_Data/03_AWS outputs/model_5f_20181204_1142 from disk
Loaded ../01_Data/03_AWS outputs/model_3f_internet_zoned_20181205_1135 from disk
</code></pre>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_82_1.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_82_2.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_82_3.png" alt="png" /></p>

<p><img src="/Post_images/20181213_PassionProject/Graph_images/output_82_4.png" alt="png" /></p>

<hr />

<h3 id="13-extracting-predictions-for-dashboard-creation">13. Extracting predictions for dashboard creation</h3>

<p>Preaparing the data using the 5-dimensional model. Using the 5-dimensional model for dashboard building, as that is the most pessimistic about cell-traffic growth.</p>

<p><img src="/Post_images/20181213_PassionProject/Slide_images/Slide10.jpeg" alt="jpeg" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">global</span> <span style="color:#000">mean_list</span>
    
<span style="color:#000">dim</span> = <span style="color:#3af">5</span> <span style="color:#888;font-style:italic"># nr. of features to use in the dataframe</span>


<span style="color:#888;font-style:italic"># Main 3 feature model</span>
<span style="color:#000">model_to_use</span> = <span style="color:#5a2">&#39;../01_Data/03_AWS outputs/model_5f_20181204_1142&#39;</span> <span style="color:#888;font-style:italic"># + timestr</span>
<span style="color:#000">model</span> = <span style="color:#000">import_model</span>(<span style="color:#000">model_to_use</span>)

<span style="color:#888;font-style:italic"># Import model</span>
<span style="color:#000">df_cdrs</span> = <span style="color:#000">import_source_data</span>(<span style="color:#5a2">&#39;../01_Data/03_AWS outputs/group_merged.csv&#39;</span>)
<span style="color:#000">df_cdrs</span> = <span style="color:#000">add_spatial</span>(<span style="color:#000">df_cdrs</span>)

<span style="color:#888;font-style:italic"># Format and import data</span>
<span style="color:#000">mean_list</span>=[]
<span style="color:#000">df_cdrs</span>, <span style="color:#000">mean_list</span> = <span style="color:#000">scaler</span>(<span style="color:#000">df_cdrs</span>, <span style="color:#000">dim</span>)
<span style="color:#000">keras_matrix</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;../02_Notebooks/keras_matrix_featurenr_5.dat&#34;</span>)
<span style="color:#888;font-style:italic">#keras_matrix = create_keras_matrix(df_cdrs,dim)</span>

<span style="color:#000">y</span>, <span style="color:#000">y_list</span> = <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">nunique</span>(), <span style="color:#000">df_cdrs</span>.<span style="color:#000">day</span>.<span style="color:#000">unique</span>()
<span style="color:#000">d_dates_index</span> = <span style="color:#000">dict</span>(<span style="color:#000">zip</span>(<span style="color:#000">y_list</span>,<span style="color:#000">range</span>(<span style="color:#000">y</span>)))

<span style="color:#888;font-style:italic"># Generate encoder and decoder dataset</span>
<span style="color:#000">encoder_input_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of training period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_enc_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of training period</span>
                      :] <span style="color:#888;font-style:italic"># all features</span>
                     )

<span style="color:#888;font-style:italic"># data from train_pred_start to train_pred_end </span>
<span style="color:#000">decoder_target_data</span> = (<span style="color:#000">keras_matrix</span>
                      [:, <span style="color:#888;font-style:italic"># all cell-towers</span>
                      <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_start</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]: <span style="color:#888;font-style:italic"># start of pred period</span>
                       <span style="color:#000">d_dates_index</span>[<span style="color:#000">val_pred_end</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#39;%Y-%m-</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>)]+<span style="color:#3af">1</span>, <span style="color:#888;font-style:italic"># end of pred period</span>
                      :] <span style="color:#888;font-style:italic"># all features to be used as target</span>
                     )</code></pre></div>
<pre><code>Loaded ../01_Data/03_AWS outputs/model_5f_20181204_1142 from disk
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">encoder_input_data</span>.<span style="color:#000">shape</span></code></pre></div>
<pre><code>(10000, 49, 5)
</code></pre>

<h4 id="extraction">Extraction</h4>

<p>Extracting 7-day prediction sequences for each of the 10000 cell towers</p>

<h4 id="14-alarm-system">14. Alarm system</h4>

<p>Creating an alarm system that indicates which cell-towers have at least 60% + / - traffic change in the next 7-days vs. the mean of the last 40-days</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">IPython.display</span> <span style="color:#00f">import</span> <span style="color:#000">clear_output</span>
<span style="color:#000">pred_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">zeros</span>((<span style="color:#000">encoder_input_data</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>],<span style="color:#000">pred_steps</span>,<span style="color:#000">dim</span>)) <span style="color:#888;font-style:italic"># initialize output (pred_steps time steps)</span>

<span style="color:#00f">for</span> <span style="color:#000">cell_ID</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">encoder_input_data</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]):
    <span style="color:#000">clear_output</span>()
    <span style="color:#00f">print</span>(<span style="color:#000">cell_ID</span>)
    
    <span style="color:#000">history_seq</span> = <span style="color:#000">encoder_input_data</span>[<span style="color:#000">cell_ID</span>:<span style="color:#000">cell_ID</span>+<span style="color:#3af">1</span>,:,:]
    
    <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#000">pred_steps</span>): <span style="color:#888;font-style:italic">#pred_steps=7 at beginning of code</span>
    
        <span style="color:#000">last_step_pred</span>=<span style="color:#000">model</span>.<span style="color:#000">predict</span>(<span style="color:#000">history_seq</span>)[<span style="color:#3af">0</span>,-<span style="color:#3af">1</span>,:]
        <span style="color:#000">pred_sequence</span>[<span style="color:#000">cell_ID</span>,<span style="color:#000">i</span>,:] = <span style="color:#000">last_step_pred</span>
        
        <span style="color:#888;font-style:italic"># add the next time step prediction to the history sequence</span>
        <span style="color:#000">history_seq</span> = <span style="color:#000">np</span>.<span style="color:#000">concatenate</span>([<span style="color:#000">history_seq</span>, 
                                           <span style="color:#000">last_step_pred</span>.<span style="color:#000">reshape</span>(-<span style="color:#3af">1</span>,<span style="color:#3af">1</span>,<span style="color:#000">dim</span>)], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Pred sequence prepared for all towers. Final shape {pred_sequence.shape}&#39;</span>)
<span style="color:#000">pred_sequence</span>.<span style="color:#000">dump</span>(<span style="color:#5a2">&#34;pred_sequence_20181204_1451.dat&#34;</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">pred_sequence</span> = <span style="color:#000">np</span>.<span style="color:#000">load</span>(<span style="color:#5a2">&#34;pred_sequence_20181204_1451.dat&#34;</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Scaling data back to real world units</span>
<span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">10000</span>):
    <span style="color:#000">encoder_input_data</span>[<span style="color:#000">i</span>,:,:] = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">encoder_input_data</span>[<span style="color:#000">i</span>,:,:] + <span style="color:#000">mean_list</span>[<span style="color:#000">i</span>])
    <span style="color:#000">pred_sequence</span>[<span style="color:#000">i</span>,:,:] = <span style="color:#000">np</span>.<span style="color:#000">expm1</span>(<span style="color:#000">pred_sequence</span>[<span style="color:#000">i</span>,:,:] + <span style="color:#000">mean_list</span>[<span style="color:#000">i</span>])</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Extracing internet traffic of last 40 days for each tower, and taking the mean</span>
<span style="color:#000">last_forty_mean</span> = <span style="color:#000">np</span>.<span style="color:#000">mean</span>(<span style="color:#000">encoder_input_data</span>[:,-<span style="color:#3af">40</span>:,<span style="color:#3af">0</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
<span style="color:#000">last_forty_mean</span> = <span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">last_forty_mean</span>==<span style="color:#3af">0</span>,<span style="color:#3af">0.1</span>,<span style="color:#000">last_forty_mean</span>) <span style="color:#888;font-style:italic"># substituting 0-s with 0.1 to enable calcs</span>
<span style="color:#000">last_forty_mean</span>.<span style="color:#000">shape</span></code></pre></div>
<pre><code>(10000,)
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Extracting the expected internet traffic for the next 7 days for each tower and taking </span>
<span style="color:#000">next_seven_max</span> = <span style="color:#000">np</span>.<span style="color:#000">max</span>(<span style="color:#000">pred_sequence</span>[:,:,<span style="color:#3af">0</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
<span style="color:#000">next_seven_min</span> = <span style="color:#000">np</span>.<span style="color:#000">min</span>(<span style="color:#000">pred_sequence</span>[:,:,<span style="color:#3af">0</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
<span style="color:#00f">print</span>(<span style="color:#000">next_seven_max</span>.<span style="color:#000">shape</span>)</code></pre></div>
<pre><code>(10000,)
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Calculating % diff between mean of last 7 days and next 7 days min and max</span>
<span style="color:#000">growth</span> = ((<span style="color:#000">next_seven_max</span>-<span style="color:#000">last_forty_mean</span>)/<span style="color:#000">last_forty_mean</span>)*<span style="color:#3af">100</span>
<span style="color:#000">shrinkage</span> = ((<span style="color:#000">next_seven_min</span>-<span style="color:#000">last_forty_mean</span>)/<span style="color:#000">last_forty_mean</span>)*<span style="color:#3af">100</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">threshold</span> = <span style="color:#3af">60</span> <span style="color:#888;font-style:italic">#%</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">import</span> <span style="color:#000">plotly.plotly</span> <span style="color:#00f">as</span> <span style="color:#000">py</span>
<span style="color:#00f">import</span> <span style="color:#000">plotly.graph_objs</span> <span style="color:#00f">as</span> <span style="color:#000">go</span>

<span style="color:#000">x</span> = <span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">growth</span>&gt;<span style="color:#000">threshold</span>)[<span style="color:#3af">0</span>]+<span style="color:#3af">1</span>
<span style="color:#000">y</span> = <span style="color:#000">growth</span>[<span style="color:#000">growth</span>&gt;<span style="color:#000">threshold</span>]

<span style="color:#888;font-style:italic"># Create a trace</span>
<span style="color:#000">trace</span> = <span style="color:#000">go</span>.<span style="color:#000">Bar</span>(
    <span style="color:#000">x</span> = <span style="color:#000">x</span>,
    <span style="color:#000">y</span> = <span style="color:#000">y</span>
)

<span style="color:#000">data</span> = [<span style="color:#000">trace</span>]

<span style="color:#000">py</span>.<span style="color:#000">iplot</span>(<span style="color:#000">data</span>, <span style="color:#000">filename</span>=<span style="color:#5a2">&#39;basic-line&#39;</span>)</code></pre></div>
<pre><code>High five! You successfully sent some data to your account on plotly. View your plot in your browser at https://plot.ly/~krisz.sandor/0 or inside your plot.ly account where it is named 'basic-line'
</code></pre>

<iframe id="igraph" scrolling="no" style="border:none;" seamless="seamless" src="https://plot.ly/~krisz.sandor/0.embed" height="525px" width="100%"></iframe>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">high_growth</span> = <span style="color:#000">list</span>(<span style="color:#000">zip</span>(<span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">growth</span>&gt;<span style="color:#000">threshold</span>)[<span style="color:#3af">0</span>]+<span style="color:#3af">1</span>,<span style="color:#000">growth</span>[<span style="color:#000">growth</span>&gt;<span style="color:#000">threshold</span>]))

<span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Cell towers with at least {threshold}</span><span style="color:#5a2">% e</span><span style="color:#5a2">xpected traffic growth: {high_growth}&#39;</span>)
<span style="color:#888;font-style:italic">#plt.plot(np.where(growth&gt;threshold)[0],growth[growth&gt;threshold])</span></code></pre></div>
<pre><code>Cell towers with at least 60% expected traffic growth: [(814, 66.93866006968008), (3936, 75.09995857223389), (4136, 77.55330815818837), (4140, 64.96232330482368), (4141, 74.97279829033853), (4236, 75.94500582181918), (4241, 63.91302465738832), (4632, 70.50906919857434), (4633, 62.16145895137404), (4634, 62.60213430436957), (4731, 64.50277580034849), (4732, 70.9975885227163), (4733, 73.08078206974949), (4734, 71.29920549828279), (4831, 62.05815315326537), (4832, 69.1531248886856), (4833, 71.85924136173747), (4834, 75.40826283157858), (4835, 66.65852371175299), (4837, 60.85333476959609), (4934, 61.42642754609903), (4940, 62.007212990375194), (5039, 64.39630989378534), (5139, 79.21231098746337), (5238, 77.42990560987654), (5816, 68.3516251981003), (5916, 77.95917011476064), (5917, 76.95966391787435), (6172, 77.17692067917409), (7178, 73.13060803775497), (7277, 66.99386455440506), (7278, 78.8551969081368), (7279, 99.3974583047096), (7280, 78.04388192505137), (7377, 65.79338939936086), (7378, 66.35046709286505), (7379, 79.07796926434906), (7479, 66.95840250047291), (7776, 60.68202702116308), (7777, 75.49973254483936), (7778, 80.92741775556323)]
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">alarm_df</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>([<span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#3af">10001</span>),<span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">growth</span>&gt;<span style="color:#000">threshold</span>,<span style="color:#3af">1</span>,<span style="color:#3af">0</span>),<span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">shrinkage</span>&lt;-<span style="color:#000">threshold</span>,<span style="color:#3af">1</span>,<span style="color:#3af">0</span>)]).<span style="color:#000">T</span>
<span style="color:#000">alarm_df</span>.<span style="color:#000">columns</span> = [<span style="color:#5a2">&#39;CellID&#39;</span>,<span style="color:#5a2">&#39;Growth_Alarm&#39;</span>,<span style="color:#5a2">&#39;Shrinkage_A&#39;</span>]
<span style="color:#000">alarm_df</span>.<span style="color:#000">to_csv</span>(<span style="color:#5a2">&#39;alarm_df_for_tableau.csv&#39;</span>)</code></pre></div>
<p><img src="/Post_images/20181213_PassionProject/Slide_images/Slide07.jpeg" alt="jpeg" /></p>

<p>For a detailed visual alarm system dashboard example, visit: <a href="https://public.tableau.com/profile/krisztian.sandor#!/vizhome/Kojak_v1_1/Internet2">https://public.tableau.com/profile/krisztian.sandor#!/vizhome/Kojak_v1_1/Internet2</a></p>

  </section>
  <div class="clearfix">
    
      <div class="post-date pull-left">
        <span class="small">
          Posted on
          Dec 7, 2018 at 11:49
        </span>
      </div>
    
    <div class="pull-right">
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/telecom/">#Telecom</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/cnn/">#Cnn</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/keras/">#Keras</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/wavenet/">#Wavenet</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/time-series/">#Time Series</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/cell/">#Cell</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/tableau/">#Tableau</a></span>
        
      
    </div>
  </div>
  <footer>
    
      
    
    
      
        <div class="delimiter"></div>
        <section class="author-info row">
          <div class="author-avatar col-md-2">
            
              <img alt="Author Avatar" src="/images/KS.jpg" />
            
          </div>
          <div class="author-meta col-md-10">
            
              <h2 class="author-name text-primary">Krisztian Sandor</h2>
            
            
              <div class="author-bio">I&#39;m Krisztian an economist and data scientist from Budapest, Hungary.</div>
            
            
              <a class="btn btn-primary author-contact" href="https://www.linkedin.com/in/krisztiansandor/">
                <div>
                  <i class="fa fa-envelope-o" aria-hidden="true"></i>
                  &nbsp;Contact me
                </div>
              </a>
            
          </div>
        </section>
      
    <div class="delimiter"></div>
    <div class="pager-container">
      
        <a class="btn btn-primary btn-older-posts" href="https://kriszsandor.github.io/pages/about/">
          <div>
            <span aria-hidden="true">&larr;</span> Older Posts
          </div>
        </a>
      
      
        <a class="btn btn-primary btn-newer-posts" href="https://kriszsandor.github.io/posts/20181210_fletcher_blog/">
          <div>
            Newer Posts <span aria-hidden="true">&rarr;</span>
          </div>
        </a>
      
    </div>
  </footer>
</article>
<div class="delimiter"></div>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      &copy; Krisztian Sandor, Budapest, Hungary
    </div>
    <div class="sns-links hidden-print">
  
  
  
  
  
  
  
  
  
  
  
  
</div>

  </footer>

  
  
  
  
</body>
</html>

