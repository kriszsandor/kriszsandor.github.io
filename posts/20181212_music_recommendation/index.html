<!DOCTYPE html> 
<html lang="">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Building a music recommendation engine &middot;  Krisztian Sandor&#39;s data science blog" />
  
  <meta property="og:site_name" content="Krisztian Sandor&#39;s data science blog" />
  <meta property="og:url" content="https://kriszsandor.github.io/posts/20181212_music_recommendation/" />
  
  
    <meta property="og:type" content="article" />
    
    <meta property="og:article:published_time" content="2018-12-12T11:20:26-05:00" />
    
      <meta property="og:article:tag" content="music" />
    
      <meta property="og:article:tag" content="recommendation" />
    
      <meta property="og:article:tag" content="logistic regression" />
    
      <meta property="og:article:tag" content="random forest" />
    
      <meta property="og:article:tag" content="xgboost" />
    
      <meta property="og:article:tag" content="kaggle" />
    
      <meta property="og:article:tag" content="deezer" />
    
      <meta property="og:article:tag" content="kkbox" />
    
  

  <title>
     Building a music recommendation engine &middot;  Krisztian Sandor&#39;s data science blog
  </title>

  <link rel="alternative stylesheet" href="https://kriszsandor.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/main.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/github.css" />
  <link rel="stylesheet" href="https://kriszsandor.github.io/css/color-theme.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="https://kriszsandor.github.io/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://kriszsandor.github.io/images/apple-touch-icon.png" />

  <link rel="stylesheet" href="https://kriszsandor.github.io/css/custom.css" />

  

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-130640046-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-130640046-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  <script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script>

  
</head>
<body>
  <script>
    addBackToTop({
    backgroundColor: '#fff',
    innerHTML: 'Back to Top',
    textColor: '#333'
    })
  </script>
  
  <header class="global-header"  style="background-image:url(https://kriszsandor.github.io/images/background.png)">
  
    <section class="header-text">
      <h1><a href="https://kriszsandor.github.io/">Krisztian Sandor&#39;s data science blog</a></h1>
      
        <h3 class="tag-line">
          Using data science to solve business problems
        </h3>
      
      
        <a class="btn btn-default btn-home" href="https://kriszsandor.github.io/">
          <i class="fa fa-angle-left" aria-hidden="true"></i>
          &nbsp;Home
        </a>
      
      
      <div class="navbar-container">
        
          <a class="btn btn-default navbar-item" href="https://kriszsandor.github.io/pages/about">
            About
          </a>
        
      </div>
      
      
      
      
      
      
      
      
      
      
      
    </section>
  </header>
  <main class="container">



<article>
  <header class="article-title">
    <h1 class="text-primary">Building a music recommendation engine</h1>
  </header>
  <div class="delimiter"></div>
  <section>
    

<p>This exercise is <strong>inspired</strong> by the <a href="https://www.kaggle.com/c/kkbox-music-recommendation-challenge/data">Music Recommendation Challenge</a> KAGGLE competition.</p>

<p>The <strong>data</strong> was provided by KKBOX, an East-Asian music streaming service, similar to Spotify. It shows the first observable listening event for each unique user-song pair, together with potenitally useful Metadata. Besides the data provided, I sourced additional song and artist information via the API of Deezer music streaming service based on a &lsquo;real-world&rsquo; unique song identifier  (ISRC id) in the KKBOX dataset</p>

<p>My <strong>objective</strong> utlizing classification models was to predict…
…if a user is listening to a song repetitively
…after the first observable listening event
…within a month window was triggered</p>

<p><img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide02.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Import all necessery python packages</span>
<span style="color:#00f">import</span> <span style="color:#000">pandas</span> <span style="color:#00f">as</span> <span style="color:#000">pd</span>
<span style="color:#00f">import</span> <span style="color:#000">numpy</span> <span style="color:#00f">as</span> <span style="color:#000">np</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.pyplot</span> <span style="color:#00f">as</span> <span style="color:#000">plt</span>
<span style="color:#00f">import</span> <span style="color:#000">matplotlib.dates</span> <span style="color:#00f">as</span> <span style="color:#000">mdates</span>
<span style="color:#00f">import</span> <span style="color:#000">time</span>
<span style="color:#00f">import</span> <span style="color:#000">seaborn</span> <span style="color:#00f">as</span> <span style="color:#000">sns</span>
<span style="color:#00f">from</span> <span style="color:#000">collections</span> <span style="color:#00f">import</span> <span style="color:#000">defaultdict</span>
<span style="color:#00f">import</span> <span style="color:#000">statsmodels.api</span> <span style="color:#00f">as</span> <span style="color:#000">sm</span>
<span style="color:#00f">import</span> <span style="color:#000">statsmodels.formula.api</span> <span style="color:#00f">as</span> <span style="color:#000">smf</span>
<span style="color:#00f">import</span> <span style="color:#000">swifter</span>
<span style="color:#00f">from</span> <span style="color:#000">math</span> <span style="color:#00f">import</span> <span style="color:#000">ceil</span>
<span style="color:#00f">import</span> <span style="color:#000">pickle</span> <span style="color:#00f">as</span> <span style="color:#000">pkl</span>

<span style="color:#00f">from</span> <span style="color:#000">sklearn.linear_model</span> <span style="color:#00f">import</span> <span style="color:#000">LogisticRegression</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.preprocessing</span> <span style="color:#00f">import</span> <span style="color:#000">StandardScaler</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.metrics</span> <span style="color:#00f">import</span> <span style="color:#000">fbeta_score</span>, <span style="color:#000">confusion_matrix</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.ensemble</span> <span style="color:#00f">import</span> <span style="color:#000">RandomForestClassifier</span>
<span style="color:#00f">import</span> <span style="color:#000">xgboost</span> <span style="color:#00f">as</span> <span style="color:#000">xgb</span>

<span style="color:#00f">from</span> <span style="color:#000">IPython.display</span> <span style="color:#00f">import</span> <span style="color:#000">Image</span>
%<span style="color:#000">matplotlib</span> <span style="color:#000">inline</span></code></pre></div>
<p><img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide03.png" alt="png" /></p>

<h3 id="1-read-in-the-data">1. Read in the data</h3>

<p>The data is available on via the KAGGLE <a href="https://www.kaggle.com/c/7162/download-all">here</a>, you may have to register if you are not a member yet - it is free of charge.</p>

<p><em>By the way, KAGGLE is a really interesting source and platform to practice data science problems, and to acquire data. I highly recommend it!</em></p>

<h5 id="kaggle-data">KAGGLE data</h5>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">read_in_data</span>(<span style="color:#000">sample</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    
</span><span style="color:#5a2">    Reads in data from music_data folder in pickle format. If sample arguement is True, it limits each df to 1000
</span><span style="color:#5a2">    randomly sampled rows.
</span><span style="color:#5a2">    
</span><span style="color:#5a2">    input: None
</span><span style="color:#5a2">    output: df_train, df_members, df_full_songs
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#888;font-style:italic"># Limiting the data to 1000 records from each db</span>
    <span style="color:#000">df_train</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/train.pkl&#39;</span>)
    <span style="color:#000">df_members</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/members.pkl&#39;</span>)
    <span style="color:#000">df_full_songs</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/df_full_songs.pkl&#39;</span>)
    
    <span style="color:#00f">if</span> <span style="color:#000">sample</span>:
        <span style="color:#000">df_train</span> = <span style="color:#000">df_train</span>.<span style="color:#000">sample</span>(<span style="color:#3af">1000</span>)
        <span style="color:#000">df_members</span> = <span style="color:#000">df_members</span>.<span style="color:#000">sample</span>(<span style="color:#3af">1000</span>)
        <span style="color:#000">df_full_songs</span> = <span style="color:#000">df_full_songs</span>.<span style="color:#000">sample</span>(<span style="color:#3af">1000</span>)
    
    <span style="color:#00f">return</span> <span style="color:#000">df_train</span>, <span style="color:#000">df_members</span>, <span style="color:#000">df_full_songs</span></code></pre></div>
<h5 id="deezer-data">Deezer data</h5>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">downloader</span>(<span style="color:#000">df_merged</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    Download data from deezer
</span><span style="color:#5a2">
</span><span style="color:#5a2">    input: df_merged
</span><span style="color:#5a2">    otuput: dict containing the API download data
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>

    <span style="color:#000">BASE_URL</span> = <span style="color:#5a2">&#39;https://api.deezer.com/2.0/track/isrc:&#39;</span>
    <span style="color:#000">unique_isrc</span> = <span style="color:#000">df_merged</span>[<span style="color:#5a2">&#39;isrc&#39;</span>].<span style="color:#000">unique</span>()
    <span style="color:#000">total</span> = <span style="color:#000">len</span>(<span style="color:#000">unique_isrc</span>)
    <span style="color:#00f">from</span> <span style="color:#000">IPython.display</span> <span style="color:#00f">import</span> <span style="color:#000">clear_output</span>, <span style="color:#000">display</span>

    <span style="color:#00f">for</span> <span style="color:#000">i</span>, <span style="color:#000">isrc</span> <span style="color:#00f">in</span> <span style="color:#000">enumerate</span>(<span style="color:#000">unique_isrc</span>):
        <span style="color:#00f">if</span> <span style="color:#00f">not</span> <span style="color:#000">dict</span>[<span style="color:#000">str</span>(<span style="color:#000">isrc</span>)]:
            <span style="color:#000">clear_output</span>(<span style="color:#000">wait</span>=<span style="color:#000">True</span>)
            <span style="color:#00f">try</span>:            
                <span style="color:#000">api_call</span> = <span style="color:#000">BASE_URL</span> + <span style="color:#000">str</span>(<span style="color:#000">isrc</span>)
                <span style="color:#000">r</span> = <span style="color:#000">req</span>.<span style="color:#000">get</span>(<span style="color:#000">api_call</span>).<span style="color:#000">content</span>
                <span style="color:#000">dict</span>[<span style="color:#000">str</span>(<span style="color:#000">isrc</span>)] = <span style="color:#000">r</span>
                <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Saved:&#39;</span>,<span style="color:#000">str</span>(<span style="color:#000">isrc</span>),<span style="color:#000">i</span>,<span style="color:#5a2">&#39;of&#39;</span>,<span style="color:#000">total</span>)
            <span style="color:#00f">except</span>:
                <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;***Failed:***&#39;</span>,<span style="color:#000">str</span>(<span style="color:#000">isrc</span>),<span style="color:#000">i</span>,<span style="color:#5a2">&#39;of&#39;</span>,<span style="color:#000">total</span>)
                <span style="color:#000">downloader</span>(<span style="color:#000">df_merged</span>)

<span style="color:#00f">def</span> <span style="color:#000">save_deezer_to_pickle</span>(<span style="color:#000">dict</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: dict with downloaded deezer api info
</span><span style="color:#5a2">    output: none, saves dict to pickle
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>    
    <span style="color:#888;font-style:italic"># Save the downloaded data to a pkl file</span>
    <span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#5a2">&#39;deezer_data.pkl&#39;</span>, <span style="color:#5a2">&#39;wb&#39;</span>) <span style="color:#00f">as</span> <span style="color:#000">handle</span>:
        <span style="color:#000">pickle</span>.<span style="color:#000">dump</span>(<span style="color:#000">dict</span>, <span style="color:#000">handle</span>, <span style="color:#000">protocol</span>=<span style="color:#000">pickle</span>.<span style="color:#000">HIGHEST_PROTOCOL</span>)
        
<span style="color:#00f">def</span> <span style="color:#000">deezer_into_df</span>(<span style="color:#000">dict</span>):    
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    Take the dict with the downloaded API data
</span><span style="color:#5a2">
</span><span style="color:#5a2">    input: dict with downloaded api info
</span><span style="color:#5a2">    output: df_isrc in memory and saved to disk, containing the useful info from 
</span><span style="color:#5a2">
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    <span style="color:#00f">import</span> <span style="color:#000">json</span>
    <span style="color:#000">dfs</span>=[]
    <span style="color:#00f">for</span> <span style="color:#000">key</span>, <span style="color:#000">value</span> <span style="color:#00f">in</span> <span style="color:#000">dict</span>.<span style="color:#000">items</span>():
        <span style="color:#000">json1_data</span> = <span style="color:#000">json</span>.<span style="color:#000">loads</span>(<span style="color:#000">value</span>)

        <span style="color:#00f">try</span>:
            <span style="color:#000">isrc_query</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>([
                <span style="color:#000">key</span>,
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;title&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;album&#39;</span>][<span style="color:#5a2">&#39;title&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;artist&#39;</span>][<span style="color:#5a2">&#39;name&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;release_date&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;duration&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;track_position&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;bpm&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;gain&#39;</span>],
                <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;rank&#39;</span>]
                                  ])
            <span style="color:#000">df_isrc_query</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">isrc_query</span>.<span style="color:#000">reshape</span>(<span style="color:#3af">1</span>,<span style="color:#000">isrc_query</span>.<span style="color:#000">size</span>))
            <span style="color:#000">dfs</span>.<span style="color:#000">append</span>(<span style="color:#000">df_isrc_query</span>)
        <span style="color:#00f">except</span>:
            <span style="color:#00f">try</span>:
                <span style="color:#00f">if</span> <span style="color:#000">json1_data</span>[<span style="color:#5a2">&#39;error&#39;</span>][<span style="color:#5a2">&#39;code&#39;</span>] == <span style="color:#3af">800</span>:
                    <span style="color:#00f">pass</span> <span style="color:#888;font-style:italic">#all response 800 just pass</span>
            <span style="color:#00f">except</span>:
                <span style="color:#00f">print</span>(<span style="color:#000">key</span>,<span style="color:#5a2">&#39;/n&#39;</span>, <span style="color:#000">json1_data</span>)
                <span style="color:#00f">pass</span>
    <span style="color:#000">df_isrc_all</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>(<span style="color:#000">dfs</span>)
    <span style="color:#000">df_isrc_all</span>.<span style="color:#000">columns</span> = [<span style="color:#5a2">&#39;isrc&#39;</span>,<span style="color:#5a2">&#39;track_title&#39;</span>,<span style="color:#5a2">&#39;album_title&#39;</span>,<span style="color:#5a2">&#39;artist_name&#39;</span>,<span style="color:#5a2">&#39;release_date&#39;</span>,<span style="color:#5a2">&#39;duration_sec&#39;</span>,<span style="color:#5a2">&#39;track_pos&#39;</span>,<span style="color:#5a2">&#39;bpm&#39;</span>,<span style="color:#5a2">&#39;gain&#39;</span>,<span style="color:#5a2">&#39;rank&#39;</span>]
    <span style="color:#000">df_isrc_all</span>.<span style="color:#000">reset_index</span>(<span style="color:#000">inplace</span>=<span style="color:#000">True</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_isrc_all</span>[<span style="color:#5a2">&#39;index&#39;</span>]
    <span style="color:#000">df_isrc_all</span>.<span style="color:#000">to_pickle</span>(<span style="color:#5a2">&#39;df_isrc.pkl&#39;</span>)
    
    <span style="color:#00f">return</span> <span style="color:#000">df_isrc_all</span></code></pre></div>
<h5 id="merging-deezer-and-kaggle-data">Merging deezer and kaggle data</h5>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">create_df_full_songs</span>(<span style="color:#000">df_song_extra</span>,<span style="color:#000">df_songs</span>,<span style="color:#000">df_isrc</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    Merging the relationally stored sub-tables that describe the metadata for each song into a single table
</span><span style="color:#5a2">    
</span><span style="color:#5a2">    input: df_song_extra,df_songs,df_isrc
</span><span style="color:#5a2">    output: df_full_songs
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#000">df_song_extra</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/song_extra_info.pkl&#39;</span>)
    <span style="color:#000">df_songs</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/songs.pkl&#39;</span>)
    <span style="color:#000">df_isrc</span> = <span style="color:#000">pd</span>.<span style="color:#000">read_pickle</span>(<span style="color:#5a2">&#39;./music_data/df_isrc.pkl&#39;</span>)

    <span style="color:#888;font-style:italic"># To analyze song data, I am merging df_songs, df_songs_extra and df_isrc</span>
    <span style="color:#000">df_full_songs</span> = (<span style="color:#000">df_songs</span>
                 .<span style="color:#000">merge</span>(<span style="color:#000">df_songs</span>,<span style="color:#000">on</span>=<span style="color:#5a2">&#39;song_id&#39;</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>)
                 .<span style="color:#000">merge</span>(<span style="color:#000">df_song_extra</span>,<span style="color:#000">on</span>=<span style="color:#5a2">&#39;isrc&#39;</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>)
                )

    <span style="color:#888;font-style:italic"># Deleting song data elements to save memory. Everything saved under df_full_songs</span>
    <span style="color:#00f">del</span> <span style="color:#000">df_song_extra</span>
    <span style="color:#00f">del</span> <span style="color:#000">df_songs</span>
    <span style="color:#00f">del</span> <span style="color:#000">df_isrc</span>

    <span style="color:#888;font-style:italic"># Write df_full_songs</span>
    <span style="color:#000">df_full_songs</span>.<span style="color:#000">to_pickle</span>(<span style="color:#5a2">&#39;./music_data/df_full_songs.pkl&#39;</span>)

    <span style="color:#00f">return</span> <span style="color:#000">df_full_songs</span></code></pre></div>
<h3 id="2-feature-engineering">2. Feature engineering</h3>

<p>On each of the provided tables I am extracting signals that could direct the classifier model to be built later. This is a crucial step in machine learning, and as I learned spending 80% of your time on feature engineering and 20% on model training is usually a good balance.</p>

<p>As the data (likely) was originally stored in relational databases at KKBOX, KAGGLE provided it each logical piece of information in separate files. Below I am extracting the features individually from the tables where possible, once done I am merging the tables and extract signals, from the merged (unique song-user combos) table.</p>

<p><em>Side comment: as you may see, I am using pickle to save and load databases across my work on this blog. Pickle is a fast and easy alternative to csv, it can hold all types of data I came across (including saved neural network models with some tweaking) and it is much faster than csv in cases I observed.</em></p>

<p><img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide04.png" alt="png" />
<img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide05.png" alt="png" />
<img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide06.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">full_songs_engineering</span>(<span style="color:#000">df_full_songs</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: df_full_songs
</span><span style="color:#5a2">    output: df_full_songs cleaned and engineered
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#888;font-style:italic"># Extract country of origin from isrc</span>
    <span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;song_language_isrc&#39;</span>] = <span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;isrc&#39;</span>].<span style="color:#000">isna</span>(),
                                                   <span style="color:#000">np</span>.<span style="color:#000">NaN</span>,
                                                   <span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;isrc&#39;</span>].<span style="color:#000">astype</span>(<span style="color:#000">str</span>).<span style="color:#000">str</span>[:<span style="color:#3af">2</span>])
    
    <span style="color:#888;font-style:italic"># Count the number of genre_ids</span>
    <span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;count_genre_ids&#39;</span>] = <span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>].<span style="color:#000">str</span>.<span style="color:#000">count</span>(<span style="color:#5a2">&#39;\|&#39;</span>)+<span style="color:#3af">1</span>

    <span style="color:#888;font-style:italic"># Categorize genre (can be multiple)</span>
    <span style="color:#000">dfs</span>=[]
    <span style="color:#000">df_all_genres</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">df_full_songs</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>].<span style="color:#000">str</span>.<span style="color:#000">split</span>(<span style="color:#5a2">&#39;|&#39;</span>,<span style="color:#000">expand</span>=<span style="color:#000">True</span>)).<span style="color:#000">fillna</span>(<span style="color:#000">value</span>=<span style="color:#000">np</span>.<span style="color:#000">NaN</span>)
    <span style="color:#00f">for</span> <span style="color:#000">i</span>, <span style="color:#000">column</span> <span style="color:#00f">in</span> <span style="color:#000">enumerate</span>(<span style="color:#000">df_all_genres</span>):
        <span style="color:#000">dfs</span>.<span style="color:#000">append</span>(<span style="color:#000">pd</span>.<span style="color:#000">get_dummies</span>(<span style="color:#000">df_all_genres</span>[<span style="color:#000">i</span>], <span style="color:#000">prefix</span> = <span style="color:#5a2">&#39;genre_CAT&#39;</span>))
    <span style="color:#000">df_genre_merged</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>(<span style="color:#000">dfs</span>, <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">df_genre_merged</span> = <span style="color:#000">df_genre_merged</span>.<span style="color:#000">groupby</span>(<span style="color:#000">df_genre_merged</span>.<span style="color:#000">columns</span>, <span style="color:#000">axis</span>=<span style="color:#3af">1</span>).<span style="color:#000">agg</span>(<span style="color:#000">np</span>.<span style="color:#000">max</span>)
    <span style="color:#000">df_full_songs</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>([<span style="color:#000">df_full_songs</span>, <span style="color:#000">df_genre_merged</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

    <span style="color:#00f">del</span> <span style="color:#000">df_genre_merged</span>
    <span style="color:#00f">del</span> <span style="color:#000">df_all_genres</span>
    <span style="color:#00f">del</span> <span style="color:#000">dfs</span>
    
    <span style="color:#00f">return</span> <span style="color:#000">df_full_songs</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">members_engineering</span>(<span style="color:#000">df_members</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: df_members
</span><span style="color:#5a2">    output: df_members cleaned, and features engineered
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#888;font-style:italic">## &#39;bd&#39;, aka age of user has outliers and bias</span>
    <span style="color:#888;font-style:italic"># Replace ages &gt;90 years with 90 years in df_members/user age</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;bd&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;bd&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">x</span> <span style="color:#00f">if</span> <span style="color:#000">x</span>&lt;=<span style="color:#3af">90</span> <span style="color:#00f">else</span> <span style="color:#3af">90</span>)

    <span style="color:#888;font-style:italic"># Replace ages &lt;0 years with np.NaN in df_members/user age</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;bd&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;bd&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">x</span> <span style="color:#00f">if</span> <span style="color:#000">x</span>&gt;=<span style="color:#3af">0</span> <span style="color:#00f">else</span> <span style="color:#000">np</span>.<span style="color:#000">NaN</span>)

    <span style="color:#888;font-style:italic"># Replace 0s to np.NaN in df_members/user age</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;bd&#39;</span>].<span style="color:#000">replace</span>(<span style="color:#3af">0</span>,<span style="color:#000">np</span>.<span style="color:#000">NaN</span>,<span style="color:#000">inplace</span>=<span style="color:#000">True</span>)
    
    
    
    <span style="color:#888;font-style:italic">## Formatting date columns</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;registration_init_time&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;registration_init_time&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">x</span>, <span style="color:#000">format</span>=<span style="color:#5a2">&#39;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>))
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;expiration_date&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;expiration_date&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#000">x</span>, <span style="color:#000">format</span>=<span style="color:#5a2">&#39;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">&#39;</span>))
    
    <span style="color:#888;font-style:italic"># Calculate the time between user registration and today (ca. 2017-Jan-31)</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;days_since_registration&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;registration_init_time&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: (<span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#5a2">&#39;20170131&#39;</span>) - <span style="color:#000">x</span>).<span style="color:#000">days</span>)

    <span style="color:#888;font-style:italic"># Calculate the time between user expiration and today (ca. 2017-Jan-31)</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;days_until_expiration&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;expiration_date&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: (<span style="color:#000">x</span> - <span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#5a2">&#39;20170131&#39;</span>)).<span style="color:#000">days</span>)
    
    
    
    <span style="color:#888;font-style:italic"># Categorize &#34;gender&#34; on df_members</span>
    <span style="color:#000">gender_CAT</span> = <span style="color:#000">pd</span>.<span style="color:#000">get_dummies</span>(<span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;gender&#39;</span>], <span style="color:#000">prefix</span> = <span style="color:#5a2">&#39;gender_CAT&#39;</span>)
    <span style="color:#000">df_members</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>([<span style="color:#000">df_members</span>, <span style="color:#000">gender_CAT</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#00f">del</span> <span style="color:#000">gender_CAT</span>
    
    
    
    <span style="color:#888;font-style:italic"># Calculate the difference between the age of the song and the age of the user (57% NaN ratio)</span>
    <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;days_since_registration&#39;</span>] = <span style="color:#000">df_members</span>[<span style="color:#5a2">&#39;registration_init_time&#39;</span>].<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: (<span style="color:#000">pd</span>.<span style="color:#000">to_datetime</span>(<span style="color:#5a2">&#39;20170131&#39;</span>) - <span style="color:#000">x</span>).<span style="color:#000">days</span>)
    
    <span style="color:#00f">return</span> <span style="color:#000">df_members</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">train_engineering</span>(<span style="color:#000">df_train</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: df_train
</span><span style="color:#5a2">    output: df_train cleaned and engineered
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#888;font-style:italic"># Categorize &#34;screen of listening&#34; on df_train (1: create screen_id, 2: categorize)</span>
    <span style="color:#000">df_train</span>[<span style="color:#5a2">&#39;screen_id&#39;</span>] = <span style="color:#000">df_train</span>[<span style="color:#5a2">&#39;source_system_tab&#39;</span>]+<span style="color:#5a2">&#39;+&#39;</span>+<span style="color:#000">df_train</span>[<span style="color:#5a2">&#39;source_screen_name&#39;</span>]+<span style="color:#5a2">&#39;+&#39;</span>+<span style="color:#000">df_train</span>[<span style="color:#5a2">&#39;source_type&#39;</span>]
    <span style="color:#000">screen_id_CAT</span> = <span style="color:#000">pd</span>.<span style="color:#000">get_dummies</span>(<span style="color:#000">df_train</span>[<span style="color:#5a2">&#39;screen_id&#39;</span>], <span style="color:#000">prefix</span> = <span style="color:#5a2">&#39;screen_id_CAT&#39;</span>)
    <span style="color:#000">df_train</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>([<span style="color:#000">df_train</span>, <span style="color:#000">screen_id_CAT</span>], <span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#00f">del</span> <span style="color:#000">screen_id_CAT</span>
    
    <span style="color:#888;font-style:italic"># Count number of songs each user has listened to</span>
    <span style="color:#000">df_activity_temp</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">df_train</span>.<span style="color:#000">groupby</span>(<span style="color:#000">by</span>=<span style="color:#5a2">&#39;msno&#39;</span>)[<span style="color:#5a2">&#39;song_id&#39;</span>].<span style="color:#000">nunique</span>()).<span style="color:#000">reset_index</span>()
    <span style="color:#000">df_activity_temp</span>.<span style="color:#000">columns</span> = [<span style="color:#5a2">&#39;msno&#39;</span>,<span style="color:#5a2">&#39;user_activity&#39;</span>]
    <span style="color:#000">df_train</span> = <span style="color:#000">df_train</span>.<span style="color:#000">merge</span>(<span style="color:#000">df_activity_temp</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>,<span style="color:#000">on</span>=<span style="color:#5a2">&#39;msno&#39;</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_activity_temp</span>
    
    <span style="color:#00f">return</span> <span style="color:#000">df_train</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">merge_databases</span>(<span style="color:#000">df_train</span>, <span style="color:#000">df_members</span>, <span style="color:#000">df_full_songs</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: df_train, df_members, df_full_songs
</span><span style="color:#5a2">    output: df_merged
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>
    
    <span style="color:#000">df_merged</span> = (<span style="color:#000">df_train</span>.<span style="color:#000">merge</span>(<span style="color:#000">df_members</span>, <span style="color:#000">on</span>=<span style="color:#5a2">&#39;msno&#39;</span>, <span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>)
                 .<span style="color:#000">merge</span>(<span style="color:#000">df_full_songs</span>, <span style="color:#000">on</span>=<span style="color:#5a2">&#39;song_id&#39;</span>, <span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>)
                )
    
    <span style="color:#00f">return</span> <span style="color:#000">df_merged</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">merged_engineering</span>(<span style="color:#000">df_merged</span>):
    <span style="color:#5a2">&#39;&#39;&#39;
</span><span style="color:#5a2">    input: df_merged
</span><span style="color:#5a2">    output: df_merged cleaned and engineered
</span><span style="color:#5a2">    
</span><span style="color:#5a2">    Notes: this function is very very heavy. To run properly on large dfs, it requires AWS and chunkified dfs
</span><span style="color:#5a2">    &#39;&#39;&#39;</span>    
    
    
    
    <span style="color:#888;font-style:italic"># nth time listening to this artist</span>
    <span style="color:#000">msno_group</span> = <span style="color:#000">df_merged</span>.<span style="color:#000">groupby</span>(<span style="color:#000">by</span>=<span style="color:#5a2">&#39;msno&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Group by done&#39;</span>)
    <span style="color:#000">KKBOX</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">msno_group</span>[<span style="color:#5a2">&#39;artist_name_x&#39;</span>].<span style="color:#000">nunique</span>())
    <span style="color:#000">DEEZER</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">msno_group</span>[<span style="color:#5a2">&#39;artist_name_y&#39;</span>].<span style="color:#000">nunique</span>())
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Uniques found&#39;</span>)
    <span style="color:#000">df_artist_freq</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>({<span style="color:#5a2">&#39;msno&#39;</span>:<span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">list</span>(<span style="color:#000">msno_group</span>.<span style="color:#000">groups</span>.<span style="color:#000">keys</span>())),<span style="color:#5a2">&#39;artist_freq&#39;</span>:<span style="color:#000">np</span>.<span style="color:#000">where</span>(<span style="color:#000">KKBOX</span>&gt;<span style="color:#000">DEEZER</span>,<span style="color:#000">KKBOX</span>,<span style="color:#000">DEEZER</span>)})    
    <span style="color:#000">df_artist_freq</span>.<span style="color:#000">columns</span> = [<span style="color:#5a2">&#39;msno&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>]
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Frequencies in df&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Merge starting&#39;</span>)
    <span style="color:#000">df_merged</span> = <span style="color:#000">df_merged</span>.<span style="color:#000">merge</span>(<span style="color:#000">df_artist_freq</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>,<span style="color:#000">on</span>=<span style="color:#5a2">&#39;msno&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Merge finished&#39;</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_artist_freq</span>
    
    
    
    
    <span style="color:#888;font-style:italic"># number of genres listened</span>
    <span style="color:#000">df_merged</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>] = <span style="color:#000">df_merged</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>].<span style="color:#000">str</span>.<span style="color:#000">replace</span>(<span style="color:#5a2">&#39;|&#39;</span>,<span style="color:#5a2">r</span><span style="color:#5a2">&#39;,&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Replace of | to , finished&#39;</span>)
    <span style="color:#000">df_grouped</span> = (<span style="color:#000">df_merged</span>
                  .<span style="color:#000">groupby</span>(<span style="color:#5a2">&#39;msno&#39;</span>,<span style="color:#000">as_index</span>=<span style="color:#000">False</span>)
                  .<span style="color:#000">agg</span>({<span style="color:#5a2">&#39;genre_ids&#39;</span>:(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">x</span>.<span style="color:#000">str</span>.<span style="color:#000">cat</span>(<span style="color:#000">sep</span>=<span style="color:#5a2">&#39;,&#39;</span>).<span style="color:#000">split</span>(<span style="color:#5a2">&#39;,&#39;</span>))})
                  .<span style="color:#000">rename</span>(<span style="color:#000">columns</span>={<span style="color:#5a2">&#39;genre_ids&#39;</span>:<span style="color:#5a2">&#39;all_genres_listened&#39;</span>})
                 )
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Groupby finished&#39;</span>)
    <span style="color:#000">df_grouped</span>[<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>] = <span style="color:#000">df_grouped</span>[<span style="color:#5a2">&#39;all_genres_listened&#39;</span>].<span style="color:#000">swifter</span>.<span style="color:#000">apply</span>(<span style="color:#00f">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">len</span>(<span style="color:#000">set</span>(<span style="color:#000">x</span>)))
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Set creation finished&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Merge starting&#39;</span>)
    <span style="color:#000">df_merged</span> = <span style="color:#000">df_merged</span>.<span style="color:#000">merge</span>(<span style="color:#000">df_grouped</span>, <span style="color:#000">on</span>=<span style="color:#5a2">&#39;msno&#39;</span>,<span style="color:#000">how</span>=<span style="color:#5a2">&#39;left&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Merge finished&#39;</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_grouped</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Finished number of genres listened&#39;</span>)
    
    
    
    
    <span style="color:#888;font-style:italic"># nth time listening to this genre - apply function</span>
    <span style="color:#00f">def</span> <span style="color:#000">check_genres</span>(<span style="color:#000">row</span>):
        <span style="color:#000">counter</span> = <span style="color:#3af">0</span>
        <span style="color:#000">prev_counter</span> = <span style="color:#3af">0</span>
        <span style="color:#00f">for</span> <span style="color:#000">item</span> <span style="color:#00f">in</span> <span style="color:#000">row</span>[<span style="color:#5a2">&#39;all_genres_listened&#39;</span>]:
            <span style="color:#000">multi_counter</span> = <span style="color:#3af">0</span>
            <span style="color:#00f">if</span> <span style="color:#5a2">&#39;,&#39;</span> <span style="color:#00f">in</span> <span style="color:#000">str</span>(<span style="color:#000">row</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>]):
                <span style="color:#00f">for</span> <span style="color:#000">genre</span> <span style="color:#00f">in</span> <span style="color:#000">row</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>].<span style="color:#000">split</span>(<span style="color:#5a2">&#39;,&#39;</span>):
                    <span style="color:#00f">if</span> <span style="color:#000">item</span> == <span style="color:#000">genre</span>:
                        <span style="color:#000">multi_counter</span> += <span style="color:#3af">1</span>
                        <span style="color:#00f">if</span> <span style="color:#000">prev_counter</span> &gt; <span style="color:#000">multi_counter</span>:
                            <span style="color:#000">multi_counter</span> = <span style="color:#000">prev_counter</span>
                    <span style="color:#000">prev_counter</span> = <span style="color:#000">multi_counter</span>
            <span style="color:#00f">else</span>:
                <span style="color:#00f">if</span> <span style="color:#000">item</span> == <span style="color:#000">row</span>[<span style="color:#5a2">&#39;genre_ids&#39;</span>]:
                    <span style="color:#000">counter</span> += <span style="color:#3af">1</span>
        <span style="color:#00f">return</span> <span style="color:#000">counter</span> <span style="color:#00f">if</span> <span style="color:#000">counter</span> &gt; <span style="color:#000">multi_counter</span> <span style="color:#00f">else</span> <span style="color:#000">multi_counter</span>

    
    
    
    <span style="color:#888;font-style:italic"># nth time listening to this genre - runner</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*** Starting nth time this genre&#39;</span>)
    <span style="color:#000">df_merged</span>[<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>] = <span style="color:#000">df_merged</span>.<span style="color:#000">swifter</span>.<span style="color:#000">apply</span>(<span style="color:#000">check_genres</span>,<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

    
    <span style="color:#00f">return</span> <span style="color:#000">df_merged</span></code></pre></div>
<h3 id="3-codifying-often-re-used-functions">3. Codifying often (re-)used functions</h3>

<p>In this step I am defining functions that are often required and re-run in the (following) model building step. The functions are not run in the order of this notebook, but rather as-required.</p>

<p><strong>3.1. Chunkifier:</strong> Read a database &lsquo;chunkified&rsquo;, i.e. in smaller pieces. This is helpful when the computation is very memory or cpu hungry</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">chunk</span>(<span style="color:#000">seq</span>, <span style="color:#000">size</span>):
    <span style="color:#00f">return</span> (<span style="color:#000">seq</span>[<span style="color:#000">pos</span>:<span style="color:#000">pos</span> + <span style="color:#000">size</span>] <span style="color:#00f">for</span> <span style="color:#000">pos</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">0</span>, <span style="color:#000">len</span>(<span style="color:#000">seq</span>), <span style="color:#000">size</span>))

<span style="color:#888;font-style:italic"># usage: for i, df_chunk in enumerate(chunk(df_merged_final, 100000)):</span></code></pre></div>
<p><strong>3.2. Pickle reader:</strong> For some reason pandas&rsquo; built-in pickle reader did not cope with the challenge to read some of my pickles, hence I built the below substitute function</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># This unpickler was more reliable than pd.read_pickle</span>
<span style="color:#888;font-style:italic"># filename = &#39;df_merged_merged_aws.pkl&#39;</span>

<span style="color:#00f">def</span> <span style="color:#000">own_read_pickle</span>(<span style="color:#000">filename</span>):

    <span style="color:#00f">import</span> <span style="color:#000">pickle</span> <span style="color:#00f">as</span> <span style="color:#000">pkl</span>
    <span style="color:#000">objects</span> = []
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Pickle load of {filename} started&#39;</span>)
    <span style="color:#00f">with</span> (<span style="color:#000">open</span>(<span style="color:#000">filename</span>, <span style="color:#5a2">&#39;rb&#39;</span>)) <span style="color:#00f">as</span> <span style="color:#000">openfile</span>:
        <span style="color:#00f">while</span> <span style="color:#000">True</span>:
            <span style="color:#00f">try</span>:
                <span style="color:#000">objects</span>.<span style="color:#000">append</span>(<span style="color:#000">pkl</span>.<span style="color:#000">load</span>(<span style="color:#000">openfile</span>))
            <span style="color:#00f">except</span> <span style="color:#000">EOFError</span>:
                <span style="color:#00f">break</span>

    <span style="color:#000">df_output</span> = <span style="color:#000">objects</span>[<span style="color:#3af">0</span>]
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Pickle load of {filename} finished&#39;</span>)
    <span style="color:#00f">return</span> <span style="color:#000">df_output</span></code></pre></div>
<p><strong>3.3. Model scorer:</strong> The below function provides the most important scoring metrics to evaluate model performance and returns the confusion matrix that provides the absolute figures behing these scoring metrics.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">score_model</span>(<span style="color:#000">model</span>, <span style="color:#000">X</span>, <span style="color:#000">y</span>, <span style="color:#000">gbm</span>=<span style="color:#000">False</span>):

    <span style="color:#888;font-style:italic"># Calculate hard predictions</span>
    <span style="color:#00f">if</span> <span style="color:#000">gbm</span>:
        <span style="color:#000">prediction_hard</span> = <span style="color:#000">model</span>.<span style="color:#000">predict</span>(<span style="color:#000">X</span>,<span style="color:#000">ntree_limit</span>=<span style="color:#000">model</span>.<span style="color:#000">best_ntree_limit</span>)
    <span style="color:#00f">else</span>:
        <span style="color:#000">prediction_hard</span> = <span style="color:#000">model</span>.<span style="color:#000">predict</span>(<span style="color:#000">X</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;score_model: Predictions ready&#39;</span>)
    
    <span style="color:#888;font-style:italic"># Score model on FBeta weighing on precision</span>
    <span style="color:#000">beta</span>=<span style="color:#3af">0.3</span>
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;FBeta(b={beta}) score is: {fbeta_score(y, prediction_hard,beta)}&#39;</span>)

    <span style="color:#888;font-style:italic"># Calculate confusion matrix</span>
    <span style="color:#000">conf_matrix</span> = <span style="color:#000">confusion_matrix</span>(<span style="color:#000">y</span>, <span style="color:#000">prediction_hard</span>)
    <span style="color:#000">TN</span>, <span style="color:#000">FP</span>, <span style="color:#000">FN</span>, <span style="color:#000">TP</span> = <span style="color:#000">conf_matrix</span>.<span style="color:#000">ravel</span>()

    <span style="color:#888;font-style:italic">## Scoring</span>
    <span style="color:#000">Recall</span> = <span style="color:#000">TP</span> / (<span style="color:#000">TP</span> + <span style="color:#000">FN</span>)
    <span style="color:#000">Precision</span>=<span style="color:#000">TP</span>/(<span style="color:#000">TP</span>+<span style="color:#000">FP</span>)
    <span style="color:#000">Specificity</span> = <span style="color:#000">TN</span> / (<span style="color:#000">TN</span> + <span style="color:#000">FP</span>)
    <span style="color:#000">Accuracy</span>=(<span style="color:#000">TP</span>+<span style="color:#000">TN</span>)/(<span style="color:#000">TP</span>+<span style="color:#000">TN</span>+<span style="color:#000">FP</span>+<span style="color:#000">FN</span>)

    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Accuracy:&#39;</span>,<span style="color:#000">Accuracy</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Recall:&#39;</span>,<span style="color:#000">Recall</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Precision:&#39;</span>,<span style="color:#000">Precision</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Specificity:&#39;</span>,<span style="color:#000">Specificity</span>)

    <span style="color:#888;font-style:italic"># Print confusion matrix</span>
    <span style="color:#00f">return</span> <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">conf_matrix</span>, <span style="color:#000">columns</span>=
                 [<span style="color:#5a2">&#39;Predict (0=no relisten)&#39;</span>, <span style="color:#5a2">&#39;Predict (1=relisten)&#39;</span>],
                 <span style="color:#000">index</span>=[<span style="color:#5a2">&#39;Actual (0=no relisten)&#39;</span>, <span style="color:#5a2">&#39;Actual (1=relisten)&#39;</span>])</code></pre></div>
<h3 id="4-building-the-model">4. Building the model</h3>

<h4 id="4-0-create-df-x-by-compiling-useful-features-and-the-target">4.0. Create df_X by compiling &lsquo;useful&rsquo; features and the target</h4>

<p>This is step 0, i.e. loading the data and selecting feature-columns we (may) require. This is not to be confused with feature-selection, in this case I am loading all features that may or may not help the model.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">select_columns</span>(<span style="color:#000">df_in</span>, <span style="color:#000">target_removed</span>=<span style="color:#000">True</span>):

    <span style="color:#000">cols_not_required</span> = [<span style="color:#5a2">&#39;song_id&#39;</span>,<span style="color:#5a2">&#39;source_system_tab&#39;</span>,<span style="color:#5a2">&#39;source_screen_name&#39;</span>,
                        <span style="color:#5a2">&#39;source_type&#39;</span>,<span style="color:#5a2">&#39;gender&#39;</span>,<span style="color:#5a2">&#39;city&#39;</span>,<span style="color:#5a2">&#39;registered_via&#39;</span>,<span style="color:#5a2">&#39;registration_init_time&#39;</span>,
                         <span style="color:#5a2">&#39;expiration_date&#39;</span>,<span style="color:#5a2">&#39;name&#39;</span>,<span style="color:#5a2">&#39;isrc&#39;</span>,<span style="color:#5a2">&#39;genre_ids&#39;</span>,<span style="color:#5a2">&#39;artist_name_x&#39;</span>,<span style="color:#5a2">&#39;composer&#39;</span>,
                         <span style="color:#5a2">&#39;lyricist&#39;</span>,<span style="color:#5a2">&#39;language&#39;</span>,<span style="color:#5a2">&#39;track_title&#39;</span>,<span style="color:#5a2">&#39;album_title&#39;</span>,<span style="color:#5a2">&#39;artist_name_y&#39;</span>,
                         <span style="color:#5a2">&#39;release_date&#39;</span>,<span style="color:#5a2">&#39;duration_sec&#39;</span>,<span style="color:#5a2">&#39;song_language_isrc&#39;</span>,<span style="color:#5a2">&#39;screen_id&#39;</span>,<span style="color:#5a2">&#39;all_genres_listened&#39;</span>
                        ]
    <span style="color:#000">df_out</span> = <span style="color:#000">df_in</span>.<span style="color:#000">drop</span>(<span style="color:#000">cols_not_required</span>,<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    
    <span style="color:#00f">if</span> <span style="color:#000">target_removed</span>:
        <span style="color:#000">df_out</span> = <span style="color:#000">df_out</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;target&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    
    <span style="color:#00f">return</span> <span style="color:#000">df_out</span>

<span style="color:#00f">def</span> <span style="color:#000">load_dataset</span>(<span style="color:#000">filename</span>, <span style="color:#000">sample</span>=<span style="color:#000">False</span>):
    
    <span style="color:#000">df_merged</span> = <span style="color:#000">own_read_pickle</span>(<span style="color:#000">filename</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;load_dataset: df_merged loaded into memory&#39;</span>)
    
    <span style="color:#888;font-style:italic"># Sample creation if needed</span>
    <span style="color:#00f">if</span> <span style="color:#000">sample</span>:
        <span style="color:#000">list_of_chunks</span> = <span style="color:#000">get_user_split_data</span>(<span style="color:#000">df_merged</span>,<span style="color:#3af">100000</span>)
        <span style="color:#000">df_sample</span> = <span style="color:#000">list_of_chunks</span>[<span style="color:#3af">0</span>]
        <span style="color:#888;font-style:italic">#df_sample = pd.read_pickle(&#39;df_sample_modeltraining.pkl&#39;)</span>
        <span style="color:#000">df_merged</span> = <span style="color:#000">df_sample</span>
        <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;load_dataset: sample creation done&#39;</span>)
    
    <span style="color:#000">df_X</span> = <span style="color:#000">select_columns</span>(<span style="color:#000">df_merged</span>,<span style="color:#000">target_removed</span>=<span style="color:#000">True</span>).<span style="color:#000">reset_index</span>()
    <span style="color:#000">df_X</span>.<span style="color:#000">rename</span>({<span style="color:#5a2">&#39;index&#39;</span>:<span style="color:#5a2">&#39;time_proxy&#39;</span>},<span style="color:#000">axis</span>=<span style="color:#3af">1</span>,<span style="color:#000">inplace</span>=<span style="color:#000">True</span>)
    <span style="color:#000">df_y</span> = <span style="color:#000">df_merged</span>[[<span style="color:#5a2">&#39;msno&#39;</span>,<span style="color:#5a2">&#39;target&#39;</span>]]
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;load_dataset: df_X,df_y created&#39;</span>)
    
    <span style="color:#00f">return</span> <span style="color:#000">df_X</span>, <span style="color:#000">df_y</span></code></pre></div>
<h4 id="4-1-checking-distribution-of-the-target">4.1. Checking distribution of the target</h4>

<p>Checking the target distribution guides us whether class-imbalance measures are required. In this case the classes are balanced almost spot-on evenly.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">y_train</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">own_read_pickle</span>(<span style="color:#5a2">&#39;y_train.pkl&#39;</span>))
<span style="color:#000">target_pcts</span> = <span style="color:#000">df_y</span>[<span style="color:#5a2">&#39;target&#39;</span>].<span style="color:#000">value_counts</span>(<span style="color:#000">normalize</span>=<span style="color:#000">True</span>) 
<span style="color:#00f">print</span>(<span style="color:#000">target_pcts</span>)
<span style="color:#000">target_pcts</span>.<span style="color:#000">plot</span>(<span style="color:#000">kind</span>=<span style="color:#5a2">&#39;bar&#39;</span>)</code></pre></div>
<p><img src="/Post_images/20181212_Music_recommendation/Graph_images/target_distr.png" alt="target_distribution" /></p>

<h4 id="4-2-decide-which-scoring-metric-to-optimize-on">4.2. Decide which scoring metric to optimize on</h4>

<ul>
<li>target metrics have no imbalance</li>
<li>it is not crucial to catch all &lsquo;positive&rsquo; cases, nor are we interested in negative cases</li>
<li>key is high <strong>precision</strong>, i.e. out of all music recommendations we want the highest number actual interesting ones, and rather recommend less but more precisely</li>
<li>however fully leaving recall out, would be biased</li>
<li>score of choice: <strong>FBeta</strong> (beta = <sup>1</sup>&frasl;<sub>3</sub>, i.e. giving more weight to precision)</li>
</ul>

<h4 id="4-3-split-into-train-test-validation-taking-user-based-split">4.3. Split into train-test-validation taking user-based split</h4>

<p>Train-test-validation split is key to tune and evaluate model performance. In our case the data is already naturally split by users (listening to overlapping songs), and keeping each user in only one of the splits seems like a logical choice. I had the guiding thought that I want to learn from the behaviour of one user and apply it to another.</p>

<p><em>Side-note: Another potential split would be based on time, i.e. I am learning from any user&rsquo;s past behaviour to predict the future. However in our case the data does not have an explicit time dimension, as the re-listening targets given already give sneak peak into the future.</em></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">get_user_split_data</span>(<span style="color:#000">df</span>, <span style="color:#000">chunksize</span> = <span style="color:#3af">100000</span>):
    
    <span style="color:#888;font-style:italic"># list of unique users</span>
    <span style="color:#000">all_users</span> = <span style="color:#000">df</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">unique</span>()
    <span style="color:#000">number_of_users</span> = <span style="color:#000">all_users</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]
    <span style="color:#000">len_df</span> = <span style="color:#000">df</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>]
    <span style="color:#000">chunknumbers</span> = <span style="color:#000">ceil</span>(<span style="color:#000">len_df</span> / <span style="color:#000">chunksize</span>)
    <span style="color:#000">userchunks</span> = <span style="color:#000">ceil</span>(<span style="color:#000">number_of_users</span>/<span style="color:#000">chunknumbers</span>)
    
    <span style="color:#000">df_chunks</span>=[]
    <span style="color:#00f">for</span> <span style="color:#000">i</span> <span style="color:#00f">in</span> <span style="color:#000">range</span>(<span style="color:#3af">1</span>,<span style="color:#000">chunknumbers</span>+<span style="color:#3af">1</span>):
        <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Creating chunks {i} of {chunknumbers}&#39;</span>)
        <span style="color:#000">users_in_chunk</span> = <span style="color:#000">all_users</span>[(<span style="color:#000">i</span>-<span style="color:#3af">1</span>)*<span style="color:#000">userchunks</span>:<span style="color:#000">i</span>*<span style="color:#000">userchunks</span>]
        <span style="color:#000">df_chunks</span>.<span style="color:#000">append</span>(<span style="color:#000">df</span>[<span style="color:#000">df</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">isin</span>(<span style="color:#000">users_in_chunk</span>)])
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;All chunks created&#39;</span>)
    <span style="color:#00f">return</span> <span style="color:#000">df_chunks</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">get_user_split_data_train_test</span>(<span style="color:#000">df_X</span>, <span style="color:#000">df_y</span>, <span style="color:#000">test_size</span>=.<span style="color:#3af">2</span>, <span style="color:#000">seed</span>=<span style="color:#3af">42</span>):

    <span style="color:#000">rs</span> = <span style="color:#000">np</span>.<span style="color:#000">random</span>.<span style="color:#000">RandomState</span>(<span style="color:#000">seed</span>)
    
    <span style="color:#000">total_users</span> = <span style="color:#000">df_X</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">unique</span>() 
    <span style="color:#000">test_users</span> = <span style="color:#000">rs</span>.<span style="color:#000">choice</span>(<span style="color:#000">total_users</span>, 
                           <span style="color:#000">size</span>=<span style="color:#000">int</span>(<span style="color:#000">total_users</span>.<span style="color:#000">shape</span>[<span style="color:#3af">0</span>] * <span style="color:#000">test_size</span>), 
                           <span style="color:#000">replace</span>=<span style="color:#000">False</span>)

    <span style="color:#000">X_tr</span> = <span style="color:#000">df_X</span>[~<span style="color:#000">df_X</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">isin</span>(<span style="color:#000">test_users</span>)]
    <span style="color:#000">X_te</span> = <span style="color:#000">df_X</span>[<span style="color:#000">df_X</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">isin</span>(<span style="color:#000">test_users</span>)]
    
    <span style="color:#000">y_tr</span> = <span style="color:#000">df_y</span>[~<span style="color:#000">df_y</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">isin</span>(<span style="color:#000">test_users</span>)]
    <span style="color:#000">y_te</span> = <span style="color:#000">df_y</span>[<span style="color:#000">df_y</span>[<span style="color:#5a2">&#39;msno&#39;</span>].<span style="color:#000">isin</span>(<span style="color:#000">test_users</span>)]

    <span style="color:#00f">return</span> <span style="color:#000">X_tr</span>, <span style="color:#000">X_te</span>, <span style="color:#000">y_tr</span>, <span style="color:#000">y_te</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">split_data</span>(<span style="color:#000">df_X</span>,<span style="color:#000">df_y</span>):
    <span style="color:#888;font-style:italic"># 20% for testing and 20% for validation</span>
    <span style="color:#888;font-style:italic"># Getting: X_train, y_train + X_val, y_val + X_test, y_test</span>
    <span style="color:#000">X_train_val</span>, <span style="color:#000">X_test</span>, <span style="color:#000">y_train_val</span>, <span style="color:#000">y_test</span> = <span style="color:#000">get_user_split_data_train_test</span>(<span style="color:#000">df_X</span>,<span style="color:#000">df_y</span>,<span style="color:#000">test_size</span>=<span style="color:#3af">0.2</span>)
    <span style="color:#000">X_train</span>, <span style="color:#000">X_val</span>, <span style="color:#000">y_train</span>, <span style="color:#000">y_val</span> = <span style="color:#000">get_user_split_data_train_test</span>(<span style="color:#000">X_train_val</span>,<span style="color:#000">y_train_val</span>,<span style="color:#000">test_size</span>=<span style="color:#3af">0.25</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;split_data: train_test split on a user base finished&#39;</span>)

    <span style="color:#888;font-style:italic"># Dropping msno columns, which was kept for user-based splitting</span>
    <span style="color:#000">X_train</span> = <span style="color:#000">X_train</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">y_train</span> = <span style="color:#000">y_train</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">X_val</span> = <span style="color:#000">X_val</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">y_val</span> = <span style="color:#000">y_val</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">X_test</span> = <span style="color:#000">X_test</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)
    <span style="color:#000">y_test</span> = <span style="color:#000">y_test</span>.<span style="color:#000">drop</span>([<span style="color:#5a2">&#39;msno&#39;</span>],<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)

    <span style="color:#000">y_train</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">y_train</span>).<span style="color:#000">reshape</span>(<span style="color:#000">y_train</span>.<span style="color:#000">size</span>,)
    <span style="color:#000">y_val</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">y_val</span>).<span style="color:#000">reshape</span>(<span style="color:#000">y_val</span>.<span style="color:#000">size</span>,)
    <span style="color:#000">y_test</span> = <span style="color:#000">np</span>.<span style="color:#000">array</span>(<span style="color:#000">y_test</span>).<span style="color:#000">reshape</span>(<span style="color:#000">y_test</span>.<span style="color:#000">size</span>,)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;split_data: msno dropped, y-s reshaped&#39;</span>)
    
    <span style="color:#00f">del</span> <span style="color:#000">df_X</span>, <span style="color:#000">df_y</span>, <span style="color:#000">X_train_val</span>, <span style="color:#000">y_train_val</span>
    
    <span style="color:#00f">return</span> <span style="color:#000">X_train</span>, <span style="color:#000">y_train</span>, <span style="color:#000">X_val</span>, <span style="color:#000">y_val</span>, <span style="color:#000">X_test</span>, <span style="color:#000">y_test</span></code></pre></div>
<h4 id="4-4-preparing-a-baseline-model">4.4. Preparing a baseline model</h4>

<p>Building a baseline model is helpful to have a benchmark for later models. In the baseline model I am only using a few seemingly important features to understand how much of the target&rsquo;s variance is explained when still keeping things simple.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">sklearn.linear_model</span> <span style="color:#00f">import</span> <span style="color:#000">LogisticRegression</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.metrics</span> <span style="color:#00f">import</span> <span style="color:#000">fbeta_score</span>, <span style="color:#000">confusion_matrix</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.preprocessing</span> <span style="color:#00f">import</span> <span style="color:#000">StandardScaler</span>

<span style="color:#000">X_train_small</span> = <span style="color:#000">X_train</span>[[<span style="color:#5a2">&#39;user_activity&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>,<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>,<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>]].<span style="color:#000">astype</span>(<span style="color:#000">float</span>)
<span style="color:#000">X_val_small</span> = <span style="color:#000">X_val</span>[[<span style="color:#5a2">&#39;user_activity&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>,<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>,<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>]].<span style="color:#000">astype</span>(<span style="color:#000">float</span>)

<span style="color:#888;font-style:italic"># Scale X_train to same scale</span>
<span style="color:#000">std_scale</span> = <span style="color:#000">StandardScaler</span>()
<span style="color:#000">X_train_scaled</span> = <span style="color:#000">std_scale</span>.<span style="color:#000">fit_transform</span>(<span style="color:#000">X_train_small</span>)
<span style="color:#000">X_val_scaled</span> = <span style="color:#000">std_scale</span>.<span style="color:#000">fit_transform</span>(<span style="color:#000">X_val_small</span>)

<span style="color:#888;font-style:italic"># Apply logistic regression</span>
<span style="color:#000">lr</span> = <span style="color:#000">LogisticRegression</span>(<span style="color:#000">solver</span>=<span style="color:#5a2">&#39;lbfgs&#39;</span>)
<span style="color:#000">lr</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train_scaled</span>, <span style="color:#000">y_train</span>)

<span style="color:#000">score_model</span>(<span style="color:#000">lr</span>, <span style="color:#000">X_val_scaled</span>, <span style="color:#000">y_val</span>)</code></pre></div>
<pre><code>FBeta(b=0.3) score is: 0.8145705294249105
Accuracy: 0.5380899961808909
Recall: 0.8510212418300653
Precision: 0.5519114101782923
Specificity: 0.1556931063744821
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Predict (0=no relisten)</th>
      <th>Predict (1=relisten)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Actual (0=no relisten)</th>
      <td>3119</td>
      <td>16914</td>
    </tr>
    <tr>
      <th>Actual (1=relisten)</th>
      <td>3647</td>
      <td>20833</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="4-5-check-pairplots-if-linear-separation-is-possible">4.5. Check pairplots if linear separation is possible</h4>

<p>Pairplots show the relationships between all features and between each feature and the target. This latter is what we are interested in, specifically looking for separations of the target along the axis of the feature</p>

<p><em>Note: it is the bottom row of the pairplot in my case, and the linear separation by each features individual contribution is relatively low, i.e. there is no very clear groups being formed along the different values on the features x-axis</em></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">sns</span>.<span style="color:#000">pairplot</span>((<span style="color:#000">select_columns</span>
              (<span style="color:#000">df_sample</span>,<span style="color:#000">target_removed</span>=<span style="color:#000">False</span>)
              [[<span style="color:#5a2">&#39;user_activity&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>,<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>,<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>,<span style="color:#5a2">&#39;target&#39;</span>]]), 
             <span style="color:#000">hue</span>=<span style="color:#5a2">&#39;target&#39;</span>)</code></pre></div>
<p><img src="/Post_images/20181212_Music_recommendation/Graph_images/pairplot.png" alt="pairplot" /></p>

<h4 id="4-6-tree-based-models">4.6. Tree-based models</h4>

<p>Switching to tree-based methods given low (accuracy) scores in logistic regression, clear bias towards positive predictions, and low visible separatability inferrable from the pairplots.</p>

<h5 id="random-forest-classifier">Random-forest classifier</h5>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">from</span> <span style="color:#000">sklearn.metrics</span> <span style="color:#00f">import</span> <span style="color:#000">fbeta_score</span>, <span style="color:#000">confusion_matrix</span>
<span style="color:#00f">from</span> <span style="color:#000">sklearn.ensemble</span> <span style="color:#00f">import</span> <span style="color:#000">RandomForestClassifier</span>
<span style="color:#00f">import</span> <span style="color:#000">xgboost</span> <span style="color:#00f">as</span> <span style="color:#000">xgb</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Select dataframes</span>

<span style="color:#000">X_train_small</span> = <span style="color:#000">X_train</span>[[<span style="color:#5a2">&#39;user_activity&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>,<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>,<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>]].<span style="color:#000">astype</span>(<span style="color:#000">float</span>)
<span style="color:#000">X_val_small</span> = <span style="color:#000">X_val</span>[[<span style="color:#5a2">&#39;user_activity&#39;</span>,<span style="color:#5a2">&#39;artist_freq&#39;</span>,<span style="color:#5a2">&#39;number_of_genres_listened&#39;</span>,<span style="color:#5a2">&#39;n_th_time_this_genre&#39;</span>]].<span style="color:#000">astype</span>(<span style="color:#000">float</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Random forest for baseline</span>

<span style="color:#000">rf</span> = <span style="color:#000">RandomForestClassifier</span>(<span style="color:#000">n_estimators</span> = <span style="color:#3af">1000</span>, <span style="color:#000">max_features</span> = <span style="color:#3af">3</span>, <span style="color:#000">min_samples_leaf</span> = <span style="color:#3af">4</span>, <span style="color:#000">n_jobs</span>=-<span style="color:#3af">1</span>)
<span style="color:#000">rf</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train_small</span>,<span style="color:#000">y_train</span>)</code></pre></div>
<pre><code>RandomForestClassifier(bootstrap=True, class_weight=None, criterion='gini',
            max_depth=None, max_features=3, max_leaf_nodes=None,
            min_impurity_decrease=0.0, min_impurity_split=None,
            min_samples_leaf=4, min_samples_split=2,
            min_weight_fraction_leaf=0.0, n_estimators=1000, n_jobs=-1,
            oob_score=False, random_state=None, verbose=0,
            warm_start=False)
</code></pre>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Random forest scoring</span>
<span style="color:#000">score_model</span>(<span style="color:#000">rf</span>, <span style="color:#000">X_val_small</span>, <span style="color:#000">y_val</span>)</code></pre></div>
<pre><code>FBeta(b=0.3) score is: 0.797741149918771
Accuracy: 0.5452789072855121
Recall: 0.8297794117647059
Precision: 0.5582488251298541
Specificity: 0.19762392053112365
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Predict (0=no relisten)</th>
      <th>Predict (1=relisten)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Actual (0=no relisten)</th>
      <td>3959</td>
      <td>16074</td>
    </tr>
    <tr>
      <th>Actual (1=relisten)</th>
      <td>4167</td>
      <td>20313</td>
    </tr>
  </tbody>
</table>
</div>

<h5 id="xg-boost-classifier">XG Boost classifier</h5>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888;font-style:italic"># Gradient boosting</span>

<span style="color:#000">gbm</span> = <span style="color:#000">xgb</span>.<span style="color:#000">XGBClassifier</span>( 
                        <span style="color:#000">n_estimators</span>=<span style="color:#3af">30000</span>,
                        <span style="color:#000">max_depth</span>=<span style="color:#3af">4</span>,
                        <span style="color:#000">objective</span>=<span style="color:#5a2">&#39;binary:logistic&#39;</span>, <span style="color:#888;font-style:italic">#new objective</span>
                        <span style="color:#000">learning_rate</span>=.<span style="color:#3af">005</span>, 
                        <span style="color:#000">subsample</span>=.<span style="color:#3af">8</span>,
                        <span style="color:#000">min_child_weight</span>=<span style="color:#3af">3</span>,
                        <span style="color:#000">colsample_bytree</span>=.<span style="color:#3af">8</span>,
                        <span style="color:#000">n_jobs</span>=-<span style="color:#3af">1</span>
                       )

<span style="color:#000">eval_set</span>=[(<span style="color:#000">X_train_small</span>,<span style="color:#000">y_train</span>),(<span style="color:#000">X_val_small</span>,<span style="color:#000">y_val</span>)]
<span style="color:#000">fit_model</span> = <span style="color:#000">gbm</span>.<span style="color:#000">fit</span>( 
                    <span style="color:#000">X_train_small</span>, <span style="color:#000">y_train</span>, 
                    <span style="color:#000">eval_set</span>=<span style="color:#000">eval_set</span>,
                    <span style="color:#000">eval_metric</span>=<span style="color:#5a2">&#39;error&#39;</span>, <span style="color:#888;font-style:italic">#new evaluation metric: classification error (could also use AUC, e.g.)</span>
                    <span style="color:#000">early_stopping_rounds</span>=<span style="color:#3af">50</span>,
                    <span style="color:#000">verbose</span>=<span style="color:#000">False</span>
                   )

<span style="color:#000">score_model</span>(<span style="color:#000">gbm</span>, <span style="color:#000">X_val_small</span>, <span style="color:#000">y_val</span>)</code></pre></div>
<pre><code>FBeta(b=0.3) score is: 0.9040621810095893
Accuracy: 0.554849145193539
Recall: 0.9582516339869281
Precision: 0.5552057939457055
Specificity: 0.061897868516947036
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Predict (0=no relisten)</th>
      <th>Predict (1=relisten)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Actual (0=no relisten)</th>
      <td>1240</td>
      <td>18793</td>
    </tr>
    <tr>
      <th>Actual (1=relisten)</th>
      <td>1022</td>
      <td>23458</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="4-7-extending-the-model">4.7. Extending the model</h4>

<p>As the above results still can take improvements, below I am using an automatic feature selection mechanism and tweaking the hyperparameters of XG Boost (using trial-and-errors)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">tree_modelrun</span>(<span style="color:#000">X_train</span>,<span style="color:#000">y_train</span>,<span style="color:#000">X_val</span>,<span style="color:#000">y_val</span>, <span style="color:#000">xgb</span>, <span style="color:#000">select_thresh</span>=<span style="color:#3af">0</span>,<span style="color:#000">select_model</span>=<span style="color:#000">None</span>):
    
    <span style="color:#00f">if</span> <span style="color:#000">xgb</span>:
        
        <span style="color:#00f">if</span> <span style="color:#000">select_thresh</span>&gt;<span style="color:#3af">0</span>:
            <span style="color:#00f">from</span> <span style="color:#000">sklearn.feature_selection</span> <span style="color:#00f">import</span> <span style="color:#000">SelectFromModel</span>
            <span style="color:#000">selection</span> = <span style="color:#000">SelectFromModel</span>(<span style="color:#000">select_model</span>, <span style="color:#000">threshold</span>=<span style="color:#000">select_thresh</span>, <span style="color:#000">prefit</span>=<span style="color:#000">True</span>)
            <span style="color:#000">X_train</span> = <span style="color:#000">selection</span>.<span style="color:#000">transform</span>(<span style="color:#000">X_train</span>)
            <span style="color:#000">X_val</span> = <span style="color:#000">selection</span>.<span style="color:#000">transform</span>(<span style="color:#000">X_val</span>)
        
        <span style="color:#888;font-style:italic"># Gradient boosting</span>

        <span style="color:#000">model</span> = <span style="color:#000">xgb</span>.<span style="color:#000">XGBClassifier</span>( 
                                <span style="color:#000">n_estimators</span>=<span style="color:#3af">30000</span>,
                                <span style="color:#000">max_depth</span>=<span style="color:#3af">12</span>,
                                <span style="color:#000">objective</span>=<span style="color:#5a2">&#39;binary:logistic&#39;</span>, <span style="color:#888;font-style:italic">#new objective</span>
                                <span style="color:#000">learning_rate</span>=.<span style="color:#3af">01</span>, 
                                <span style="color:#000">subsample</span>=.<span style="color:#3af">8</span>,
                                <span style="color:#000">min_child_weight</span>=<span style="color:#3af">4</span>,
                                <span style="color:#000">colsample_bytree</span>=.<span style="color:#3af">2</span>,
                                <span style="color:#000">n_jobs</span>=-<span style="color:#3af">1</span>
                               )

        <span style="color:#000">eval_set</span>=[(<span style="color:#000">X_train</span>,<span style="color:#000">y_train</span>),(<span style="color:#000">X_val</span>,<span style="color:#000">y_val</span>)]
        <span style="color:#000">fit_model</span> = <span style="color:#000">model</span>.<span style="color:#000">fit</span>( 
                            <span style="color:#000">X_train</span>, <span style="color:#000">y_train</span>, 
                            <span style="color:#000">eval_set</span>=<span style="color:#000">eval_set</span>,
                            <span style="color:#000">eval_metric</span>=<span style="color:#5a2">&#39;error&#39;</span>, <span style="color:#888;font-style:italic">#new evaluation metric: classification error (could also use AUC, e.g.)</span>
                            <span style="color:#000">early_stopping_rounds</span>=<span style="color:#3af">50</span>,
                            <span style="color:#000">verbose</span>=<span style="color:#000">True</span>
                           )
    <span style="color:#00f">else</span>:
        <span style="color:#888;font-style:italic"># Random forest for baseline</span>

        <span style="color:#000">model</span> = <span style="color:#000">RandomForestClassifier</span>(<span style="color:#000">n_estimators</span> = <span style="color:#3af">1000</span>, <span style="color:#000">n_jobs</span>=-<span style="color:#3af">1</span>)
        <span style="color:#000">model</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train</span>,<span style="color:#000">y_train</span>)

    <span style="color:#00f">print</span>(<span style="color:#000">score_model</span>(<span style="color:#000">model</span>, <span style="color:#000">X_val</span>, <span style="color:#000">y_val</span>))
    
    <span style="color:#00f">return</span> <span style="color:#000">model</span></code></pre></div>
<h4 id="4-8-plotting-feature-importance-from-xg-boost">4.8. Plotting feature importance from XG Boost</h4>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">param_importance</span>(<span style="color:#000">gbm</span>,<span style="color:#000">num</span>):
    <span style="color:#000">gain</span> = <span style="color:#000">gbm</span>.<span style="color:#000">get_booster</span>().<span style="color:#000">get_score</span>(<span style="color:#000">importance_type</span>=<span style="color:#5a2">&#39;gain&#39;</span>)
    <span style="color:#00f">return</span> <span style="color:#000">xgb</span>.<span style="color:#000">plot_importance</span>(<span style="color:#000">gbm</span>,<span style="color:#000">max_num_features</span>=<span style="color:#000">num</span>), <span style="color:#000">xgb</span>.<span style="color:#000">plot_importance</span>(<span style="color:#000">gbm</span>, <span style="color:#000">importance_type</span>=<span style="color:#5a2">&#39;gain&#39;</span>,<span style="color:#000">max_num_features</span>=<span style="color:#000">num</span>), <span style="color:#000">gain</span></code></pre></div>
<p><img src="/Post_images/20181212_Music_recommendation/Graph_images/feature_imp_splits.png" alt="splits" />
<img src="/Post_images/20181212_Music_recommendation/Graph_images/feature_imp_gain.png" alt="splits" /></p>

<h2 id="5-main-pulling-things-together">5. &ndash; MAIN &ndash; Pulling things together</h2>

<p><img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide10.png" alt="png" /></p>

<p><img src="/Post_images/20181212_Music_recommendation/Slide_images/Slide12.png" alt="png" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">feature_engineering</span>():
    <span style="color:#000">start</span> = <span style="color:#000">time</span>.<span style="color:#000">time</span>()
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;starting&#39;</span>,<span style="color:#000">start</span>)

    <span style="color:#000">df_train</span>, <span style="color:#000">df_members</span>, <span style="color:#000">df_full_songs</span> = <span style="color:#000">read_in_data</span>(<span style="color:#000">sample</span>=<span style="color:#000">True</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Data loaded. Elapsed:&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#000">df_merged</span> = <span style="color:#000">merge_databases</span>(<span style="color:#000">df_train</span>, <span style="color:#000">df_members</span>, <span style="color:#000">df_full_songs</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;df_merged created&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">df_merged</span>.<span style="color:#000">to_pickle</span>(<span style="color:#5a2">&#39;df_merged_premod.pkl&#39;</span>,<span style="color:#000">protocol</span>=<span style="color:#3af">3</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;df_merged premod pickled&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#00f">del</span> <span style="color:#000">df_train</span>, <span style="color:#000">df_members</span>, <span style="color:#000">df_full_songs</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;individual dfs deleted&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#000">df_merged</span> = <span style="color:#000">full_songs_engineering</span>(<span style="color:#000">members_engineering</span>(<span style="color:#000">train_engineering</span>(<span style="color:#000">df_merged</span>)))

    <span style="color:#000">dfs</span>=[]
    <span style="color:#000">all_chunks</span> = <span style="color:#000">get_user_split_data</span>(<span style="color:#000">df_merged</span>,<span style="color:#3af">100000</span>)
    <span style="color:#000">number_of_chunks</span> = <span style="color:#000">len</span>(<span style="color:#000">all_chunks</span>)

    <span style="color:#00f">for</span> <span style="color:#000">i</span>, <span style="color:#000">df_chunk</span> <span style="color:#00f">in</span> <span style="color:#000">enumerate</span>(<span style="color:#000">all_chunks</span>):
        <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;initiating chunk number {i} of {number_of_chunks}&#39;</span>)
        <span style="color:#000">dfs</span>.<span style="color:#000">append</span>(<span style="color:#000">merged_engineering</span>(<span style="color:#000">df_chunk</span>))
        <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;finished chunk number {i} of {number_of_chunks} in&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#5a2">&#39;merged_engineered_list_preconcat.pkl&#39;</span>, <span style="color:#5a2">&#39;wb&#39;</span>) <span style="color:#00f">as</span> <span style="color:#000">handle</span>:
        <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">dfs</span>, <span style="color:#000">handle</span>, <span style="color:#000">protocol</span>=<span style="color:#000">pkl</span>.<span style="color:#000">HIGHEST_PROTOCOL</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;list pkl saved&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)    

    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;concat starting at&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">df_merged_postmod</span> = <span style="color:#000">pd</span>.<span style="color:#000">concat</span>(<span style="color:#000">dfs</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;concat finished at&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;pickle starting at&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">df_merged_postmod</span>.<span style="color:#000">to_pickle</span>(<span style="color:#5a2">&#39;df_merged_final_postmod.pkl&#39;</span>,<span style="color:#000">protocol</span>=<span style="color:#3af">3</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;pickle finished at&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)

    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Script finished in&#39;</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">model_creation</span>():
    <span style="color:#000">start</span> = <span style="color:#000">time</span>.<span style="color:#000">time</span>()
    <span style="color:#000">start_format</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;model_creation() started {start_format}&#39;</span>)
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; load_dataset initializing &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">df_X</span>, <span style="color:#000">df_y</span> = <span style="color:#000">load_dataset</span>(<span style="color:#5a2">&#39;df_merged_final_postmod_aws.pkl&#39;</span>, <span style="color:#000">sample</span>=<span style="color:#000">False</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; load_dataset finished &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; split_data initializing &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">X_train</span>, <span style="color:#000">y_train</span>, <span style="color:#000">X_val</span>, <span style="color:#000">y_val</span>, <span style="color:#000">X_test</span>, <span style="color:#000">y_test</span> = <span style="color:#000">split_data</span>(<span style="color:#000">df_X</span>,<span style="color:#000">df_y</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; split_data finished &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#00f">del</span> <span style="color:#000">df_X</span>, <span style="color:#000">df_y</span>
    
    <span style="color:#000">X_train</span> = <span style="color:#000">X_train</span>.<span style="color:#000">astype</span>(<span style="color:#000">float</span>)
    <span style="color:#000">X_val</span> = <span style="color:#000">X_val</span>.<span style="color:#000">astype</span>(<span style="color:#000">float</span>)
    <span style="color:#000">X_test</span> = <span style="color:#000">X_test</span>.<span style="color:#000">astype</span>(<span style="color:#000">float</span>)
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; xgboost_modelrun initializing &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">gbm2</span> = <span style="color:#000">xgboost_modelrun</span>(<span style="color:#000">X_train</span>,<span style="color:#000">y_train</span>,<span style="color:#000">X_val</span>,<span style="color:#000">y_val</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; xgboost_modelrun finished &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    
    <span style="color:#888;font-style:italic"># save the model to disk</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; pickle initializing &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#000">filename</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>) + <span style="color:#5a2">&#39;_xgb_aws_model.sav&#39;</span>
    <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">gbm2</span>, <span style="color:#000">open</span>(<span style="color:#000">filename</span>, <span style="color:#5a2">&#39;wb&#39;</span>))
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; pickle finished &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>)
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">25</span>,<span style="color:#5a2">&#39; model_creation() finished &#39;</span>,<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">10</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> <span style="color:#000">final_scoring</span>():
    <span style="color:#000">start</span> = <span style="color:#000">time</span>.<span style="color:#000">time</span>()
    <span style="color:#000">start_format</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;model_creation() started {start_format}&#39;</span>)
    
    <span style="color:#000">X_test</span> = <span style="color:#000">own_read_pickle</span>(<span style="color:#5a2">&#39;X_test.pkl&#39;</span>)
    <span style="color:#000">y_test</span> = <span style="color:#000">own_read_pickle</span>(<span style="color:#5a2">&#39;y_test.pkl&#39;</span>)
    
    <span style="color:#000">y_test</span> = <span style="color:#000">y_test</span>[~<span style="color:#000">X_test</span>.<span style="color:#000">isnull</span>().<span style="color:#000">any</span>(<span style="color:#000">axis</span>=<span style="color:#3af">1</span>)]
    <span style="color:#000">X_test</span> = <span style="color:#000">X_test</span>.<span style="color:#000">dropna</span>()
    <span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#5a2">&#39;X_test_dropna.pkl&#39;</span>, <span style="color:#5a2">&#39;wb&#39;</span>) <span style="color:#00f">as</span> <span style="color:#000">handle</span>:
        <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">X_test</span>, <span style="color:#000">handle</span>, <span style="color:#000">protocol</span>=<span style="color:#000">pkl</span>.<span style="color:#000">HIGHEST_PROTOCOL</span>)
    <span style="color:#00f">with</span> <span style="color:#000">open</span>(<span style="color:#5a2">&#39;y_test_dropna.pkl&#39;</span>, <span style="color:#5a2">&#39;wb&#39;</span>) <span style="color:#00f">as</span> <span style="color:#000">handle</span>:
        <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">y_test</span>, <span style="color:#000">handle</span>, <span style="color:#000">protocol</span>=<span style="color:#000">pkl</span>.<span style="color:#000">HIGHEST_PROTOCOL</span>)
    
    <span style="color:#000">X_train</span> = <span style="color:#000">own_read_pickle</span>(<span style="color:#5a2">&#39;X_train_dropna.pkl&#39;</span>)
    <span style="color:#000">y_train</span> = <span style="color:#000">own_read_pickle</span>(<span style="color:#5a2">&#39;y_train_dropna.pkl&#39;</span>)

    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#888;font-style:italic">## 1. Logistic regression - baseline</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Logistic regression baseline&#39;</span>)
    <span style="color:#000">X_train_small</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">X_train</span>[<span style="color:#5a2">&#39;screen_id_CAT_my library+Local playlist more+local-playlist&#39;</span>])
    <span style="color:#000">X_test_small</span> = <span style="color:#000">pd</span>.<span style="color:#000">DataFrame</span>(<span style="color:#000">X_test</span>[<span style="color:#5a2">&#39;screen_id_CAT_my library+Local playlist more+local-playlist&#39;</span>])
    <span style="color:#000">lr</span> = <span style="color:#000">LogisticRegression</span>(<span style="color:#000">solver</span>=<span style="color:#5a2">&#39;lbfgs&#39;</span>)
    <span style="color:#000">lr</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train_small</span>, <span style="color:#000">y_train</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">score_model</span>(<span style="color:#000">lr</span>, <span style="color:#000">X_test_small</span>, <span style="color:#000">y_test</span>))
    <span style="color:#000">filename</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>) + <span style="color:#5a2">&#39;_logbaseline_aws_model.sav&#39;</span>
    <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">lr</span>, <span style="color:#000">open</span>(<span style="color:#000">filename</span>, <span style="color:#5a2">&#39;wb&#39;</span>))
    <span style="color:#00f">del</span> <span style="color:#000">lr</span>
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Saved as {filename}&#39;</span>)

<span style="color:#00f">def</span> <span style="color:#000">othermodels</span>():    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#888;font-style:italic">## 2. Logistic regression - extended</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Logistic regression extended&#39;</span>)
    <span style="color:#000">std_scale</span> = <span style="color:#000">StandardScaler</span>()
    <span style="color:#000">X_train_scaled</span> = <span style="color:#000">std_scale</span>.<span style="color:#000">fit_transform</span>(<span style="color:#000">X_train</span>)
    <span style="color:#000">X_test_scaled</span> = <span style="color:#000">std_scale</span>.<span style="color:#000">fit_transform</span>(<span style="color:#000">X_test</span>)
    <span style="color:#000">lr2</span> = <span style="color:#000">LogisticRegression</span>(<span style="color:#000">solver</span>=<span style="color:#5a2">&#39;lbfgs&#39;</span>)
    <span style="color:#000">lr2</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train_scaled</span>, <span style="color:#000">y_train</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">score_model</span>(<span style="color:#000">lr2</span>, <span style="color:#000">X_test_scaled</span>, <span style="color:#000">y_test</span>))
    <span style="color:#000">filename</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>) + <span style="color:#5a2">&#39;_logextended_aws_model.sav&#39;</span>
    <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">lr2</span>, <span style="color:#000">open</span>(<span style="color:#000">filename</span>, <span style="color:#5a2">&#39;wb&#39;</span>))
    <span style="color:#00f">del</span> <span style="color:#000">lr2</span>
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Saved as {filename}&#39;</span>)
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#888;font-style:italic">## 3. Random forest model</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;Random forest extended&#39;</span>)
    <span style="color:#000">rf</span> = <span style="color:#000">RandomForestClassifier</span>(<span style="color:#000">n_estimators</span> = <span style="color:#3af">1000</span>, <span style="color:#000">n_jobs</span>=-<span style="color:#3af">1</span>)
    <span style="color:#000">rf</span>.<span style="color:#000">fit</span>(<span style="color:#000">X_train</span>,<span style="color:#000">y_train</span>)
    <span style="color:#00f">print</span>(<span style="color:#000">score_model</span>(<span style="color:#000">rf</span>, <span style="color:#000">X_test</span>, <span style="color:#000">y_test</span>))
    <span style="color:#000">filename</span> = <span style="color:#000">time</span>.<span style="color:#000">strftime</span>(<span style="color:#5a2">&#34;%Y%m</span><span style="color:#5a2">%d</span><span style="color:#5a2">-%H%M%S&#34;</span>) + <span style="color:#5a2">&#39;_RF_aws_model.sav&#39;</span>
    <span style="color:#000">pkl</span>.<span style="color:#000">dump</span>(<span style="color:#000">rf</span>, <span style="color:#000">open</span>(<span style="color:#000">filename</span>, <span style="color:#5a2">&#39;wb&#39;</span>))
    <span style="color:#00f">del</span> <span style="color:#000">rf</span>
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Saved as {filename}&#39;</span>)
    
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;*&#39;</span>*<span style="color:#3af">50</span>,<span style="color:#000">round</span>((<span style="color:#000">time</span>.<span style="color:#000">time</span>() - <span style="color:#000">start</span>)/<span style="color:#3af">60</span>,<span style="color:#3af">1</span>),<span style="color:#5a2">&#39;minutes&#39;</span>)
    <span style="color:#888;font-style:italic">## 4. Final xgboost model</span>
    <span style="color:#00f">print</span>(<span style="color:#5a2">&#39;XGBoost final&#39;</span>)
    <span style="color:#000">xgb</span> = <span style="color:#000">pkl</span>.<span style="color:#000">load</span>(<span style="color:#000">open</span>(<span style="color:#5a2">&#34;20181029-155308_xgb_aws_model(full v4).sav&#34;</span>, <span style="color:#5a2">&#34;rb&#34;</span>))
    <span style="color:#00f">print</span>(<span style="color:#000">score_model</span>(<span style="color:#000">xgb</span>, <span style="color:#000">X_test</span>, <span style="color:#000">y_test</span>))
    <span style="color:#00f">print</span>(<span style="color:#000">f</span><span style="color:#5a2">&#39;Saved as 20181029-155308_xgb_aws_model(full v4).sav&#39;</span>)</code></pre></div>
  </section>
  <div class="clearfix">
    
      <div class="post-date pull-left">
        <span class="small">
          Posted on
          Dec 12, 2018 at 11:20
        </span>
      </div>
    
    <div class="pull-right">
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/music/">#Music</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/recommendation/">#Recommendation</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/logistic-regression/">#Logistic Regression</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/random-forest/">#Random Forest</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/xgboost/">#Xgboost</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/kaggle/">#Kaggle</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/deezer/">#Deezer</a></span>
        
      
        
          <span class="post-tag small"><a href="https://kriszsandor.github.io/tags/kkbox/">#Kkbox</a></span>
        
      
    </div>
  </div>
  <footer>
    
      
    
    
      
        <div class="delimiter"></div>
        <section class="author-info row">
          <div class="author-avatar col-md-2">
            
              <img alt="Author Avatar" src="/images/KS.jpg" />
            
          </div>
          <div class="author-meta col-md-10">
            
              <h2 class="author-name text-primary">Krisztian Sandor</h2>
            
            
              <div class="author-bio">I&#39;m Krisztian an economist and data scientist from Budapest, Hungary.</div>
            
            
              <a class="btn btn-primary author-contact" href="https://www.linkedin.com/in/krisztiansandor/">
                <div>
                  <i class="fa fa-envelope-o" aria-hidden="true"></i>
                  &nbsp;Contact me
                </div>
              </a>
            
          </div>
        </section>
      
    <div class="delimiter"></div>
    <div class="pager-container">
      
        <a class="btn btn-primary btn-older-posts" href="https://kriszsandor.github.io/posts/20181210_fletcher_blog/">
          <div>
            <span aria-hidden="true">&larr;</span> Older Posts
          </div>
        </a>
      
      
        <a class="btn btn-primary btn-newer-posts" href="https://kriszsandor.github.io/posts/20181213_apartment_price_regression/">
          <div>
            Newer Posts <span aria-hidden="true">&rarr;</span>
          </div>
        </a>
      
    </div>
  </footer>
</article>
<div class="delimiter"></div>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      &copy; Krisztian Sandor, Budapest, Hungary
    </div>
    <div class="sns-links hidden-print">
  
  
  
  
  
  
  
  
  
  
  
  
</div>

  </footer>

  
  
  
  
</body>
</html>

